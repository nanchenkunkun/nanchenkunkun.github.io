<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/nanchenkunkun.github.io/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/nanchenkunkun.github.io/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/nanchenkunkun.github.io/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/nanchenkunkun.github.io/images/logo.svg" color="#222">

<link rel="stylesheet" href="/nanchenkunkun.github.io/css/main.css">


<link rel="stylesheet" href="/nanchenkunkun.github.io/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"nanchenkunkun.github.io","root":"/nanchenkunkun.github.io/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="只有变光,才能变强">
<meta property="og:type" content="website">
<meta property="og:title" content="kkの博客">
<meta property="og:url" content="https://nanchenkunkun.github.io/index.html">
<meta property="og:site_name" content="kkの博客">
<meta property="og:description" content="只有变光,才能变强">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zkk">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://nanchenkunkun.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>kkの博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/nanchenkunkun.github.io/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">kkの博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">南城坤坤</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/nanchenkunkun.github.io/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/nanchenkunkun.github.io/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">6</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/nanchenkunkun.github.io/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">10</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/nanchenkunkun.github.io/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">35</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/24/%E4%B8%AD%E9%97%B4%E4%BB%B6/elasticsearch/elasticSearch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/24/%E4%B8%AD%E9%97%B4%E4%BB%B6/elasticsearch/elasticSearch/" class="post-title-link" itemprop="url">ElasticSearch学习文档</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-24 10:24:25 / 修改时间：10:28:32" itemprop="dateCreated datePublished" datetime="2020-09-24T10:24:25+08:00">2020-09-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/ElasticSearch/" itemprop="url" rel="index"><span itemprop="name">ElasticSearch</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1、ES-简介"><a href="#1、ES-简介" class="headerlink" title="1、ES 简介"></a>1、ES 简介</h2><h5 id="1）定义"><a href="#1）定义" class="headerlink" title="1）定义"></a>1）定义</h5><ol>
<li>ES是elaticsearch简写， Elasticsearch是一个<strong>开源的高扩展的分布式全文检索引擎</strong>，它可以<strong>近乎实时的存储</strong>、检索数据；本身扩展性很好，可以扩展到上百台服务器，<strong>处理PB级别的数据</strong>。 </li>
<li>Elasticsearch也使用Java开发并使用Lucene作为其核心来实现所有索引和搜索的功能，但是它的目的是通过简单的RESTful API来隐藏Lucene的复杂性，从而让全文搜索变得简单。</li>
</ol>
<h5 id="2）特点和优势"><a href="#2）特点和优势" class="headerlink" title="2）特点和优势"></a>2）特点和优势</h5><ol>
<li>分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。 </li>
<li><strong>近乎实时分析</strong>的分布式搜索引擎。 </li>
<li>分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作； </li>
<li>负载再平衡和路由在大多数情况下自动完成。 </li>
<li>可以扩展到上百台服务器，处理PB级别的结构化或非结构化数据（官网是这么说的）。也可以运行在单台PC上（已测试）。 </li>
<li>支持插件机制，分词插件、同步插件、Hadoop插件、可视化插件等。</li>
</ol>
<h5 id="3）Elasticsearch-在业界的应用案例"><a href="#3）Elasticsearch-在业界的应用案例" class="headerlink" title="3）Elasticsearch 在业界的应用案例"></a>3）Elasticsearch 在业界的应用案例</h5><p>​    国内现在有大量的公司都在使用 Elasticsearch，包括携程、滴滴、今日头条、饿了么、360安全、小米、vivo等诸多知名公司。</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1596675329800.png" alt="1596675329800"></p>
<p>除了搜索之外，结合Kibana、Logstash、Beats，Elastic Stack还被广泛运用在大数据近实时分析领域，包括**<em>日志分析、指标监控、信息安全**</em>等多个领域。它可以帮助你探索海量结构化、非结构化数据，按需创建可视化报表，对监控数据设置报警阈值，甚至通过使用机器学习技术，自动识别异常状况。</p>
<p>1.京东到家订单中心</p>
<p>​    京东到家订单中心系统业务中，无论是外部商家的订单生产，或是内部上下游系统的依赖，订单查询的调用量都非常大，造成了订单数据读多写少的情况。京东到家的订单数据存储在MySQL中，但显然只通过DB来支撑大量的查询是不可取的，同时对于一些复杂的查询，Mysql支持得不够友好，所以订单中心系统使用了Elasticsearch来承载订单查询的主要压力。</p>
<p>2.携程Elasticsearch应用</p>
<p>日志单集群有120个data node，运行于70台物理服务器上。数据规模如下:</p>
<ul>
<li>单日索引数据条数600亿，新增索引文件25TB (含一个复制片则为50TB)</li>
<li>业务高峰期峰值索引速率维持在百万条/秒</li>
<li>历史数据保留时长根据业务需求制定，从10天 - 90天不等</li>
<li>集群共3441个索引、17000个分片、数据总量约9300亿, 磁盘总消耗1PB</li>
</ul>
<p>3.去哪儿：订单中心基于elasticsearch 的应用</p>
<p>​    15年去哪儿网酒店日均订单量达到30w+，随着多平台订单的聚合日均订单能达到100w左右。原来采用的热表分库方式，即将最近6个月的订单的放置在一张表中，将历史订单放在在history表中。history表存储全量的数据，当用户查询的下单时间跨度超过6个月即查询历史订单表，此分表方式热表的数据量为4000w左右，当时能解决的问题。但是显然不能满足携程艺龙订单接入的需求。如果继续按照热表方式，数据量将超过1亿条。全量数据表保存2年的可能就超过4亿的数据量。所以寻找有效途径解决此问题迫在眉睫。由于对这预计4亿的数据量还需按照预定日期、入住日期、离店日期、订单号、联系人姓名、电话、酒店名称、订单状态……等多个条件查询。所以简单按照某一个维度进行分表操作没有意义。Elasticsearch分布式搜索储存集群的引入，就是为了解决订单数据的存储与搜索的问题。</p>
<p>对订单模型进行抽象和分类，将常用搜索字段和基础属性字段剥离。DB做分库分表，存储订单详情；Elasticsearch存储搜索字段。</p>
<p>订单复杂查询直接走Elasticsearch，基于OrderNo的简单查询走DB。</p>
<h2 id="2、ES-基本概念"><a href="#2、ES-基本概念" class="headerlink" title="2、ES 基本概念"></a>2、ES 基本概念</h2><h5 id="1）节点（Node）"><a href="#1）节点（Node）" class="headerlink" title="1）节点（Node）"></a>1）节点（Node）</h5><p>​        运行了<strong>单个实例的ES主机称为节点</strong>，它是集群的一个成员，可以存储数据、参与集群索引及搜索操作。节点通过为其配置的ES集群名称确定其所要加入的集群。</p>
<h5 id="2）集群（cluster）"><a href="#2）集群（cluster）" class="headerlink" title="2）集群（cluster）"></a>2）集群（cluster）</h5><p>​        ES可以作为一个独立的单个搜索服务器。不过，一般为了处理大型数据集，实现容错和高可用性，ES可以运行在许多互相合作的服务器上。这些服务器的集合称为集群。</p>
<h5 id="3）分片（Shard）"><a href="#3）分片（Shard）" class="headerlink" title="3）分片（Shard）"></a>3）分片（Shard）</h5><p>​        ES的“分片(shard)”机制可将一个索引内部的数据分布地存储于多个节点，它通过<strong>将一个索引切分为多个</strong>底层物理的Lucene索引完成<strong>索引数据的分割存储</strong>功能，这每一个物理的Lucene索引称为一个分片(shard)。</p>
<p>​        这样的好处是可以<strong>把一个大的索引拆分成多个，分布到不同的节点上</strong>。降低单服务器的压力，构成分布式搜索，<strong>提高整体检索的效率（分片数的最优值与硬件参数和数据量大小有关）。</strong>分片的数量<strong>只能在索引创建前指定，并且索引创建后不能更改。</strong></p>
<h5 id="4）副本（Replica）"><a href="#4）副本（Replica）" class="headerlink" title="4）副本（Replica）"></a>4）副本（Replica）</h5><p>​        副本是一个分片的<strong>精确复制</strong>，每个分片可以有零个或多个副本。副本的作用一是<strong>提高系统的容错性</strong>，当某个节点某个分片损坏或丢失时可以从副本中恢复。二是<strong>提高es的查询效率</strong>，es会自动对搜索请求进行负载均衡。</p>
<h2 id="3、ES的数据架构"><a href="#3、ES的数据架构" class="headerlink" title="3、ES的数据架构"></a>3、ES的数据架构</h2><h5 id="1）索引（index）"><a href="#1）索引（index）" class="headerlink" title="1）索引（index）"></a>1）索引（index）</h5><p>​        ES将数据存储于一个或多个索引中，索引是具有类似特性的文档的集合。类比传统的关系型数据库领域来说，<strong>索引相当于SQL中的一个数据库。</strong></p>
<h5 id="2）类型（Type）-（弃用）"><a href="#2）类型（Type）-（弃用）" class="headerlink" title="2）类型（Type） （弃用）"></a>2）类型（Type） （弃用）</h5><p>类型是索引内部的逻辑分区(category/partition)，然而其意义完全取决于用户需求。因此，一个索引内部可定义一个或多个类型(type)。一般来说，类型就是为那些拥有相同的域的文档做的预定义。类比传统的关系型数据库领域来说，<strong>类型相当于“表”</strong>。</p>
<p><strong>特别注意的是，</strong>根据官网信息：在Elasticsearch 6.0.0或更高版本中创建的索引<strong>只能包含一个映射类型</strong>。在5.x中创建的具有多种映射类型的索引将继续像在Elasticsearch 6.x中一样工作。<strong>类型将在Elasticsearch 7.0.0中的API中弃用，并在8.0.0中完全删除。</strong></p>
<h5 id="3）文档（Document）"><a href="#3）文档（Document）" class="headerlink" title="3）文档（Document）"></a>3）文档（Document）</h5><p>​        文档是Lucene索引和搜索的原子单位，它是包含了一个或多个域的容器，基于JSON格式进行表示。文档由一个或多个域组成，每个域拥有一个名字及一个或多个值，有多个值的域通常称为“多值域”。每个文档可以存储不同的域集，但同一类型下的文档至应该有某种程度上的相似之处。<strong>相当于mysql表中的row</strong>。</p>
<h5 id="4）映射（Mapping）"><a href="#4）映射（Mapping）" class="headerlink" title="4）映射（Mapping）"></a>4）映射（Mapping）</h5><p>​        映射是定义文档及其包含的字段如何存储和索引的过程。例如，使用映射来定义：</p>
<ul>
<li><ul>
<li>哪些字符串字段应该被视为全文字段。</li>
<li>哪些字段包含数字、日期或地理位置。</li>
<li>文档中所有字段的值是否应该被索引到catch-all _all字段中。</li>
<li>日期值的格式。</li>
<li>用于控制动态添加字段的映射的自定义规则。</li>
</ul>
</li>
</ul>
<p>​        <strong>每个索引都有一个映射类型，它决定了文档的索引方式。</strong></p>
<h5 id="5）与-mysql-的对比"><a href="#5）与-mysql-的对比" class="headerlink" title="5）与 mysql 的对比"></a>5）与 mysql 的对比</h5><h2 id=""><a href="#" class="headerlink" title=""></a><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1596675884813.png" alt="1596675884813"></h2><h2 id="4、索引的CURD"><a href="#4、索引的CURD" class="headerlink" title="4、索引的CURD"></a>4、索引的CURD</h2><h5 id="1）新增"><a href="#1）新增" class="headerlink" title="1）新增"></a>1）新增</h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT /tehero_index</span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">     <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">       <span class="attr">&quot;id&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;integer&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="attr">&quot;name&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span></span><br><span class="line">       &#125;,</span><br><span class="line">       <span class="attr">&quot;createAt&quot;</span>:&#123;</span><br><span class="line">         <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;date&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 返回值如下：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;acknowledged&quot;: true, # 是否在集群中成功创建了索引</span><br><span class="line">  &quot;shards_acknowledged&quot;: true,</span><br><span class="line">  &quot;index&quot;: &quot;tehero_index&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2）查询"><a href="#2）查询" class="headerlink" title="2）查询"></a><strong>2）查询</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;tehero_index  # 索引名</span><br><span class="line">#可以同时检索多个索引或所有索引</span><br><span class="line">如：GET &#x2F;*    GET &#x2F;tehero_index,other_index</span><br><span class="line"></span><br><span class="line">GET &#x2F;_cat&#x2F;indices?v  #查看所有 index</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tehero_index&quot;: &#123;</span><br><span class="line">    &quot;aliases&quot;: &#123;&#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;createAt&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">      &quot;index&quot;: &#123;</span><br><span class="line">        &quot;creation_date&quot;: &quot;1596677819989&quot;,</span><br><span class="line">        &quot;number_of_shards&quot;: &quot;5&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;uuid&quot;: &quot;EVsf6yYKRFqB2UQ6Qmx3Tw&quot;,</span><br><span class="line">        &quot;version&quot;: &#123;</span><br><span class="line">          &quot;created&quot;: &quot;6010199&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;provided_name&quot;: &quot;tehero_index&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="3）修改"><a href="#3）修改" class="headerlink" title="3）修改"></a><strong>3）修改</strong></h5><blockquote>
<p>ES提供了一系列对index修改的语句，包括**副本数量的修改、新增字段、refresh_interval值的修改、索引分词器的修改、别名的修改</p>
</blockquote>
<p>先学习常用的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 修改副本数</span><br><span class="line">PUT &#x2F;tehero_index&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">        &quot;number_of_replicas&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 修改分片刷新时间,默认为1s</span><br><span class="line">PUT &#x2F;tehero_index&#x2F;_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot; : &#123;</span><br><span class="line">        &quot;refresh_interval&quot; : &quot;2s&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 新增字段 age</span><br><span class="line">PUT &#x2F;tehero_index&#x2F;doc&#x2F;_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;age&quot;: &#123;</span><br><span class="line">      &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更新完后，我们再次查看索引配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;tehero_index</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;tehero_index&quot;: &#123;</span><br><span class="line">    &quot;aliases&quot;: &#123;&#125;,</span><br><span class="line">    &quot;mappings&quot;: &#123;</span><br><span class="line">      &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;properties&quot;: &#123;</span><br><span class="line">          &quot;age&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;createAt&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;date&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;id&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;integer&quot;</span><br><span class="line">          &#125;,</span><br><span class="line">          &quot;name&quot;: &#123;</span><br><span class="line">            &quot;type&quot;: &quot;text&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">      &quot;index&quot;: &#123;</span><br><span class="line">        &quot;refresh_interval&quot;: &quot;2s&quot;,</span><br><span class="line">        &quot;number_of_shards&quot;: &quot;5&quot;,</span><br><span class="line">        &quot;provided_name&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;creation_date&quot;: &quot;1596677819989&quot;,</span><br><span class="line">        &quot;number_of_replicas&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;uuid&quot;: &quot;EVsf6yYKRFqB2UQ6Qmx3Tw&quot;,</span><br><span class="line">        &quot;version&quot;: &#123;</span><br><span class="line">          &quot;created&quot;: &quot;6010199&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">已经修改成功</span><br></pre></td></tr></table></figure>

<h5 id="4）删除"><a href="#4）删除" class="headerlink" title="4）删除"></a><strong>4）删除</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 删除索引</span><br><span class="line">DELETE &#x2F;tehero_index</span><br><span class="line"># 验证索引是否存在</span><br><span class="line">HEAD tehero_index</span><br><span class="line">返回：404 - Not Found</span><br></pre></td></tr></table></figure>

<h2 id="5、文档的CURD"><a href="#5、文档的CURD" class="headerlink" title="5、文档的CURD"></a>5、文档的CURD</h2><h5 id="1）新增-1"><a href="#1）新增-1" class="headerlink" title="1）新增"></a><strong>1）新增</strong></h5><p>新增单条数据，并指定es的id 为 1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">PUT &#x2F;tehero_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Te Hero&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 2,</span><br><span class="line">  &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot;: 1,</span><br><span class="line">  &quot;_primary_term&quot;: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>新增单条数据，使用ES自动生成id</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">POST /tehero_index/doc</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;Te Hero2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;tehero_index&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;MuJ0wXMBXLJ8u-9VMRcH&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span>: <span class="string">&quot;created&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;_seq_no&quot;</span>: <span class="number">2</span>,</span><br><span class="line">  <span class="attr">&quot;_primary_term&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>我们查询数据，看下效果：</p>
<p>GET   /tehero_index/doc/_search</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;MeJwwXMBXLJ8u-9VjBfs&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;Te Hero2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;Te Hero&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;MuJ0wXMBXLJ8u-9VMRcH&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;Te Hero2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2）修改"><a href="#2）修改" class="headerlink" title="2）修改"></a><strong>2）修改</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 根据id，修改单条数据</span><br><span class="line">（ps：修改语句和新增语句相同，可以理解为根据ID，存在则更新；不存在则新增）</span><br><span class="line">PUT &#x2F;tehero_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;Te Hero-update&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="3）查询"><a href="#3）查询" class="headerlink" title="3）查询"></a><strong>3）查询</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"># 1、根据id，获取单个数据</span><br><span class="line">GET &#x2F;tehero_index&#x2F;doc&#x2F;1</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">  &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">  &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot;: 4,</span><br><span class="line">  &quot;found&quot;: true,</span><br><span class="line">  &quot;_source&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;Te Hero-update&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 2、获取索引下的所有数据</span><br><span class="line">GET &#x2F;tehero_index&#x2F;_search</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 1,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 5,</span><br><span class="line">    &quot;successful&quot;: 5,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;MeJwwXMBXLJ8u-9VjBfs&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;Te Hero2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;MuJ0wXMBXLJ8u-9VMRcH&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;Te Hero2&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;name&quot;: &quot;Te Hero-update&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4）删除-1"><a href="#4）删除-1" class="headerlink" title="4）删除"></a><strong>4）删除</strong></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">根据id，删除单个数据</span><br><span class="line">DELETE &#x2F;tehero_index&#x2F;doc&#x2F;1</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="5）批量操作-Bulk-API"><a href="#5）批量操作-Bulk-API" class="headerlink" title="5）批量操作 Bulk API"></a>5）批量操作 Bulk API</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"># 批量操作</span><br><span class="line">POST _bulk</span><br><span class="line">&#123; &quot;index&quot; : &#123; &quot;_index&quot; : &quot;tehero_test1&quot;, &quot;_type&quot; : &quot;doc&quot;, &quot;_id&quot; : &quot;1&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;this_is_field1&quot; : &quot;this_is_index_value&quot; &#125;</span><br><span class="line">&#123; &quot;delete&quot; : &#123; &quot;_index&quot; : &quot;tehero_test1&quot;, &quot;_type&quot; : &quot;doc&quot;, &quot;_id&quot; : &quot;2&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;create&quot; : &#123; &quot;_index&quot; : &quot;tehero_test1&quot;, &quot;_type&quot; : &quot;doc&quot;, &quot;_id&quot; : &quot;3&quot; &#125; &#125;</span><br><span class="line">&#123; &quot;this_is_field3&quot; : &quot;this_is_create_value&quot; &#125;</span><br><span class="line">&#123; &quot;update&quot; : &#123;&quot;_id&quot; : &quot;1&quot;, &quot;_type&quot; : &quot;doc&quot;, &quot;_index&quot; : &quot;tehero_test1&quot;&#125; &#125;</span><br><span class="line">&#123; &quot;doc&quot; : &#123;&quot;this_is_field2&quot; : &quot;this_is_update_value&quot;&#125; &#125;</span><br><span class="line"></span><br><span class="line">结果</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 101,</span><br><span class="line">  &quot;errors&quot;: false,</span><br><span class="line">  &quot;items&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;index&quot;: &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_test1&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_version&quot;: 1,</span><br><span class="line">        &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">        &quot;_shards&quot;: &#123;</span><br><span class="line">          &quot;total&quot;: 2,</span><br><span class="line">          &quot;successful&quot;: 1,</span><br><span class="line">          &quot;failed&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_seq_no&quot;: 0,</span><br><span class="line">        &quot;_primary_term&quot;: 1,</span><br><span class="line">        &quot;status&quot;: 201</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;delete&quot;: &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_test1&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_version&quot;: 1,</span><br><span class="line">        &quot;result&quot;: &quot;not_found&quot;,</span><br><span class="line">        &quot;_shards&quot;: &#123;</span><br><span class="line">          &quot;total&quot;: 2,</span><br><span class="line">          &quot;successful&quot;: 1,</span><br><span class="line">          &quot;failed&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_seq_no&quot;: 0,</span><br><span class="line">        &quot;_primary_term&quot;: 1,</span><br><span class="line">        &quot;status&quot;: 404</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;create&quot;: &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_test1&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;3&quot;,</span><br><span class="line">        &quot;_version&quot;: 1,</span><br><span class="line">        &quot;result&quot;: &quot;created&quot;,</span><br><span class="line">        &quot;_shards&quot;: &#123;</span><br><span class="line">          &quot;total&quot;: 2,</span><br><span class="line">          &quot;successful&quot;: 1,</span><br><span class="line">          &quot;failed&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_seq_no&quot;: 0,</span><br><span class="line">        &quot;_primary_term&quot;: 1,</span><br><span class="line">        &quot;status&quot;: 201</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;update&quot;: &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;tehero_test1&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_version&quot;: 2,</span><br><span class="line">        &quot;result&quot;: &quot;updated&quot;,</span><br><span class="line">        &quot;_shards&quot;: &#123;</span><br><span class="line">          &quot;total&quot;: 2,</span><br><span class="line">          &quot;successful&quot;: 1,</span><br><span class="line">          &quot;failed&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;_seq_no&quot;: 1,</span><br><span class="line">        &quot;_primary_term&quot;: 1,</span><br><span class="line">        &quot;status&quot;: 200</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注：POST _bulk 都做了哪些操作呢？</p>
</blockquote>
<blockquote>
<p>1、若索引“tehero_test1”不存在，则创建一个名为“tehero_test1”的 index，同时若id = 1 的文档存在，则更新；不存在则插入一条 id=1 的文档；</p>
</blockquote>
<blockquote>
<p>2、删除 id=2 的文档；</p>
</blockquote>
<blockquote>
<p>3、插入 id=3 的文档；若文档已存在，则报异常；</p>
</blockquote>
<blockquote>
<p>4、更新 id = 1 的文档。</p>
</blockquote>
<h2 id="6、ElasticSearch倒排索引与分词"><a href="#6、ElasticSearch倒排索引与分词" class="headerlink" title="6、ElasticSearch倒排索引与分词*"></a>6、ElasticSearch倒排索引与分词*</h2><h5 id="1）倒排索引概念"><a href="#1）倒排索引概念" class="headerlink" title="1）倒排索引概念"></a>1）倒排索引概念</h5><p>​        1.百度百科：倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index)。带有倒排索引的文件我们称为倒排<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E7%B4%A2%E5%BC%95%E6%96%87%E4%BB%B6">索引文件</a>，简称<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%80%92%E6%8E%92%E6%96%87%E4%BB%B6/4137688">倒排文件</a>(inverted file)。</p>
<p>​        2.以书举例：</p>
<p>​          目录页   ===&gt;   正排索引</p>
<p>​          索引页   ===&gt;   倒排索引</p>
<p>​        3.正排索引和倒排索引：</p>
<p>​         A、正排索引：<strong>文档ID</strong>到<strong>文档内容、单词</strong>的关联关系    </p>
<table>
<thead>
<tr>
<th>文档ID</th>
<th>文档内容</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>elasticsearch是最流行的搜索引擎</td>
</tr>
<tr>
<td>2</td>
<td>php是世界上最好的语言</td>
</tr>
<tr>
<td>3</td>
<td>搜索引擎是如何产生的</td>
</tr>
</tbody></table>
<p>B、倒排索引：<strong>单词</strong>到<strong>文档ID</strong>的关联关系</p>
<table>
<thead>
<tr>
<th>单词</th>
<th>文档ID列表</th>
</tr>
</thead>
<tbody><tr>
<td>elasticsearch</td>
<td>1</td>
</tr>
<tr>
<td>流行</td>
<td>1</td>
</tr>
<tr>
<td>搜索引擎</td>
<td>1，3</td>
</tr>
<tr>
<td>php</td>
<td>2</td>
</tr>
<tr>
<td>世界</td>
<td>2</td>
</tr>
<tr>
<td>最好</td>
<td>2</td>
</tr>
<tr>
<td>语言</td>
<td>2</td>
</tr>
<tr>
<td>如何</td>
<td>3</td>
</tr>
<tr>
<td>诞生</td>
<td>3</td>
</tr>
</tbody></table>
<p>  C、查询包含“搜索引擎”的文档流程：</p>
<p>​            a、通过倒排索引，获得对应的文档ID：1，3；</p>
<p>​            b、通过文档ID，查询完整内容；</p>
<p>​            c、返回最终结果。</p>
<h5 id="2）倒排索引是怎么工作的"><a href="#2）倒排索引是怎么工作的" class="headerlink" title="2）倒排索引是怎么工作的"></a>2）倒排索引是怎么工作的</h5><blockquote>
<p>主要包括2个过程：1、创建倒排索引；2、倒排索引搜索</p>
</blockquote>
<p>2.1 创建倒排索引</p>
<blockquote>
<p>还是使用上面的例子。先对<strong>文档的内容</strong>进行分词，形成一个个的 <strong>token</strong>，也就是 <strong><em>单词</em></strong>，然后保存这些 token 与文档的对应关系。</p>
</blockquote>
<p>2.2 倒排索引搜索</p>
<blockquote>
<p>搜索示例1：“学习索引”</p>
</blockquote>
<ul>
<li><p>先分词，得到两个Token：“学习”、“索引”</p>
</li>
<li><p>然后去倒排索引中进行匹配</p>
</li>
</ul>
<h5 id="3）倒排索引详解"><a href="#3）倒排索引详解" class="headerlink" title="3）倒排索引详解"></a>3）倒排索引详解</h5><p>   1、组成：</p>
<p>​          A、单词词典（Term Dictionary）</p>
<p>​          B、倒排列表（Posting List）</p>
<p>​    2、单词词典：</p>
<p>​          记录所有文档的单词，一般都比较大，记录了<strong>单词</strong>到<strong>倒排列表</strong>的关联信息，一般使用B + Tree实现。</p>
<p>​    3、倒排列表：</p>
<p>​          记录单词对应的文档集合，由倒排索引项Posting List组成。</p>
<p>​           A、倒排索引项主要包含：</p>
<p>​            a、文档ID。用于获取原始信息。</p>
<p>​            b、词频TF。记录该单词在该文档中的出现次数，用于计算相关性得分。</p>
<p>​            c、位置Position。记录单词在文档中的分词位置(多个)，用于词语搜索。</p>
<p>​            d、偏移Offset。记录单词在文档的开始和结束位置，用于高亮显示。</p>
<p>​          B、如上的数据中，“搜索引擎”的Posting List为：</p>
<table>
<thead>
<tr>
<th>DocID</th>
<th>TF</th>
<th>Position</th>
<th>Offset</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>1</td>
<td>2</td>
<td>&lt;18,22&gt;</td>
</tr>
<tr>
<td>3</td>
<td>1</td>
<td>0</td>
<td>&lt;0,4&gt;</td>
</tr>
</tbody></table>
<h5 id="4）分词介绍"><a href="#4）分词介绍" class="headerlink" title="4）分词介绍"></a>4）分词介绍</h5><p>​        指：将文本转换成一系列单词Term/Token的过程，也可称作文本分析，ES中叫作：<strong>Analysis</strong>。</p>
<p>​        ※分词器(Analyzer)：</p>
<p>​          ES中专门处理分词的组件，<strong>组成</strong>和<strong>执行顺序</strong>如下：</p>
<p>​            A、Character Filters(多个)。针对原始文本进行处理，如：去除html特使标记符</p>等。</p>
<p>​            B、Tokenizer(一个)。将原始文本按一定规则划分为单词。</p>
<p>​            C、Token Filters(多个)。针对Tokenizer处理的单词进行再加工，如：转小写、删除、新增等。</p>
<h5 id="5）分词API"><a href="#5）分词API" class="headerlink" title="5）分词API"></a>5）分词API</h5><p>​        ES提供了一个测试分词的API接口，使用endpoint：_analyze。</p>
<p>​        并且：可以指定分词器进行测试，还可以直接指定索引中的字段，甚至自定义分词器进行测试。</p>
<p>​        1）指定分词器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#指定分词器进行分词测试</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;analyzer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;text&quot;</span>:<span class="string">&quot;hello world!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;world&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">6</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        </p>
<p>2）直接指定索引中字段：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#直接指定索引中字段  使用username字段的分词方式对text进行分词。</span><br><span class="line">POST test_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;field&quot;</span>:<span class="string">&quot;username&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;text&quot;</span>:<span class="string">&quot;hello world!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;world&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">6</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>3）自定义分词器：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#自定义分词器，自定义Tokenizer、filter、等进行分词，举例：</span><br><span class="line">POST _analyze</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;tokenizer&quot;</span>:<span class="string">&quot;standard&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;filter&quot;</span>:[<span class="string">&quot;lowercase&quot;</span>],</span><br><span class="line"> <span class="attr">&quot;text&quot;</span>:<span class="string">&quot;Hello World!&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;hello&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">5</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;world&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">6</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">11</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;&lt;ALPHANUM&gt;&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>​    5、ES自带分词器：</p>
<table>
<thead>
<tr>
<th>1）standard(默认分词器)</th>
<th>按词划分、支持多语言、小写处理。</th>
</tr>
</thead>
<tbody><tr>
<td>2）simple</td>
<td>按非字母划分、小写处理。</td>
</tr>
<tr>
<td>3）whitespace</td>
<td>按空格划分。</td>
</tr>
<tr>
<td>4）stop</td>
<td>按非字母划分、小写处理、按StopWord（语气助词：the、an、的、这等）处理。</td>
</tr>
<tr>
<td>5）keyword</td>
<td>不分词，作为一个单词输出。</td>
</tr>
<tr>
<td>6）pattern</td>
<td>通过正则表达式自定义分隔符，默认\w+，即：非字词的符号作为分隔符。</td>
</tr>
<tr>
<td>7）Language</td>
<td>另外还有30+常见语言的分词器（如：arabic、armenian、basque等）</td>
</tr>
</tbody></table>
<p>  6、中文分词器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">#使用默认分词器</span><br><span class="line">POST _analyze</span><br><span class="line">  &#123;</span><br><span class="line">  &quot;analyzer&quot;:&quot;standard&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;南京市长江大桥欢迎你&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  结果：</span><br><span class="line">  &#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;南&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 1,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;京&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 1,</span><br><span class="line">      &quot;end_offset&quot;: 2,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;市&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 2,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 2</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;长&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 3,</span><br><span class="line">      &quot;end_offset&quot;: 4,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 3</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;江&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 4,</span><br><span class="line">      &quot;end_offset&quot;: 5,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 4</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;大&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 5,</span><br><span class="line">      &quot;end_offset&quot;: 6,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 5</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;桥&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 6,</span><br><span class="line">      &quot;end_offset&quot;: 7,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 6</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;欢&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 7,</span><br><span class="line">      &quot;end_offset&quot;: 8,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 7</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;迎&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 8,</span><br><span class="line">      &quot;end_offset&quot;: 9,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 8</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;你&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 9,</span><br><span class="line">      &quot;end_offset&quot;: 10,</span><br><span class="line">      &quot;type&quot;: &quot;&lt;IDEOGRAPHIC&gt;&quot;,</span><br><span class="line">      &quot;position&quot;: 9</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      中文分词的难点在于：汉语中的分词没有一个形式上的分隔符，上下文不同，分词的结果也就不同，比如交叉歧义问题：“<strong>南京市长江大桥欢迎你</strong>”，到底是“<strong>南京市长/江大桥/欢迎你</strong>”，还是“<strong>南京市/长江大桥/欢迎你</strong>”？</p>
<p>​      目前，常用的中文分词器有：</p>
<p>​      1）IK。实现中英文分词，支持多模式，可自定义词库，支持热更新分词词典。</p>
<p>​      2）jieba。python中流行，支持繁体分词、并行分词，可自定义词典、词性标记等。         </p>
<p>  7、自定义分词：</p>
<p>​      通过自定义：Character Filters、Tokenizer、Token Filter实现。格式：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">PUT index名</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  <span class="attr">&quot;setting&quot;</span>:&#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span>:&#123;</span><br><span class="line"></span><br><span class="line">      <span class="attr">&quot;char_filter&quot;</span>:&#123;&#125;,</span><br><span class="line"></span><br><span class="line">      <span class="attr">&quot;tokenizer&quot;</span>:&#123;&#125;,</span><br><span class="line"></span><br><span class="line">      <span class="attr">&quot;filter&quot;</span>:&#123;&#125;,</span><br><span class="line"></span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span>:&#123;&#125;     </span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>举例:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PUT sss</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;analysis&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;custom_analyzer&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;custom&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;tokenizer&quot;</span>: <span class="string">&quot;standard&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;filter&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;lowercase&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;my_text&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;custom_analyzer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​                   </p>
<h2 id="7、ik分词"><a href="#7、ik分词" class="headerlink" title="7、ik分词*"></a>7、ik分词*</h2><h5 id="1-ik-max-word：细颗粒度分词"><a href="#1-ik-max-word：细颗粒度分词" class="headerlink" title="1) ik_max_word：细颗粒度分词"></a>1) ik_max_word：细颗粒度分词</h5><blockquote>
<p><strong>ik_max_word: 会将文本做最细粒度的拆分</strong>，比如会将“关注我系统学习ES”拆分为“关注，我，系统学，系统，学习，es”，<strong>会穷尽各种可能的组合</strong>，<strong>适合 Term Query</strong>；  </p>
</blockquote>
<pre><code>POST _analyze
&#123;
    &quot;analyzer&quot;: &quot;ik_max_word&quot;,
    &quot;text&quot;:&quot;南京市长江大桥欢迎你&quot;
&#125;

结果
&#123;
  &quot;tokens&quot;: [
    &#123;
      &quot;token&quot;: &quot;南京市&quot;,
      &quot;start_offset&quot;: 0,
      &quot;end_offset&quot;: 3,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 0
    &#125;,
    &#123;
      &quot;token&quot;: &quot;南京&quot;,
      &quot;start_offset&quot;: 0,
      &quot;end_offset&quot;: 2,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 1
    &#125;,
    &#123;
      &quot;token&quot;: &quot;市长&quot;,
      &quot;start_offset&quot;: 2,
      &quot;end_offset&quot;: 4,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 2
    &#125;,
    &#123;
      &quot;token&quot;: &quot;长江大桥&quot;,
      &quot;start_offset&quot;: 3,
      &quot;end_offset&quot;: 7,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 3
    &#125;,
    &#123;
      &quot;token&quot;: &quot;长江&quot;,
      &quot;start_offset&quot;: 3,
      &quot;end_offset&quot;: 5,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 4
    &#125;,
    &#123;
      &quot;token&quot;: &quot;大桥&quot;,
      &quot;start_offset&quot;: 5,
      &quot;end_offset&quot;: 7,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 5
    &#125;,
    &#123;
      &quot;token&quot;: &quot;欢迎&quot;,
      &quot;start_offset&quot;: 7,
      &quot;end_offset&quot;: 9,
      &quot;type&quot;: &quot;CN_WORD&quot;,
      &quot;position&quot;: 6
    &#125;,
    &#123;
      &quot;token&quot;: &quot;你&quot;,
      &quot;start_offset&quot;: 9,
      &quot;end_offset&quot;: 10,
      &quot;type&quot;: &quot;CN_CHAR&quot;,
      &quot;position&quot;: 7
    &#125;
  ]
&#125;</code></pre>
<h5 id="2-ik-smart：粗颗粒度分词"><a href="#2-ik-smart：粗颗粒度分词" class="headerlink" title="2) ik_smart：粗颗粒度分词"></a>2) ik_smart：粗颗粒度分词</h5><blockquote>
<p><strong>ik_smart: 会做最粗粒度的拆分</strong>，<strong>适合 Phrase 查询。</strong></p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;南京市长江大桥欢迎你&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;南京市&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;长江大桥&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">7</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;欢迎&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">7</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">9</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;你&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">9</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  建议：一般情况下，为了提高搜索的效果，<strong>需要这两种分词器配合使用</strong>。既<strong>建索引时用 ik_max_word 尽可能多的分词</strong>，而<strong>搜索时用 ik_smart 尽可能提高匹配准度</strong>，让用户的搜索尽可能的准确。比如一个常见的场景，<strong>就是搜索”进口红酒”的时候，尽可能的不要出现口红相关商品或者让口红不要排在前面。</strong></p>
<blockquote>
<p>在简单学习了解了Ik分词后，我们就可以去学习es的全文查询了。</p>
</blockquote>
<p>​       </p>
<h5 id="3-数据准备"><a href="#3-数据准备" class="headerlink" title="3) 数据准备"></a>3) 数据准备</h5><p>创建index</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">PUT /hero_index</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;settings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;index&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;number_of_shards&quot;</span>: <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;number_of_replicas&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;doc&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;dynamic&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;content&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fields&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;ik_max_analyzer&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;ik_smart_analyzer&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</span><br><span class="line">              <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_smart&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;createAt&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;date&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;shards_acknowledged&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">&quot;index&quot;</span>: <span class="string">&quot;hero_index&quot;</span></span><br><span class="line">&#125;       </span><br></pre></td></tr></table></figure>

<p>解释下content字段的映射：【就是<strong>一个字段配置多个分词器</strong>】</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&quot;content&quot;: &#123;</span><br><span class="line">  &quot;type&quot;: &quot;keyword&quot;, # 默认为 keyword类型</span><br><span class="line">  &quot;fields&quot;: &#123;</span><br><span class="line">    &quot;ik_max_analyzer&quot;: &#123; # 创建名为 ik_max_analyzer 的子字段</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;ik_max_word&quot;, # 字段ik_max_analyzer 的倒排序索引分词器为ik_max_word</span><br><span class="line">      &quot;search_analyzer&quot;: &quot;ik_max_word&quot; # 检索关键词的分词器为ik_max_word</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;ik_smart_analyzer&quot;: &#123;  # 创建名为 ik_smart_analyzer的子字段</span><br><span class="line">      &quot;type&quot;: &quot;text&quot;,</span><br><span class="line">      &quot;analyzer&quot;: &quot;ik_smart&quot; # 字段ik_smart_analyzer 的倒排序索引分词器为ik_smart</span><br><span class="line">         # 字段ik_smart_analyzer 的检索关键词的分词器默认为ik_smart</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>相比粗暴的用不同的字段去实现配置不同的分词器而言，<strong>一个字段配置多个分词器</strong>在数据的存储和操作上方便许多，<strong>只用储存一个字段，即可得到不同的分词效果。</strong></p>
</blockquote>
<h5 id="4）Full-text-queries-之-match-query（检索关键词会被分词）"><a href="#4）Full-text-queries-之-match-query（检索关键词会被分词）" class="headerlink" title="4）Full text queries 之 match query（检索关键词会被分词）"></a>4）Full text queries 之 match query（检索关键词会被分词）</h5><p>match query：用于执行全文查询的标准查询，包括模糊匹配和短语或接近查询。</p>
<ul>
<li>1）批量导入数据</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST _bulk</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;hero_index&quot;</span>, <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>, <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;1&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;id&quot;</span> : <span class="number">1</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;关注我，系统学编程&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;hero_index&quot;</span>, <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>, <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;2&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;id&quot;</span> : <span class="number">2</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;系统学编程,就关注我&quot;</span> &#125;</span><br><span class="line">&#123; <span class="attr">&quot;index&quot;</span> : &#123; <span class="attr">&quot;_index&quot;</span> : <span class="string">&quot;hero_index&quot;</span>, <span class="attr">&quot;_type&quot;</span> : <span class="string">&quot;doc&quot;</span>, <span class="attr">&quot;_id&quot;</span> : <span class="string">&quot;3&quot;</span> &#125; &#125;</span><br><span class="line">&#123; <span class="attr">&quot;id&quot;</span> : <span class="number">3</span>,<span class="attr">&quot;content&quot;</span>:<span class="string">&quot;系统编程，求关注&quot;</span> &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>2）使用 content 的默认字段检索【keword】</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"># 1、发现查询不到结果</span><br><span class="line">GET /hero_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;content&quot;</span>:<span class="string">&quot;系统学&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">39</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 2、查询到id = 1 的文档</span><br><span class="line">GET /hero_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;content&quot;</span>:<span class="string">&quot;关注我，系统学编程&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">19</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">0.9808292</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;hero_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">0.9808292</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;关注我，系统学编程&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析：【语句1】发现查询不到结果，此时content<strong>是keyword类型，是不会分词的，</strong>所以检索词需要和内容完全一样，【语句2】查询到文档1　type:keyword不会分词， type:text: 会分词</p>
</blockquote>
<h5 id="5）使用-content-ik-max-analyzer-字段检索【ik-max-word】"><a href="#5）使用-content-ik-max-analyzer-字段检索【ik-max-word】" class="headerlink" title="5）使用 content.ik_max_analyzer 字段检索【ik_max_word】"></a>5）使用 content.ik_max_analyzer 字段检索【ik_max_word】</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"># 1、会检索出所有结果</span><br><span class="line">GET &#x2F;hero_index&#x2F;doc&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match&quot;:&#123;</span><br><span class="line">      &quot;content.ik_max_analyzer&quot;:&quot;系统学&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 14,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 3,</span><br><span class="line">    &quot;max_score&quot;: 1.0735387,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;hero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 1.0735387,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;id&quot;: 1,</span><br><span class="line">          &quot;content&quot;: &quot;关注我，系统学编程&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;hero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot;: 1.005015,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;id&quot;: 2,</span><br><span class="line">          &quot;content&quot;: &quot;系统学编程,就关注我&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;hero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;3&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.14330196,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;id&quot;: 3,</span><br><span class="line">          &quot;content&quot;: &quot;系统编程，求关注&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 2、改变检索分词器为ik_smart,只能检索到 文档1和文档2</span><br><span class="line">GET &#x2F;hero_index&#x2F;doc&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match&quot;:&#123;</span><br><span class="line">     &quot;content.ik_max_analyzer&quot; : &#123;</span><br><span class="line">                &quot;query&quot; : &quot;系统学&quot;,</span><br><span class="line">                &quot;analyzer&quot;: &quot;ik_smart&quot;</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 3,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 2,</span><br><span class="line">    &quot;max_score&quot;: 0.47000363,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;hero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.47000363,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;id&quot;: 1,</span><br><span class="line">          &quot;content&quot;: &quot;关注我，系统学编程&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;hero_index&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;2&quot;,</span><br><span class="line">        &quot;_score&quot;: 0.44000342,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;id&quot;: 2,</span><br><span class="line">          &quot;content&quot;: &quot;系统学编程,就关注我&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析：【语句1】能查询到所有文档，因为<strong>检索词根据ik_max_word分词，得到Token（系统、系统学）</strong>【语句2】的检索词<strong>根据ik_smart分词，只能得到Toke**</strong>n（系统学），不能匹配上文档3。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;_analyze</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">  &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">  &quot;text&quot;:&quot;系统学&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot;: &quot;系统学&quot;,</span><br><span class="line">      &quot;start_offset&quot;: 0,</span><br><span class="line">      &quot;end_offset&quot;: 3,</span><br><span class="line">      &quot;type&quot;: &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot;: 0</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">GET /_analyze</span><br><span class="line">&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="attr">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;text&quot;</span>:<span class="string">&quot;系统学&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;tokens&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;系统学&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;系统&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_WORD&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">1</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;学&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;start_offset&quot;</span>: <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;end_offset&quot;</span>: <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;CN_CHAR&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;position&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="6）match的核心参数：operator-——控制Token之间的逻辑关系，or-and"><a href="#6）match的核心参数：operator-——控制Token之间的逻辑关系，or-and" class="headerlink" title="6）match的核心参数：operator ——控制Token之间的逻辑关系，or/and"></a>6）match的核心参数：<strong>operator ——控制Token之间的逻辑关系，or/and</strong></h5><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 1、不配置，使用默认值or，得到文档1和文档2</span><br><span class="line">GET /hero_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;content.ik_smart_analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;系统学es&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="number">0.48527452</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;hero_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">0.48527452</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">1</span>,</span><br><span class="line">          <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;关注我，系统学编程&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;hero_index&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;doc&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;_score&quot;</span>: <span class="number">0.44217452</span>,</span><br><span class="line">        <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;id&quot;</span>: <span class="number">2</span>,</span><br><span class="line">          <span class="attr">&quot;content&quot;</span>: <span class="string">&quot;系统学编程,就关注我&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># 2、and，查询不到结果</span><br><span class="line"></span><br><span class="line">GET /hero_index/doc/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;content.ik_smart_analyzer&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;query&quot;</span>: <span class="string">&quot;系统学es&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;operator&quot;</span>:<span class="string">&quot;and&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;took&quot;</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;successful&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;total&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;max_score&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>分析：检索词“系统学es”被<strong>分词为【系统学、es】两个Token</strong>，【语句1】的operator<strong>默认值为or</strong>，所以文档1和2可以被检索到；【语句2】的operator的值是and，也就是需要<strong>同时包含【系统学、es】这两个Token才行</strong>，所以没有结果。</p>
</blockquote>
<h2 id="8-ES的mapping设置（表结构）"><a href="#8-ES的mapping设置（表结构）" class="headerlink" title="8.ES的mapping设置（表结构）"></a>8.ES的mapping设置（表结构）</h2><h5 id="1）Mapping简介"><a href="#1）Mapping简介" class="headerlink" title="1）Mapping简介"></a>1）Mapping简介</h5><p>​        1）类似于数据库中的表结构，主要作用如下：</p>
<p>​            A、定义Index下的Field Name；</p>
<p>​            B、定义Field的类型，如：数值型、字符串型、布尔型等；</p>
<p>​            C、定义倒排索引的相关配置，如：是否有索引，记录position等。</p>
<p>​        2）获取一个mapping，使用endpoint：_mapping，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test_index/_mapping</span><br></pre></td></tr></table></figure>

<h5 id="2）自定义Mapping"><a href="#2）自定义Mapping" class="headerlink" title="2）自定义Mapping"></a>2）自定义Mapping</h5><p>​        1）使用mappings进行自定义mapping，示例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#创建名为my_index的索引，并自定义mapping</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;:&#123;    #1.关键字</span><br><span class="line">  &quot;doc&quot;:&#123;    #2.类型名</span><br><span class="line">   &quot;properties&quot;:&#123;    #4.字段名称及类型定义</span><br><span class="line">    &quot;title&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;text&quot;    #3.字段类型</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;name&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;age&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;integer&quot;</span><br><span class="line">    &#125; </span><br><span class="line">   &#125;                 #4.截止</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   Mapping中的字段类型一旦设定之后，<strong>禁止直接修改</strong>。因为Luence事先的倒排索引生成后不能修改。如果一定要改，可以重新建立新的索引，然后对应修改mapping，之后将之前的数据进行reindex操作，导入新的文档。</p>
<p>  2）自定义mapping时允许新增字段。通过**<em>dynamic参数**</em>进行控制字段的新增，dynamic有三种配置：</p>
<p>​          A、true。默认配置，允许自动新增字段；</p>
<p>​          B、false。不允许自动新增字段，文档可以正常写入，但不能进行查询等操作；</p>
<p>​          C、strict。严格模式。文档不能写入，写入会报错。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#使用dynamic参数控制字段的新增</span><br><span class="line">PUT my_test_index</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">   &quot;dynamic&quot;:false,   #设置为false，索引不允许新增字段</span><br><span class="line">   &quot;properties&quot;:&#123;</span><br><span class="line">    &quot;title&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;text&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;name&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;age&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;integer&quot;</span><br><span class="line">    </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 如果此时，PUT新的字段，就不会成功，虽然不报错，但是没有内容：</p>
<p>#向名为my_test_index的索引增加字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PUT my_test_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;xxx&quot;,</span><br><span class="line">    &quot;age&quot;:&quot;xx&quot;,</span><br><span class="line">    &quot;gender&quot;:&quot;xx&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET my_test_index&#x2F;_search</span><br><span class="line"></span><br><span class="line">GET my_test_index&#x2F;_mapping</span><br><span class="line"></span><br><span class="line">GET my_test_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;:&#123;</span><br><span class="line">    &quot;match&quot;:&#123;</span><br><span class="line">      &quot;gender&quot;:&quot;male&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="3）copy-to的使用"><a href="#3）copy-to的使用" class="headerlink" title="3）copy_to的使用"></a>3）copy_to的使用</h5><p>功能：将该字段的值复制到目标字段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#copy_to的使用</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;:&#123;</span><br><span class="line">  &quot;doc&quot;:&#123;</span><br><span class="line">   &quot;properties&quot;:&#123;</span><br><span class="line">    &quot;first_name&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">     &quot;copy_to&quot;:&quot;full_name&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;last_name&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">     &quot;copy_to&quot;:&quot;full_name&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;full_name&quot;:&#123;</span><br><span class="line">     &quot;type&quot;:&quot;text&quot;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#向索引写入数据</span><br><span class="line">PUT my_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;first_name&quot;:&quot;John&quot;,</span><br><span class="line"> &quot;last_name&quot;:&quot;Smith&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#查询索引my_index中full_name同时包含John 和 Smith的数据</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;match&quot;:&#123;</span><br><span class="line">   &quot;full_name&quot;:&#123;</span><br><span class="line">    &quot;query&quot;:&quot;John Smith&quot;,</span><br><span class="line">    &quot;operator&quot;:&quot;and&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4）index参数的使用"><a href="#4）index参数的使用" class="headerlink" title="4）index参数的使用"></a>4）index参数的使用</h5><p>  功能：控制当前字段是否为索引，默认true，当设置为false的时候，不进行记录，此时该字段不能被搜索</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#index参数的使用</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;cookie&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;index&quot;</span>:<span class="literal">false</span>    #设置为<span class="literal">false</span>，该字段不能被搜索</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时在进行数据写入和查询，不能进行该字段搜索。一般用来进行不想被查询的私密信息设置，如身份证号，电话号码等：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#向使用了index参数的字段写入信息</span><br><span class="line">PUT my_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;cookie&quot;:&quot;name&#x3D;alfred&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="5）index-options参数的使用"><a href="#5）index-options参数的使用" class="headerlink" title="5）index_options参数的使用"></a>5）index_options参数的使用</h5><p>​        功能：控制倒排索引记录的内容，有如下四种配置：</p>
<p>​          1）<strong>docs</strong>                只记录文档ID</p>
<p>​          2）<strong>freqs</strong>               记录文档ID和词频TF</p>
<p>​          3）<strong>positions</strong>        记录文档ID、词频TF和分词位置 (默认)</p>
<p>​          4）<strong>offsets</strong>            记录文档ID、词频TF、分词位置和偏移</p>
<p>​        其中：text类型默认的配置是positions，其他的比如integer等类型默认为docs，目的是为了节省空间。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#index_options参数的使用</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;cookie&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;index_options&quot;</span>:<span class="string">&quot;offsets&quot;</span>  #记录文档ID、词频TF、分词位置和偏移</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6）null-value参数的使用"><a href="#6）null-value参数的使用" class="headerlink" title="6）null_value参数的使用"></a>6）null_value参数的使用</h5><p>功能：当字段遇到空值null时的处理策略。默认为null，即跳过。此时ES会忽略该值，可通过修改进行默认值的修改：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#使用null_value修改ES遇到null值时的默认返回值</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;cookie&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">     <span class="attr">&quot;null_value&quot;</span>:<span class="string">&quot;NULL&quot;</span>    #当遇到空值<span class="literal">null</span>的时候，返回一个字符串形式的NULL</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7）Field字段的数据类型"><a href="#7）Field字段的数据类型" class="headerlink" title="7）Field字段的数据类型"></a>7）Field字段的数据类型</h5><p>​        1）**<em>核心数据类型**</em></p>
<p>​          A、<strong>字符串型</strong>。          text(分词)，keyword(不分词)</p>
<p>​          B、<strong>数值型</strong>。              long、integer、short、byte、double、float、half_float、scaled_float</p>
<p>​          C、<strong>日期类型</strong>。          date</p>
<p>​          D、<strong>布尔类型</strong>。          boolean</p>
<p>​          E、<strong>二进制类型</strong>。       binary</p>
<p>​          F、<strong>范围类型</strong>。           integer_range、float_range、long_range、double_range、date_range</p>
<p>​        2）**<em>复杂数据类型**</em></p>
<p>​          A、<strong>数组类型</strong>。           array</p>
<p>​          B、<strong>对象类型</strong>。           object</p>
<p>​          C、<strong>嵌套类型</strong>。           nested object</p>
<p>​        3）<strong>地理位置数据类型</strong></p>
<p>​          A、<strong>点</strong>。                      geo-point</p>
<p>​          B、<strong>形状</strong>。                   geo-shape</p>
<p>​        4）**<em>专用类型**</em></p>
<p>​          A、<strong>记录ip地址</strong>。         ip</p>
<p>​          B、<strong>实现自动补全</strong>。    completion</p>
<p>​          C、<strong>记录分词数</strong>。        token_count</p>
<p>​          D、<strong>记录字符串hash值</strong>。murmur3</p>
<p>​          E、<strong>perclator</strong>。</p>
<p>​          F、<strong>join</strong>。</p>
<p>​        5）多字段特性：</p>
<p>​          ES允许对同一个字段采用不同的配置，如：<strong>分词</strong>。举例：<strong>对一个人名实现拼音搜索</strong>，只需要在人名字段中新增一个子字段pinyin即可。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#多字段特性</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;my_index&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;doc&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;properties&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;username&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">      &quot;field&quot;:&#123;    #增加子字段pinyin</span><br><span class="line">       &quot;pinyin&quot;:&#123;</span><br><span class="line">        &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">        &quot;analyzer&quot;:&quot;pinyin&quot;</span><br><span class="line">       &#125;</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;  </span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="8）ES的自动类型识别"><a href="#8）ES的自动类型识别" class="headerlink" title="8）ES的自动类型识别"></a>8）ES的自动类型识别</h5><p>​        1）Dynamic Mapping：</p>
<p>​            ES可以自动识别文档字段类型，从而降低用户使用成本。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#ES的自动类型识别</span><br><span class="line"></span><br><span class="line">PUT my_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;username&quot;:&quot;alfred&quot;,    #username字段自动识别为text类型</span><br><span class="line"> &quot;age&quot;:20                #age字段自动识别为long类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        2）ES依靠JSON文档的字段类型实现自动识别字段类型：</p>
<table>
<thead>
<tr>
<th>JSON类型</th>
<th>ElasticSearch类型</th>
</tr>
</thead>
<tbody><tr>
<td>null</td>
<td>忽略</td>
</tr>
<tr>
<td>boolean</td>
<td>boolean</td>
</tr>
<tr>
<td>浮点类型</td>
<td>float</td>
</tr>
<tr>
<td>整数类型</td>
<td>long</td>
</tr>
<tr>
<td>object</td>
<td>object</td>
</tr>
<tr>
<td>array</td>
<td>由第一个非null的值的类型决定</td>
</tr>
<tr>
<td>String</td>
<td>匹配为日期，则为date类型(默认开启)；匹配为数字，则为long类型/float类型(默认关闭)；都未匹配，则设为text类型，并附带keyword子字段</td>
</tr>
</tbody></table>
<p>​        3）验证ES的字段类型自动识别：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#验证ES的字段类型自动识别</span><br><span class="line"></span><br><span class="line">PUT my_index/doc/1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;username&quot;:&quot;alfred&quot;,    #字符串类型text</span><br><span class="line"> &quot;age&quot;:20,    #整数long</span><br><span class="line"> &quot;bitrh&quot;:&quot;1998-10-10&quot;,    #默认识别日期date</span><br><span class="line"> &quot;married&quot;:false,    #布尔类型boolean</span><br><span class="line"> &quot;year&quot;:&quot;18&quot;    #默认不识别数字text</span><br><span class="line"> &quot;tags&quot;:[&quot;boy&quot;,&quot;fashion&quot;],    #数组中第一个不为null的元素为字符串类型，所以为text</span><br><span class="line"> &quot;money&quot;:100.1    #浮点类型float</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        再对my_index进行mapping查询，就会获得每个字段的类型：</p>
<h5 id="9）ES中日期类型和数字的自动识别"><a href="#9）ES中日期类型和数字的自动识别" class="headerlink" title="9）ES中日期类型和数字的自动识别"></a>9）ES中日期类型和数字的自动识别</h5><p>  ES中可自行配置日期的格式，默认：[“strict_date_optional_time”,”yyyy/MM/dd HH:mm:ss Z|| yyyy/MM/dd z”]</p>
<p>1）使用dynamic_date_formats自定义日期格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#使用dynamic_date_formats自定义日期格式</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;:&#123;</span><br><span class="line">  &quot;doc&quot;:&#123;</span><br><span class="line">   &quot;dynamic_date_formats&quot;:[&quot;MM&#x2F;dd&#x2F;yyyy&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">#写入符合自定义格式的日期数据，可识别为date类型</span><br><span class="line">PUT my_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;create_time&quot;:&quot;01&#x2F;01&#x2F;2018&quot;    #create_time字段识别为date类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    2）使用date_detection可以关闭自动识别日期格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#使用date_detection关闭日期的自动识别</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;:&#123;</span><br><span class="line">  &quot;doc&quot;:&#123;</span><br><span class="line">   &quot;date_detection&quot;:false </span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">PUT my_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;create_time&quot;:&quot;01&#x2F;01&#x2F;2018&quot;    #create_time字段是text类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> ES中可配置数字是否识别，默认关闭：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#ES配置开启数字的自动识别</span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;:&#123;</span><br><span class="line">  &quot;doc&quot;:&#123;</span><br><span class="line">   &quot;numeric_detection&quot;:true    #开启数字自动识别</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">#写入数字数据，ES可以自动识别其类型</span><br><span class="line">PUT mu_index&#x2F;doc&#x2F;1</span><br><span class="line">&#123;</span><br><span class="line"> &quot;year&quot;:&quot;18&quot;,    #year字段自动识别为long类型</span><br><span class="line"> &quot;money&quot;:&quot;100.1&quot;    #money字段自动识别为float类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="10）ES中根据自动识别的数据类型，动态生成字符类型："><a href="#10）ES中根据自动识别的数据类型，动态生成字符类型：" class="headerlink" title="10）ES中根据自动识别的数据类型，动态生成字符类型："></a>10）ES中根据自动识别的数据类型，动态生成字符类型：</h5><p>​        1）(例)所有字符串类型都设为keyword类型（不分词）</p>
<p>​        2）(例)所有以message开头的字段都设为text类型（分词）</p>
<p>​        3）(例)所有以long_开头的字段都设为long类型</p>
<p>​        4）(例)所有自动匹配为double的类型都设为float类型。（为了节省空间）</p>
<p>​        举例：下面的例子就是讲匹配到的字符串类型都设为keyword类型。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#ES根据自动识别的数据类型、字段名等动态设定字符类型</span><br><span class="line">PUT test_index</span><br><span class="line">&#123;</span><br><span class="line"> &quot;mappings&quot;:&#123;</span><br><span class="line">  &quot;doc&quot;:&#123;</span><br><span class="line">   &quot;dynamic_template&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">     &quot;strings&quot;:&#123;</span><br><span class="line">      &quot;match_mapping_type&quot;:&quot;string&quot;,    #匹配到所有的字符串类型，全部设为keyword类型</span><br><span class="line">      &quot;mapping&quot;:&#123;</span><br><span class="line">       &quot;type&quot;:&quot;keyword&quot;</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  匹配规则一般有如下几个参数：</p>
<p>​          1）match_mapping_type                匹配ES自动识别的字段类型，如boolean、long、string等；</p>
<p>​          2）match、unmatch                       匹配字段名，比如”match”:”message*” ===&gt;以message开头的数据；</p>
<p>​          3）path_match、path_unmatch    匹配路径</p>
<h5 id="11）一般来说，自定义mapping的操作步骤如下"><a href="#11）一般来说，自定义mapping的操作步骤如下" class="headerlink" title="11）一般来说，自定义mapping的操作步骤如下"></a>11）一般来说，自定义mapping的操作步骤如下</h5><p>​          1）<strong>写入一条文档到ES的临时索引中，获取(复制)ES自动生成的mapping；</strong></p>
<p>​          2）<strong>修改获得的mapping，并在其中自定义相关配置；</strong></p>
<p>​          3）<strong>使用修改后的mapping创建实际所需索引。</strong></p>
<p>​          这样不但在开发上简便不少，而且还能防止字段遗漏。</p>
<h2 id="9-ElasticSearch的Search-API"><a href="#9-ElasticSearch的Search-API" class="headerlink" title="9.ElasticSearch的Search API*"></a>9.ElasticSearch的Search API*</h2><h5 id="0）在ES中，为了实现对存储的数据进行查询分析，使用endpoint：-search"><a href="#0）在ES中，为了实现对存储的数据进行查询分析，使用endpoint：-search" class="headerlink" title="0）在ES中，为了实现对存储的数据进行查询分析，使用endpoint：_search"></a>0）在ES中，为了实现对存储的数据进行查询分析，使用endpoint：<strong>_search</strong></h5><p>​        可以实现对索引的不同查询，如：</p>
<p>​        A、<strong>实现对所有索引的泛查询</strong>：GET /_search</p>
<p>​        B、<strong>实现对一个索引的单独查询</strong>：GET /my_index/_search</p>
<p>​        C、<strong>实现对多个索引的指定查询</strong>：GET /my_index1,my_index2/_search</p>
<p>​        D、<strong>实现对符合指定要求的索引进行查询</strong>：GET /my_*/_search</p>
<p>​        在进行查询的时候，主要有两种方式：</p>
<p>  在进行查询的时候，主要有两种方式：</p>
<p>​        A）URI Search。</p>
<p>​            特点：操作简单，直接通过命令行方便测试，但仅包含部分查询语法；</p>
<p>​            举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#URI Search方式进行查询</span></span><br><span class="line"></span><br><span class="line">GET my_test_index/_search?q=name:moumou</span><br></pre></td></tr></table></figure>

<p>​        B）Request Body Search。</p>
<p>​            特点：ES提供的完备查询语法，使用Query DSL(Domain Specific Language)进行查询。</p>
<p>​            举例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Request Body Search方式进行查询</span><br><span class="line">GET my_test_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;moumou&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1）URI-Search"><a href="#1）URI-Search" class="headerlink" title="1）URI Search"></a>1）URI Search</h5><p>   1）通过url query参数实现搜索，常用参数有：</p>
<p>​            A、q                            指定查询的语句，使用query string syntax语法</p>
<p>​            B、df                           q中不指定字段时默认查询的字段    ===&gt;   在不指定的时候默认查询所有字段</p>
<p>​            C、sort                        排序</p>
<p>​            D、timeout                 指定超时时间，默认不超时   </p>
<p>​            E、from，size            用于分页</p>
<p>​     举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用url query查询示例：</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search?q=username:alfred&amp;df=username&amp;sort=age:asc&amp;from=4&amp;size=10&amp;timeout=1s</span><br></pre></td></tr></table></figure>

<p>​        解释：</p>
<p>​        查询索引<strong>my_index</strong>中<strong>username</strong>字段中包含<strong>alfred</strong>的文档，结果按<strong>age</strong>字段<strong>升序排列</strong>，返回第<strong>5——14</strong>个文档，若超过<strong>1s</strong>未结束，则以超时结束。</p>
<h5 id="2）query-string-syntax语法"><a href="#2）query-string-syntax语法" class="headerlink" title="2）query string syntax语法"></a>2）query string syntax语法</h5><p>​            前置内容：term————单词，phrase————词语。</p>
<p>​            A、单词与词语语法：</p>
<p>​                单词：alfred way    等价于    alfred <strong>OR</strong> way</p>
<p>​                词语：”alfred way”    语句查询，要求先后顺序</p>
<p>​                泛查询：不指定字段，会在所有字段中去匹配其单词</p>
<p>​                指定字段查询：指定字段，在指定字段中匹配单词</p>
<p>​            B、Group分组设定，使用括号指定匹配的规则，举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分组设定,使用括号进行分组</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search?q=username:(alfred OR way)AND lee</span><br></pre></td></tr></table></figure>

<h5 id="3）search-api"><a href="#3）search-api" class="headerlink" title="3）search api"></a>3）search api</h5><p>​     A、泛查询：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#泛查询</span></span><br><span class="line">GET my_index/_search?q=alfred</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;profile&quot;</span>:<span class="literal">true</span>    <span class="comment">#使用profile参数，可以明确地看到ES如何执行的查询条件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    B、指定字段查询：</p>
<p>​          a、查询字段username中包含alfred的文档：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询字段username中包含alfred的文档</span></span><br><span class="line">GET my_index/_search?q=username:alfred</span><br></pre></td></tr></table></figure>

<p>​           b、查询字段username中包含alfred或way的文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询字段username中包含alfred或way的文档</span></span><br><span class="line">GET my_index/_search?q=username:alfred way</span><br></pre></td></tr></table></figure>

<p>​            c、查询字段username为”alfred way”的文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询字段username为&quot;alfred way&quot;的文档</span></span><br><span class="line">GET my_index/_search?q=username:<span class="string">&quot;alfred way&quot;</span></span><br></pre></td></tr></table></figure>

<p>​             d、分组后，查询字段username中包含alfred和包含way的文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分组后，查询字段username中包含alfred，包含way的文档</span></span><br><span class="line">GET my_index/_search?q=username:(alfred way)</span><br></pre></td></tr></table></figure>

<p>​                    这个和b的结果一样，但是区别在于使用分组之后，不进行泛查询。</p>
<h5 id="4）布尔操作符"><a href="#4）布尔操作符" class="headerlink" title="4）布尔操作符"></a>4）布尔操作符</h5><p>​            A、AND(&amp;&amp;)、OR(||)、NOT(!)，举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询索引my_index中username包含alfred但是不包含way的文档</span></span><br><span class="line">GET my_index/_search?q=username:(alfred NOT way)</span><br></pre></td></tr></table></figure>

<p>​            B、+对应must，-对应must_not，举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询索引my_index中一定包含lee，一定不含alfred，可能有way的文档</span></span><br><span class="line">GET my_index/_search?q=username:(way +lee -alfred)</span><br><span class="line"><span class="comment">#或写成</span></span><br><span class="line">GET my_index/_search?q=username:((lee &amp;&amp; !alfred) || (way &amp;&amp; lee &amp;&amp; !alfred))</span><br></pre></td></tr></table></figure>

<p>​            但是要注意一点：</p>
<p>​            在url中，+(加号)会被解析成空格，所以要使用encode后的结果，即：%2B，所以正确的查询语句应该为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查询索引my_index中一定包含lee，一定不包含alfred，可能包含way的文档</span></span><br><span class="line">GET my_index/_search?q=username:(way %2Blee -alfred)</span><br></pre></td></tr></table></figure>

<h5 id="5）范围查询（支持数值和日期）"><a href="#5）范围查询（支持数值和日期）" class="headerlink" title="5）范围查询（支持数值和日期）"></a>5）范围查询（支持数值和日期）</h5><p>​            A、区间写法：闭区间使用[ ]，开区间使用{ }</p>
<p>​                a、age:[1 TO 10]                                1 &lt;= age &lt;= 10</p>
<p>​                b、age:[1 TO 10}                                1 &lt;= age &lt; 10</p>
<p>​                c、age:[1 TO ]                                     age &gt;= 1</p>
<p>​                d、age:[* TO 10]                                age &lt;= 10</p>
<p>​            B、算数符号写法：</p>
<p>​                a、age:&gt;= 1                                        </p>
<p>​                b、age:(&gt;=1 &amp;&amp; &lt;= 10) / age:(+ &gt;= 1 + &lt;= 10)</p>
<p>​                举例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#查询索引my_index中username字段包含alfred或年龄大于20的文档</span><br><span class="line"></span><br><span class="line">GET my_index/_search?q=username:alfred age&gt;20</span><br><span class="line">#查询索引my_index中username字段包含alfred且年龄大于20的文档</span><br><span class="line">GET my_index/_search?q=username:alfred AND age&gt;20</span><br></pre></td></tr></table></figure>

<p>​            C、还可以对日期进行范围查询，注意：年/月是从1月1号/1号开始算的：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查询索引my_index中birth字段在1985和1990之间的文档</span><br><span class="line">GET my_index/_search?q=birth:(&gt;1985 AND &lt; 1990)</span><br></pre></td></tr></table></figure>

<h5 id="6）通配符查询"><a href="#6）通配符查询" class="headerlink" title="6）通配符查询"></a>6）通配符查询</h5><p>​            ?代表一个字符，*代表0个或多个字符，如：</p>
<p>​            name:a?lfred         /         name:a<em>d         /        name:alfred</em></p>
<p>​            注意：通配符匹配的执行效率较低，且占用内存较多，不建议使用，如果没有特殊要求，也不要将?或者*放在最前面，因为意味着要匹配所有文档，可能会造成OOM。</p>
<p>​          此外，还支持正则表达式/模糊匹配/近似度查询等</p>
<p>​            A、正则表达式：举例：/[a]?l.*/</p>
<p>​            B、模糊匹配：fuzzy query。举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模糊匹配。匹配与alfred差一个字符的词，比如：alfreds、alfret等</span></span><br><span class="line">GET my_index/_search?q=username:alfred~1</span><br></pre></td></tr></table></figure>

<p>​            C、近似度查询：proximity search。举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#近似度查询，查询字段username和&quot;alfred way&quot;差n个单词的文档</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search?q=username:<span class="string">&quot;alfred way&quot;</span> ~5</span><br></pre></td></tr></table></figure>

<p>​            <strong>使用场景常见于用户输入词的纠错中。</strong></p>
<p>   2、Request Body Search</p>
<p>​        ES自带的完备查询语句，将查询语句通过http request body发送到ES，主要参数有：</p>
<p>​        ①query    ===&gt;    符合<strong>Query DSL语法</strong>的查询条件</p>
<p>​        ②from，size</p>
<p>​        ③timeout</p>
<p>​        ④sort</p>
<h5 id="7）Query-DSL语法："><a href="#7）Query-DSL语法：" class="headerlink" title="7）Query DSL语法："></a>7）<em>Query DSL语法：</em></h5><p>​        <strong>基于JSON定义的查询语言，主要包含两个类型：</strong></p>
<p>​        <strong>1）字段类查询————如：term，match，range等。只针对一个字段进行查询</strong></p>
<p>​                A、<strong>全文匹配</strong></p>
<p>​                    针对text类型的字段进行全文检索，会对查询语句进行“先分词再查询”处理，如：match、match_phrase等</p>
<p>​                a、match query</p>
<p>​                       ①对字段进行全文检索(最基本和最常用的查询类型)，举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#match query</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;query&quot;</span>:&#123;  </span><br><span class="line">   <span class="string">&quot;match&quot;</span>:&#123;    <span class="comment">#关键词</span></span><br><span class="line">    <span class="string">&quot;username&quot;</span>:<span class="string">&quot;alfred way&quot;</span>    <span class="comment">#字段名和查询语句</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  从结果，可以返回匹配文件总数，返回文档列表，_score相关性得分等。</p>
<p>​       一般的执行流程为：</p>
<p>​            1.对查询语句分词==&gt;2.根据字段的倒排索引列表，进行匹配算分==&gt;3.汇总得分==&gt;4.根据得分排序，返回匹配文档</p>
<p>​           ②使用operator参数，可以控制单词间关系，有and / or：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用operator参数控制单词间关系</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;match&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;username&quot;</span>:<span class="string">&quot;alfred way&quot;</span>,</span><br><span class="line">   <span class="string">&quot;operator&quot;</span>:<span class="string">&quot;and&quot;</span>    <span class="comment">#and，同时包含alfred和way</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​          b、相关性算分，其本质就是一个排序问题</p>
<p>​                        计算文档与待查询语句之间的相关度，一般有四个重要概念：</p>
<p>​                        a、<strong>Term Frequency 词频</strong>(正相关)</p>
<p>​                        b、<strong>Document Frequency 文档频率</strong>(负相关)</p>
<p>​                        c、<strong>Inverse Term Frequency 逆文本频率</strong>(正相关)</p>
<p>​                        d、<strong>Field-length Norm 文档长度</strong>(负相关)</p>
<p>​                        目前ES有两个相关性算分的模型：</p>
<p>​                        ①<strong>TF/IDF模型</strong>。经典模型。</p>
<p><img src="https://img-blog.csdnimg.cn/2018112911263839.png" alt="img"></p>
<p>​                        在使用kibana进行查询时，使用explain参数，可以查看具体的计算方法。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#使用explain参数，可以查看具体的相关性的得分是如何计算的</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;explain&quot;:true,    #设置为true</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;match&quot;:&#123;</span><br><span class="line">   &quot;username&quot;:&quot;alfred&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​       注意：ES计算相关性得分是根据shard进行的，即分片的分数计算相互独立，所以在使用的时候要注意分片数，可以通过设定分片数为1来避免这个问题，主要是为了观察，不代表之后所有的分片全都设为1。一般放在创建索引后，未加数据之前。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#设定shards数量为1</span><br><span class="line"></span><br><span class="line">PUT my_index</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;settings&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;number_of_shards&quot;</span>:<span class="string">&quot;1&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​       ②<strong>BM25模型</strong>。5.x版本后的默认模型，是对TF/IDF的优化模型。best match，25指：迭代了25次才计算。</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1596765660243.png" alt="1596765660243"></p>
<p>  <strong>BM25的使用，降低了TF/IDF中因为TF过大导致的负面影响，在BM25中，一个单词的TF一直增长，到一定程度就趋于0变化。</strong></p>
<p>​     c、match phrase query</p>
<p>​           对字段做全文检索，有顺序要求。(短语匹配)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#使用match——phrase查询词语</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;match_phrase&quot;:&#123;    #关键词</span><br><span class="line">   &quot;job&quot;:&quot;java engineer&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>  通过使用<strong>slop参数</strong>，可以控制单词间间隔：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#使用slop参数，控制词语中的单词间隔</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;match_phrase&quot;:&#123;</span><br><span class="line">   &quot;job&quot;:&#123;</span><br><span class="line">    &quot;query&quot;:&quot;java engineer&quot;,</span><br><span class="line">    &quot;slop&quot;:&quot;1&quot;    #关键词，设定单词间隔</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    d、query string query</p>
<p>​         类似于URI Search中的q参数查询，举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#使用query_string查询</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;query_string&quot;:&#123;</span><br><span class="line">   &quot;default_field&quot;:&quot;username&quot;,</span><br><span class="line">   &quot;query&quot;:&quot;alfred AND way&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">#或</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;query_string&quot;:&#123;</span><br><span class="line">   &quot;fileds&quot;:[&quot;username&quot;,&quot;job&quot;],</span><br><span class="line">   &quot;query&quot;:&quot;alfred OR (java AND ruby)&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   e、simple query string query</p>
<p>​        类似于query string，但会忽略错误的查询语法，且仅支持部分查询语句。使用+，|，-分别代替AND，OR，NOT。</p>
<p>​                举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#使用simple query string query</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;simple_query_string&quot;:&#123;</span><br><span class="line">   &quot;fields&quot;:[username],</span><br><span class="line">   &quot;query&quot;:&quot;alfred +way&quot;    #等价于 &quot;query&quot;:&quot;alfred AND way&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   B、<strong>单词匹配</strong></p>
<p>​        a、term/terms query</p>
<p>​        将待查询语句作为整个单词进行查询，不做分词处理，举例：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#使用term进行单查询</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">#使用terms进行多查询</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;terms&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;username&quot;</span>:[<span class="string">&quot;alfred&quot;</span>,<span class="string">&quot;way&quot;</span>]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    此时如果直接使用alfred way作为username查询条件，是不会返回任何文档的。因为在username的倒排索引列表中，存在”alfred”和”way”的索引，但是不存在”alfred way”的索引。</p>
<p>​     b、range query</p>
<p>​          范围查询，主要针对数值类型和日期类型。</p>
<p>​           gt: greater than 大于</p>
<p>​           gte: greate than or equal to 大于等于</p>
<p>​           lt: less than 小于</p>
<p>​           lte: less than or equal to 小于等于</p>
<p>​          ①对数值的查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#range query对数值的查询</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;range&quot;:&#123;</span><br><span class="line">   &quot;age&quot;:&#123;</span><br><span class="line">    &quot;gte&quot;:10,</span><br><span class="line">    &quot;lte&quot;:20</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​      ②对日期的查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#range query对日期的查询</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;range&quot;:&#123;</span><br><span class="line">   &quot;birth&quot;:&#123;</span><br><span class="line">    &quot;lte&quot;:&quot;1988-01-01&quot;   #或者使用  &quot;lte&quot;:&quot;now-30y&quot;,这种Date Math类型</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        <strong>Date Math类型</strong>：针对日期提供的一种更友好的计算方式。</p>
<p>​        当前时间用now代替，具体时间的引用，需要使用||间隔。年、月、日、时、分、秒跟date一致：y、M、w、d、h、m、s。举例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#假设当前时间为2018-01-02 12:00:00</span><br><span class="line">now+1h   &#x3D;&gt;   2018-01-02 13:00:00</span><br><span class="line">now-1h   &#x3D;&gt;   2018-01-02 11:00:00</span><br><span class="line">now-1h&#x2F;d &#x3D;&gt;   2018-01-02 00:00:00</span><br><span class="line">2016-01-01||+1M&#x2F;d  &#x3D;&gt; 2016-02-01 00:00:00</span><br></pre></td></tr></table></figure>

<p> <strong>2）复合查询————如：bool查询等。包含一个/多个字段类查询/符合查询语句</strong></p>
<p>​        A、constant_score query</p>
<p>​         将内部的查询结果文档得分全部设定为1或boost的值。返回的相关性得分全部为1或boost</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#使用constant_score query</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  &quot;constant_score&quot;:&#123;    #关键词</span><br><span class="line">   &quot;match&quot;:&#123;</span><br><span class="line">    &quot;username&quot;:&quot;alfred&quot;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>   B、bool query</p>
<p>​         由一个/多个布尔子句组成，主要包含以下四个：</p>
<p>​         a、<strong>filter</strong>     只过滤符合条件的文档，不计算相关性得分，返回的相关性得分全部为0；</p>
<p>​         ES会对filter进行智能缓存，因此执行效率较高，在做简单匹配查询且不考虑得分的时候没推荐使用filter代替query</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#使用filter查询</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;bool&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;filter&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;term&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>b、<strong>must</strong>     文档必须符合must中的所有条件，影响相关性得分；</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#使用must进行查询</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;bool&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;must&quot;</span>:[    </span><br><span class="line">    &#123;</span><br><span class="line">     <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;username&quot;</span>:<span class="string">&quot;alfred&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">      <span class="attr">&quot;job&quot;</span>:<span class="string">&quot;specialist&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> c、<strong>must_not</strong>      文档必须排除must_not中的所有条件； </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#使用must_not进行查询</span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;bool&quot;</span>:&#123;</span><br><span class="line">   <span class="attr">&quot;must&quot;</span>:[</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;job&quot;</span>:<span class="string">&quot;java&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">&quot;must_not&quot;</span>:[</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">     <span class="attr">&quot;job&quot;</span>:<span class="string">&quot;ruby&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> d、<strong>should</strong>       文档可以符合should中的条件，影响相关性得分，分为两种情况：</p>
<p>​       同时配合minimum_should_match控制满足调价你的个数/百分比。</p>
<p>​        ①bool查询中只有should，不包含must的情况</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#bool查询中只有should的情况</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;bool&quot;:&#123;</span><br><span class="line">   &quot;should&quot;:[</span><br><span class="line">    &#123;</span><br><span class="line">     &quot;term&quot;:&#123;&quot;job&quot;:&quot;java&quot;&#125;    #条件1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">     &quot;term&quot;:&#123;&quot;job&quot;:&quot;ruby&quot;&#125;    #条件3</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">     &quot;term&quot;:&#123;&quot;job&quot;:&quot;specialist&quot;&#125;    #条件3</span><br><span class="line">    &#125;</span><br><span class="line">   ],</span><br><span class="line">   &quot;minimum_should_match&quot;:2    #至少需要满足两个条件</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>②bool查询中既有should，又包含must的情况，文档不必满足should中的条件，但是如果满足的话则会增加相关性得分。</p>
<p>#bool查询中同时包含should和must</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;bool&quot;:&#123;</span><br><span class="line">   &quot;should&quot;:[    #同时包含should</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;term&quot;:&#123;&quot;job&quot;:&quot;ruby&quot;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ],</span><br><span class="line">   &quot;must&quot;:[    #同时包含must</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;term&quot;:&#123;&quot;usernmae&quot;:&quot;alfred&quot;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当一个查询语句位于query或filter上下文的时候，ES的执行结果也不同。</p>
<table>
<thead>
<tr>
<th>query</th>
<th>查找和查询语句最匹配的文档，并对所有文档计算相关性得分</th>
<th>query bool中的：must/should</th>
</tr>
</thead>
<tbody><tr>
<td>filter</td>
<td>查找和查询语句最匹配的文档</td>
<td>bool中的：filter/must_not constant_score中的：filter</td>
</tr>
</tbody></table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#query和filter上下文</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;bool&quot;:&#123;</span><br><span class="line">   &quot;must&quot;:[    #query上下文</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;term&quot;:&#123;&quot;title&quot;:&quot;Search&quot;&#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;term&quot;:&#123;&quot;content&quot;:&quot;ElasticSearch&quot;&#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ],</span><br><span class="line">   &quot;filter&quot;:[    #filter上下文</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;term&quot;:&#123;&quot;status&quot;:&quot;published&quot;&#125;</span><br><span class="line">   &#125;,</span><br><span class="line">   &#123;</span><br><span class="line">    &quot;range&quot;:&#123;</span><br><span class="line">     &quot;publish_date&quot;:&#123;</span><br><span class="line">      &quot;gte&quot;:&quot;2015-01-01&quot;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   ]</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> D、count API</p>
<p>​        获取符合条件的文档书，使用endpoint：_count。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#使用_count获取符合条件的文档数</span><br><span class="line">GET my_index&#x2F;_count    #关键词</span><br><span class="line">&#123;</span><br><span class="line"> &quot;query&quot;:&#123;</span><br><span class="line">  &quot;match&quot;:&#123;</span><br><span class="line">   &quot;username&quot;:&quot;alfred&quot;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>E、Source Filtering</p>
<p>​                过滤返回结果中的_source中的字段，主要由以下两种方式：</p>
<p>​                    a、GET my_index/_search?_source=username        #url参数</p>
<p>​                    b、使用Request Body Search：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#不返回_source</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;_source&quot;:false</span><br><span class="line">&#125;</span><br><span class="line">#返回_source部分字段</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;_source&quot;:[&quot;username&quot;,&quot;age&quot;]</span><br><span class="line">&#125;</span><br><span class="line">#通配符匹配返回_source部分字段</span><br><span class="line">GET my_index&#x2F;_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;_source&quot;:&#123;</span><br><span class="line">  &quot;includes&quot;:&quot;*I*&quot;,</span><br><span class="line">  &quot;encludes&quot;:&quot;birth&quot;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="10-ElasticSearch的分布式特性"><a href="#10-ElasticSearch的分布式特性" class="headerlink" title="10.ElasticSearch的分布式特性*"></a>10.ElasticSearch的分布式特性*</h2><h5 id="1、ES支持集群模式，即一个分布式系统。其好处主要有以下2个"><a href="#1、ES支持集群模式，即一个分布式系统。其好处主要有以下2个" class="headerlink" title="1、ES支持集群模式，即一个分布式系统。其好处主要有以下2个:"></a>1、ES支持集群模式，即一个分布式系统。其好处主要有以下2个:</h5><p>​            A、<strong>可增大系统容量</strong>。比如：内存、磁盘的增加使得ES能够支持PB级别的数据；</p>
<p>​            B、<strong>提高了系统可用性</strong>。即使一部分节点停止服务，集群依然可以正常对外服务。</p>
<p>​        2）ES集群由多个ES实例构成。</p>
<p>​            不同集群通过集群名字来区分，通过配置文件<strong>elasticsearch.yml</strong>中的<strong>cluster.name</strong>可以修改，默认为<strong>elasticsearch</strong>。</p>
<p>​            每个ES实例的本质，其实是一个JVM进程，且有自己的名字，通过配置文件中的<strong>node.name</strong>可以修改。</p>
<h5 id="2、构建ES集群"><a href="#2、构建ES集群" class="headerlink" title="2、构建ES集群"></a>2、构建ES集群</h5><p>   1）启动一个节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ES启动单节点，配置集群名称，节点名称，文件路径</span><br><span class="line">bin&#x2F;elasticsearch -Epath.data&#x3D;node1 -Ecluster.name&#x3D;my_cluster -Enode.name&#x3D;node1 -d</span><br></pre></td></tr></table></figure>

<p>每个集群包含cluster state，主要记录一下信息：</p>
<p>​                节点信息：如节点名称、连接地址等</p>
<p>​                索引信息：如索引名称、配置等</p>
<p> 2）几个节点的名称：</p>
<p>​            A、<strong>主节点master</strong>：可修改cluster state的节点。一个集群仅一个。</p>
<p>​                cluster state存储于每个节点上，master维护最新版本并向其他从节点同步。</p>
<p>​            B、<strong>选举节点master-eligible</strong>：可以参与选举master的节点。</p>
<p>​                配置为：node.master:true。默认所有节点都可以参与选举。</p>
<p>​            C、<strong>协调节点cordinating</strong>：处理请求的节点。是所有节点的默认角色，且不能取消。</p>
<p>​                路由请求到正确的节点处理，如：创建索引的请求到master节点。</p>
<p>​            D、<strong>从节点data</strong>：存储数据的节点，默认所有节点都是data类型。</p>
<p>​                配置为：node.data:true。</p>
<p>3）如何在本地启动一个集群</p>
<p>​            当一个集群中只有一个节点，意味着这个节点宕机之后，整个集群都停止对外服务功能，所以，为了解决这个办法，可以在本地启动多个节点创建一个本地化集群：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建一个本地化集群my_cluster</span></span><br><span class="line">bin/elasticsearch -Epath.data=node1 -Ecluster.name=my_cluster -Enode.name=node1 -d</span><br><span class="line">bin/elasticsearch -Ehttp.port=8200 -Epath.data=node2 -Ecluster.name=my_cluster -Enode.name=node2 -d</span><br><span class="line">bin/elasticsearch -Ehttp.port=7200 -Epath.data=node3 -Ecluster.name=my_cluster -Enode.name=node3 -d</span><br></pre></td></tr></table></figure>



<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1596768666588.png" alt="1596768666588"></p>
<h5 id="3、副本和分片"><a href="#3、副本和分片" class="headerlink" title="3、副本和分片"></a>3、副本和分片</h5><p>​        1）提高系统可用性</p>
<p>​            为了提高系统的可用性，从两个角度进行考虑：</p>
<p>​            A、<strong>服务可用性</strong>：在2个/多个节点的情况下，允许1个/一部分节点停止服务，整个集群依然可以对外提供服务；</p>
<p>​            B、 <strong>数据可用性</strong>：引入**副本(replication)**解决1个/一部分节点停止，节点上数据也同时丢失的情况。此时每个节点都有完备数据。</p>
<p>  2）增大系统容量</p>
<p>​            先思考一个问题：如何将数据分布到所有节点？</p>
<p>​            答案是：引入分片(shard)。</p>
<p>​            A、什么是分片？</p>
<p>​                分片是ES能支持PB级别数据的基石。</p>
<p>​                a、分片存储部分数据，可以分布于任意节点；</p>
<p>​                b、分片数在索引创建时指定，且后续不能更改，默认为5个；</p>
<p>​                c、有主分片和副本分片之分，以实现数据的高可用；</p>
<p>​                d、副本分片由主分片同步数据，可以有多个，从而提高数据吞吐量。</p>
<p>​            B、如何设置分片数和副本数？</p>
<p>​                a、通过在DevTools在创建索引时指定：</p>
<p>#设置分片数和副本数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PUT my_test</span><br><span class="line">&#123;</span><br><span class="line"> &quot;settings&quot;:&#123;</span><br><span class="line">  &quot;number_of_shards&quot;:5,    #设置分片数为3</span><br><span class="line">  &quot;number_of_replicas&quot;:1    #设置副本数为1</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1596769012966.png" alt="1596769012966"></p>
<p> B、两个很有意义的问题：</p>
<p>​                假设现在有3个节点，每个节点上有一个主分片和一个副本分片，那么：</p>
<p>​                a、此时增加新的节点，能否提高索引的数据容量？</p>
<p>​                b、此时增加新的副本，能否提高索引读取时的吞吐量？</p>
<p>​                答案是：<strong>不行</strong>。</p>
<p>​                原因：a）三个节点上分布了同一个索引的三个主分片和三个副本分片，已经将所有的数据存到了这三个节点，如果此时增加新的节点，却没有数据给它们利用，造成了资源浪费，且不能提高索引的数据容量；b）新增的副本数，也会增加到这三个节点上，利用的还是同样的资源，所以在三个同样的节点上读取索引数据，吞吐量也不会提高。</p>
<p>​                那么，在这种情况下，如何才能提高这个索引的吞吐量呢？</p>
<p>​                答案是：<strong>既增加新的节点，又增加新的副本</strong>，这样把新的副本放在新的节点上，进行索引数据读取的时候，并且读取，就会提升索引数据读取的吞吐量。</p>
<h5 id="4、ES集群健康状态"><a href="#4、ES集群健康状态" class="headerlink" title="4、ES集群健康状态"></a>4、ES集群健康状态</h5><p> ES的健康状态分为三种：</p>
<p>​           1）Greed，绿色。表示所有主分片和副本分片都正常分配；</p>
<p>​           2）Yellow，黄色。表示所有主分片都正常分配，但有副本分片未分配；</p>
<p>​           3）Red，红色。表示有主分片未分配。</p>
<p>​        集群的状态可以通过api或者插件查看，下面是使用api查看集群状态的命令：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#使用api，查看集群的状态</span><br><span class="line"></span><br><span class="line">GET _cluster/health</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;cluster_name&quot;</span>: <span class="string">&quot;my_cluster&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;status&quot;</span>: <span class="string">&quot;green&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">&quot;number_of_nodes&quot;</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;number_of_data_nodes&quot;</span>: <span class="number">3</span>,</span><br><span class="line">  <span class="attr">&quot;active_primary_shards&quot;</span>: <span class="number">13</span>,</span><br><span class="line">  <span class="attr">&quot;active_shards&quot;</span>: <span class="number">26</span>,</span><br><span class="line">  <span class="attr">&quot;relocating_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;initializing_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;unassigned_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;delayed_unassigned_shards&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;number_of_pending_tasks&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;number_of_in_flight_fetch&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;task_max_waiting_in_queue_millis&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">&quot;active_shards_percent_as_number&quot;</span>: <span class="number">100</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        此时，会返回集群名称，集群状态，节点数，活跃分片数等信息。</p>
<p>​        如果此时磁盘空间不够，name在创建新的索引的时候，主副分片都不会再分配，此时的集群状态会直接飙红，但此时依然可以访问集群和索引，也可以正常进行搜索。</p>
<p>​        所以：<strong>ES的集群状态为红色，不一定就不能正常服务</strong>。</p>
<h5 id="5、故障转移-Failover"><a href="#5、故障转移-Failover" class="headerlink" title="5、故障转移 Failover"></a>5、故障转移 Failover</h5><p>​        1）什么是故障转移？</p>
<p>​            在一个多节点集群中的master节点突然宕机，此时集群缺少主节点，剩余的节点组成新的集群，并将幸存副本分片转为主分片，同时在剩余节点生成副本分片，并依然对外进行正常服务的情况，称为故障转移。</p>
<p>​        2）如何进行故障转移？</p>
<p>​            当其余节点发现定时ping主节点master无响应的时候，集群状态转为<strong>Red</strong>。此时会发起master选举。称为master的新主节点发现有主分片没有进行分配，会将继续工作的节点上的副本分片升级为主分片，此时集群状态转为<strong>Yellow</strong>。之后，主节点会为对应节点生成未分配的副本分片，此时集群状态转为<strong>Green</strong>。整个故障转移过程结束。</p>
<p><img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\1596769149805.png" alt="1596769149805"></p>
<h5 id="6、文档分布式存储"><a href="#6、文档分布式存储" class="headerlink" title="6、文档分布式存储"></a>6、文档分布式存储</h5><p>​        Document最终存储到分片上，那么文档的数据是如何选择要存储的分片的呢？</p>
<p>​        此时，就需要<strong>文档到分片的映射算法</strong>。</p>
<p>​        目的：是文档均匀分布到所有分片上，以充分利用资源。之所以不用随机和轮询round-robin算法的原因是：需要维护文档到分片的映射关系，那么在PB级别的数据量的时候，这是一个成本非常大的工程。</p>
<p>​        所以：<strong>直接根据文档值实时计算对应的分片即可</strong>。分片的计算公式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shard = <span class="built_in">hash</span>(routing)%number_of_primary_shards</span><br></pre></td></tr></table></figure>

<p>​        hash保证数据均匀分布在分片中，<strong>routing作为关键参数，默认为文档ID</strong>，number_of_primary_shards为主分片数。</p>
<p>​        这也是为什么，主分片数一旦设定，不能更改的原因————<strong>为了保证文档对应的分片不会发生改变</strong>。</p>
<p>​        接下来介绍文档创建和读取的流程，以一个集群三个节点为例：</p>
<p>​        1）文档创建的流程</p>
<p>​            A、Client向node3发送创建文档请求；</p>
<p>​            B、node3通过routing计算该文档存储在shard1上，查询cluster state后，确认主shard1在node2上，然后转发请求到node2；</p>
<p>​            C、node2上的主shard1接收并执行创建文档的请求后，将同样的请求转发到副shard1，查询cluster state后，确认副shard1在node1，向node1发送请求；</p>
<p>​            D、node1上的副shard1接收并执行创建文档的请求后， 通知主shard1结果；</p>
<p>​            E、node2上的主shard1接收到副shard1创建文档成功的结果，通知node3创建成功；</p>
<p>​            F、node3返回结果给Client。</p>
<p>​        2）文档读取的流程</p>
<p>​            A、Client向node3发送读取文档doc1的请求；</p>
<p>​            B、node3通过routing计算该doc1在shard1上，查询cluster state后，确认主shard1和副shard1的位置，然后以<strong>轮询</strong>的机制获取一个shard(比如这次是主shard1，下次就是副shard1)；</p>
<p>​            C、本次是在node2上的主shard1接收到读取文档的请求，执行并返回结果给node3；</p>
<p>​            D、node3返回结果给Client。</p>
<p>​        3）文档批量创建的流程</p>
<p>​            A、Client向node3发送批量创建文档请求(bulk)；</p>
<p>​            B、node3通过routing计算文档对应的所有shard，然后按主shard分配对应执行的操作，同时发送请求到设计到的的主shard；</p>
<p>​            C、每个主shard接收并执行请求后，发送同样的请求到副shard；</p>
<p>​            D、每个副shard接收并执行请求后，返回结果到主shard，再由主shard返回给 node3；</p>
<p>​            E、node3整合所有结果，并返回给Client。</p>
<p>​        4）文档批量读取的流程</p>
<p>​            A、Client向node3发送批量读取文档请求(bulk)；</p>
<p>​            B、node3通过routing计算文档对应的所有shard，再以轮询的机制，按shard构建mget请求，通过发送给设计的shard；</p>
<p>​            C、由shard返回文档结果；</p>
<p>​            D、node3整合后返回结果到Client。</p>
<h5 id="7、脑裂问题"><a href="#7、脑裂问题" class="headerlink" title="7、脑裂问题"></a>7、脑裂问题</h5><p>​        1）什么是脑裂问题？</p>
<p>​            在分布式系统中有一个经典的网络问题。</p>
<p>​            当一个集群在运行时，作为master节点的node1的网络突然出现问题，无法和其他节点通信，出现网络隔离情况。那么node1自己会组成一个单节点集群，并更新cluster state；同时作为data节点的node2和node3因为无法和node1通信，则通过选举产生了一个新的master节点node2，也更新了cluster state。那么当node1的网络通信恢复之后，集群无法选择正确的master。</p>
<p>​        2）如何解决脑裂问题？</p>
<p>​           解决方案也很简单：仅在可选举的master-eligible节点数 &gt;= quorum的时候才进行master选举。</p>
<p>​           quorum(至少为2)=master-eligible数量/2   +  1。</p>
<p>​           通过discovery.zen.minimum_master_nodes为quorum即可避免脑裂。</p>
<p>​    8、Shards分片详解</p>
<p>​        1）倒排索引一旦生成，不能更改。</p>
<p>​            A、优点：</p>
<p>​                a、不用考虑并发写文件的问题，杜绝了锁机制带来的性能问题；</p>
<p>​                b、文件不在更改，则可以利用文件系统缓存，只需载入一次，只要内存足够，直接从内存中读取该文件，性能高；</p>
<p>​                c、利于生成缓存数据(且不需更改)；</p>
<p>​                d、利于对文件进行压缩存储，节省磁盘和内存存储空间。</p>
<p>​            B、缺点：</p>
<p>​                在写入新的文档时，必须重构倒排索引文件，然后替换掉老倒排索引文件后，新文档才能被检索到，<strong>导致实时性差</strong>。</p>
<p>​        2）解决文档搜索的实时性问题的方案：</p>
<p>​            新文档直接生成新待排索引文件，查询时同时查询所有倒排索引文件，然后做结果的汇总即可，从而提升了实时性。</p>
<p>​        3）Segment</p>
<p>​            Lucene就采用了上述方案，构建的单个倒排索引称为Segment，多个Segment合在一起称为Index(Lucene中的Index)。在ES中的一个shard分片，对应一个Lucene中的Index。且Lucene有一个专门记录所有Segment信息的文件叫做<strong>Commit Point</strong>。</p>
<p>​            Segment写入磁盘的过程依然很耗时，可以借助文件系统缓存的特性。【先将Segment在内存中创建并开放查询，来进一步提升实时性】，这个过程在ES中被称为：<strong>refresh</strong>。</p>
<p>​            在refresh之前，文档会先存储到一个缓冲队列buffer中，refresh发生时，将buffer中的所有文档清空，并生成Segment。</p>
<p>​            ES默认每1s执行一次refresh操作，因此实时性提升到了1s。这也是ES被称为近实时的原因（Near Real Time）。</p>
<p>​        4）translog文件 binlog</p>
<p>​            那么，如果在节点写入磁盘之前就发生了宕机，这时候内存中的segment丢失，该怎么解决呢？</p>
<p>​            此时，引入了translog机制：当文档写入buffer时，同时会将该操作写入到translog中，这个文件会即时将数据写入磁盘，在6.0版本之后默认每个要求都必须落盘，这个操作叫做<strong>fsync操作</strong>。这个时间也是可以通过配置：index.translog.*进行修改的。比如每五秒进行一次fdync操作，那么风险就是丢失这5s内的数据。</p>
<p>​        5）文档搜索实时性————flush(十分重要)</p>
<p>​            flush的功能，就是：将内存中的Segment写入磁盘，主要做如下工作：</p>
<p>​                A、将translog写入磁盘；</p>
<p>​                B、将index bufffer清空，其中的文档生成一个新的Segment，相当于触发一次refresh；</p>
<p>​                C、更新Commit Point文件并写入磁盘；</p>
<p>​                D、执行fsync落盘操作，将内存中的Segment写入磁盘；</p>
<p>​                E、删除旧的translog文件。</p>
<p>​        6）refresh与flush的发生时机</p>
<p>​            A、refresh：发生时机主要有以下几种情况：</p>
<p>​                a、<strong>间隔时间达到</strong>。</p>
<p>​                    通过index.settings.refresh_interval设置，默认为1s。</p>
<p>​                b、<strong>index.buffer占满时</strong>。</p>
<p>​                    通过indices.memory.index_buffer_size设置，默认JVM heap的10%，且所有shard共享。</p>
<p>​                c、<strong>flush发生时</strong>。会触发一次refresh。</p>
<p>​            B、flush：发生时机主要有以下几种情况：</p>
<p>​                a、<strong>间隔时间达到</strong>。</p>
<p>​                    5.x版本之前，通过index.translog.flush_threshold_period设置，默认30min。</p>
<p>​                    5.x版本之后，ES强制每30min执行一次flush，不能再进行更改。</p>
<p>​                b、<strong>translog占满时</strong>。</p>
<p>​                    通过index.translog.flush_threshold_size设置，默认512m。且每个Index有自己的translog。</p>
<p>​        7）删除和更新文档：</p>
<p>​            A、删除：</p>
<p>​                  Segment一旦生成，就不能更改，删除的时候，Lucene专门维护一个.del文件，记录所有已删除的文档。</p>
<p>​                  .del 文件 上记录的是文档在Lucene中的ID，在查询结果返回之前，会过滤掉.del 文件 中的所有文档。</p>
<p>​            B、更新：</p>
<p>​                   先删除老文档，再创建新文档，两个文档的ID在Lucene中的ID不同，但是在ElasticSearch中ID相同。</p>
<p>​        8）Segment Merging(合并)</p>
<p>​            A、随着Segment的增多，由于每次查询的Segment数量也增多，导致查询速度变慢；</p>
<p>​            B、ES会定时在后台进行Segment merge的操作，减少Segment数量；</p>
<p>​            C、通过force_merge api可以手动强制做Segment的合并操作。</p>
<h2 id="11-ElasticSearch中Search的运行机制"><a href="#11-ElasticSearch中Search的运行机制" class="headerlink" title="11.ElasticSearch中Search的运行机制*"></a>11.ElasticSearch中Search的运行机制*</h2><p> Search执行的时候，实际分为两个步骤执行：</p>
<p>​        —&gt; Query阶段：搜索</p>
<p>​        —&gt; Fetch阶段：获取</p>
<p>​    1、Query—Then—Fetch：</p>
<p>​        假设集群my_cluster中存在三个节点node1、node2、node3，其中master为node1，其余的为data节点。</p>
<p>​        1）<strong>Query阶段</strong>:</p>
<p>​            假设node3接收到Client发送的查询请求之后，先进行query：</p>
<p>​            A、node3在6个主副分片上随机选择3个分片，发送search request；</p>
<p>​            B、被选中的3个分片分别执行查询并排序，返回from+size个文档id和排序值；</p>
<p>​            C、node3整合3个分片返回的from+size个文档id，根据排序值排序选取from到from+size的文档id。</p>
<p>​        2）<strong>Fetch阶段</strong>:</p>
<p>​            node3根据Query阶段获取的文档id列表去对应shard上获取详情数据：</p>
<p>​            A、node3向相关分片发送multi_get请求；</p>
<p>​            B、3个分片返回文档详细数据；</p>
<p>​            C、node3拼接返回的结果返回给Client。</p>
<p>​    2、相关性算分：</p>
<p>​        <strong>相关性算分在shard和shard之间是相互独立的</strong>。也就意味着：同一个单词term在不同的shard上的TDF等值也可能是不同的。得分与shard有关。当文档数量不多是，会导致相关性算分严重不准的情况发生。</p>
<p>​        解决方案：</p>
<p>​            1）设置分片数为1个，从根本上排除问题。（此方案只适用于百万/少千万级的少量数据）</p>
<p>​            2）使用DFS Query-then-Fetch查询方式。</p>
<p>​        DFS Query-then-Fecth：</p>
<p>​            在拿到所有文档后，再重新进行完整的计算一次相关性得分，耗费更多的CPU和内存，执行性能也较低。所以也不推荐。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#使用DLS Query-then-Fetch进行查询：</span><br><span class="line"></span><br><span class="line">GET my_index/_search？search_type=dfs_query_then_fetch</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;query&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;match&quot;</span>:&#123;</span><br><span class="line">   ..</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    3、排序相关：</p>
<p>​        默认采用相关性算分结果进行排序。可通过sort参数自定义排序规则，如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用sort关键词进行排序</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;sort&quot;</span>:&#123;    <span class="comment">#关键词</span></span><br><span class="line">  <span class="string">&quot;birth&quot;</span>:<span class="string">&quot;desc&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#或使用数组形式定义多字段排序规则</span></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;sort&quot;</span>:[    <span class="comment">#使用数组</span></span><br><span class="line">  &#123;</span><br><span class="line">   <span class="string">&quot;birth&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;order&quot;</span>:<span class="string">&quot;asc&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="string">&quot;age&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;order&quot;</span>:<span class="string">&quot;desc&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        1）直接按数字/日期排序，如上例中birth。</p>
<p>​        2）按字符串进行排序：字符串排序较特殊，因为在ES中有keyword和text两种：</p>
<p>​            A、针对text类型排序：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#直接对text类型进行排序</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;sort&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;username&quot;</span>:<span class="string">&quot;desc&quot;</span>    <span class="comment">#针对username字段进行倒序排序</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​                返回结果：</p>
<p><img src="https://img-blog.csdnimg.cn/20181203103528719.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hpd2Vz,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>​            B、针对keyword类型排序：                </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#针对keyword进行排序</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;sort&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;username.keyword&quot;</span>:<span class="string">&quot;desc&quot;</span>    #针对username的子类型keyword类型进行倒叙排序</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        3）关于fielddata和docvalues:</p>
<p>​            排序的实质是对字段的原始内容排序的过程，此过程中<strong>倒排索引无法发挥作</strong>用，<strong>需要用到正排索引</strong>。即：通过文档ID和字段得到原始内容。ES提供2中实现方式：</p>
<p>​            A、Fielddata。    默认禁用。</p>
<p>​            B、DocValues。    默认启用，除了text类型。</p>
<p>​            Fielddata  对比  DocValues。</p>
<table>
<thead>
<tr>
<th>对比</th>
<th>Fielddata</th>
<th>DocValues</th>
</tr>
</thead>
<tbody><tr>
<td>创建时机</td>
<td>搜索时即时创建</td>
<td>创建索引时创建，和倒排索引创建时间一致</td>
</tr>
<tr>
<td>创建位置</td>
<td>JVM Heap</td>
<td>磁盘</td>
</tr>
<tr>
<td>优点</td>
<td>不占用额外磁盘空间</td>
<td>不占用Heap内存</td>
</tr>
<tr>
<td>缺点</td>
<td>文档较多时，同时创建会花费过多时间，占用过多Heap内存</td>
<td>减慢索引的速度，占用额外的磁盘空间</td>
</tr>
</tbody></table>
<p>​        4）Fielddata的开启:</p>
<p>​            Fielddata默认关闭，可通过如下api进行开启，且在后续使用时随时可以开启/关闭：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启字段的fielddata设置</span></span><br><span class="line">PUT my_index/_mapping/doc</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;properties&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;username&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;type&quot;</span>:<span class="string">&quot;text&quot;</span>,</span><br><span class="line">   <span class="string">&quot;fielddata&quot;</span>:<span class="literal">true</span>    <span class="comment">#关键词</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            使用场景：<strong>一般在对分词做聚合分析的时候开启</strong>。</p>
<p>​        5）Docvalues的关闭:</p>
<p>​            Docvalues默认开启，可在创建索引时关闭，且之后不能再打开，要打开只能做reindex操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#关闭字段的docvalues设置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PUT my_index</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;mappings&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;doc&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;properties&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>:&#123;</span><br><span class="line">     <span class="string">&quot;type&quot;</span>:<span class="string">&quot;keyword&quot;</span>,</span><br><span class="line">     <span class="string">&quot;doc_values&quot;</span>:<span class="literal">false</span>    <span class="comment">#关键词</span></span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            使用场景：当明确知道，不会使用这个字段排序或者不做聚合分析的时候，可关闭doc_values，减少磁盘空间的占用。</p>
<p>​    4、分页与遍历：</p>
<p>​        ES提供了三种方式来解决分页和遍历的问题：</p>
<p>​            <strong><em>from/size，scroll，search_after</em></strong>。</p>
<p>​        1）from/size:</p>
<p>​            from：指明开始位置；</p>
<p>​            size：指明获取总数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#使用from——size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;from&quot;:1,    #从第2个开始搜索</span><br><span class="line"> &quot;size&quot;:2     #获取2个长度</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            A、此时产生了一个经典的问题，也是分布式文件系统必定面对的问题：<strong>深度分页</strong>。</p>
<p>​                问题：如何在数据分片存储的情况下， 获取前1000个文档？</p>
<p>​                答案：先从每个分片上获取前1000个文档， 然后由处理节点聚合所有分片的结果之后，再排序获取前1000个文档。</p>
<p>​                此时页数越深，处理的文档就越多，占用的内存就越大，耗时就越长。这就是深度分页问题。</p>
<p>​                为了尽量避免深度分页为题，ES通过设定<strong>index.max_result_window</strong>限定最多到10000条数据。</p>
<p>​            B、在设计分页系统时，有一个<strong>分页数</strong>十分重要：</p>
<p>​                total_page=(total + page_size -1) / page_size</p>
<p>​                总分页数= (文档总数+认为设定的文档大小-1)   / 人为设定的文档大小</p>
<p>​                但是在搜索引擎中的意义并不大，因为如果排在前面的结果都不能让用户满意，那么越往后，越不能让用户满意。</p>
<p>​        2）scroll:</p>
<p>​            遍历文档集的API，以<strong>快照</strong>的方式来避免深度分页问题。</p>
<p>​            A、不能用来做实时搜索，因为数据不是实时的；</p>
<p>​            B、尽量不用复杂的sort条件，使用_doc最高效；</p>
<p>​            C、使用比较复杂。</p>
<p>​            步骤：</p>
<p>​                 a、发起一个scroll search：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#发起一个scroll search</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search?scroll=5m    <span class="comment">#该快照的有效时间为5min</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>1    <span class="comment">#指明每次scroll返回的文档数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​                 会返回后续会用到的_scroll_id：</p>
<p><img src="https://img-blog.csdnimg.cn/20181203110240612.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hpd2Vz,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>​            b、调用scroll search 的api，获取文档集合，不断迭代至返回hits数组为空时停止：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST _search/scroll</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;scroll&quot;</span>:<span class="string">&quot;5m&quot;</span>,    <span class="comment">#指明有效时间</span></span><br><span class="line"> <span class="string">&quot;scroll_id&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span>    <span class="comment">#上一步返回的_scroll_id</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            之后不断返回新的_scroll_id，使用新的_scroll_id进行查询，直到返回数组为空。</p>
<p>​            当不断的进行迭代，会产生很多scroll，导致大量内存被占用，可以通过clear api进行删除：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用clear api对scroll进行删除</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELETE /_search/scroll</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;scroll_id&quot;</span>:[</span><br><span class="line"></span><br><span class="line">   <span class="string">&quot;xxxxxx&quot;</span>,    <span class="comment">#_scroll_id</span></span><br><span class="line">   <span class="string">&quot;xxxxxx&quot;</span>,    <span class="comment">#_scroll_id</span></span><br><span class="line">......</span><br><span class="line"> ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#删除所有的scroll</span></span><br><span class="line"></span><br><span class="line">DELETE /_search/scroll/_all</span><br></pre></td></tr></table></figure>

<p>​        3）search_after:</p>
<p>​            避免深度分页的性能问题，提供实时的下一页文档获取功能。</p>
<p>​            缺点：不能使用from参数，即：不能指定页数。且只能下一页，不能上一页。</p>
<p>​            使用步骤：</p>
<p>​               A、第一步：正常搜索，但是要指定sort值，并保证值唯一：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第一步，正常搜索</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;size&quot;</span>:1,</span><br><span class="line"> <span class="string">&quot;sort&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="string">&quot;desc&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span>:<span class="string">&quot;desc&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​               B、第二步：使用上一步最后一个文档的sort值进行查询：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#第二步，使用sort值进行查询</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>:1,</span><br><span class="line"> <span class="string">&quot;search_after&quot;</span>:[28,<span class="string">&quot;2&quot;</span>],    <span class="comment">#28,&quot;2&quot;，是上一次搜索返回的sort值</span></span><br><span class="line"> <span class="string">&quot;sort&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;age&quot;</span>:<span class="string">&quot;desc&quot;</span>,</span><br><span class="line">  <span class="string">&quot;_id&quot;</span>:<span class="string">&quot;desc&quot;</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        4）如何避免深度分页问题:</p>
<p>​            这个问题目前连google都没能解决，所以只能最大程度避免，通过唯一排序值定位每次要处理的文档数都控制在size内：</p>
<p>​            应用场景：</p>
<p>​            A、from/size:需实时获取顶部的部分文档，且需自由翻页（实时）；</p>
<p>​            B、scroll:需全部文档，如：导出所有数据的功能（非实时）；</p>
<p>​            C、search_after:需全部文档，不需自由翻页（实时）。</p>
<h2 id="12-ElasticSearch的聚合分析"><a href="#12-ElasticSearch的聚合分析" class="headerlink" title="12.ElasticSearch的聚合分析"></a>12.ElasticSearch的聚合分析</h2><h5 id="1-聚合分析简介"><a href="#1-聚合分析简介" class="headerlink" title="1.聚合分析简介"></a>1.聚合分析简介</h5><p>​        聚合分析，英文Aggregation，是ES除了搜索功能之外提供的针对ES数据进行统计分析的功能。</p>
<p>​        特点：①功能丰富，可满足大部分分析需求；②实时性高，所有计算结果实时返回。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#聚合分析格式：</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>:0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;    <span class="comment">#关键词</span></span><br><span class="line">  <span class="string">&quot;&lt;aggregation_name&gt;&quot;</span>:&#123;    <span class="comment">#自定义聚合分析名称，一般起的有意义</span></span><br><span class="line">   <span class="string">&quot;&lt;aggregation_type&gt;&quot;</span>:&#123;    <span class="comment">#聚合分析类型</span></span><br><span class="line">    <span class="string">&quot;&lt;aggregation_body&gt;&quot;</span>    <span class="comment">#聚合分析主体</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  [,<span class="string">&quot;aggs&quot;</span>:&#123;[&lt;svb_aggregation&gt;]+&#125;]    <span class="comment">#可包含多个子聚合分析</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        基于分析规则的不同，ES将聚合分析主要划分为以下4种：</p>
<p>​        A、Metric。指标分析类型，如：计算最值，平均值等；</p>
<p>​        B、Bucket。分桶类型，类似于group by语法，根据一定规则划分为若干个桶分类；</p>
<p>​        C、Pipeline。管道分析类型，基于上一级的聚合分析结果进行再分析；</p>
<p>​        D、Matrix。矩阵分析类型。</p>
<h5 id="2-Metric聚合分析"><a href="#2-Metric聚合分析" class="headerlink" title="2.Metric聚合分析"></a>2.Metric聚合分析</h5><p>​        主要分为两类：单值分析（输出单个结果）和多值分析（输出多个结果）。</p>
<p>​        1）单值分析</p>
<p>​            A、min。返回数值类型字段的最小值：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#min关键字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;min_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;min&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            B、max。返回数值类型字段的最大值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#max关键字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;max_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;max&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            C、avg。返回数值类型字段的平均值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#avg关键字</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;avg_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;avg&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            D、sum。返回数值类型字段值的总和。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#sum关键字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;sum_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;sum&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            E、cardinality。返回字段的基数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cardinality关键字</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;cardinality_age&quot;</span>:</span><br><span class="line">   <span class="string">&quot;cardinality&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            F、使用多个单值分析关键词，返回多个结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用多个单值分析关键词，返回多个分析结果</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">  <span class="string">&quot;min_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;min&quot;</span>:&#123;    <span class="comment">#求最大年龄</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;max_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;max&quot;</span>:&#123;    <span class="comment">#求最小年龄</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;avg_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;avg&quot;</span>:&#123;    <span class="comment">#求平均年龄</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;sum_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;sum&quot;</span>:&#123;    <span class="comment">#求年龄总和</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        2）多值分析</p>
<p>​            A、stats。返回所有单值结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用stats关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;stats_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;stats&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            B、extended stats。对stats进行扩展，包含更多，如：方差，标准差，标准差范围等：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用extended_stats关键词</span></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;stats_age&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;extended_stats&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>    </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​            C、Percentile。百分位数统计：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#使用percentiles关键词</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line"> <span class="attr">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="attr">&quot;per_age&quot;</span>:&#123;</span><br><span class="line">   &quot;percentiles&quot;:&#123;    #关键字</span><br><span class="line">    &quot;field&quot;:&quot;age&quot;   </span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​            D、Top hits。一般用于分桶之后获取该桶内最匹配的定不稳当列表，即详情数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用top_hits关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">POST _bulk</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;清蒸鱼头&quot;</span>,<span class="string">&quot;rating&quot;</span>:1,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;湘菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;剁椒鱼头&quot;</span>,<span class="string">&quot;rating&quot;</span>:2,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;湘菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;红烧鲫鱼&quot;</span>,<span class="string">&quot;rating&quot;</span>:3,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;湘菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;鲫鱼汤（辣）&quot;</span>,<span class="string">&quot;rating&quot;</span>:3,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;湘菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;鲫鱼汤（微辣）&quot;</span>,<span class="string">&quot;rating&quot;</span>:4,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;湘菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;鲫鱼汤（变态辣）&quot;</span>,<span class="string">&quot;rating&quot;</span>:5,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;湘菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;广式鲫鱼汤&quot;</span>,<span class="string">&quot;rating&quot;</span>:5,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;粤菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;鱼香肉丝&quot;</span>,<span class="string">&quot;rating&quot;</span>:2,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;川菜&quot;</span>&#125;</span><br><span class="line">&#123; <span class="string">&quot;index&quot;</span>:  &#123; <span class="string">&quot;_index&quot;</span>: <span class="string">&quot;recipes&quot;</span>, <span class="string">&quot;_type&quot;</span>: <span class="string">&quot;type&quot;</span>&#125;&#125; </span><br><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;奶油鲍鱼汤&quot;</span>,<span class="string">&quot;rating&quot;</span>:2,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;西菜&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET recipes/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>:0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;jobs&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;terms&quot;</span>:&#123;</span><br><span class="line">     <span class="string">&quot;field&quot;</span>:<span class="string">&quot;name.keyword&quot;</span>,</span><br><span class="line">     <span class="string">&quot;size&quot;</span>:10</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">     <span class="string">&quot;top_employee&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;top_hits&quot;</span>:&#123;</span><br><span class="line">       <span class="string">&quot;size&quot;</span>:10,</span><br><span class="line">       <span class="string">&quot;sort&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">         <span class="string">&quot;rating&quot;</span>:&#123;</span><br><span class="line">          <span class="string">&quot;order&quot;</span>:<span class="string">&quot;desc&quot;</span></span><br><span class="line">         &#125; </span><br><span class="line">        &#125;</span><br><span class="line">       ]</span><br><span class="line">      &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h5 id="3-Bucket聚合分析"><a href="#3-Bucket聚合分析" class="headerlink" title="3.Bucket聚合分析"></a>3.Bucket聚合分析</h5><p>​        Bucket，意为桶。即：按照一定规则，将文档分配到不同的桶中，达分类的目的。常见的有以下五类：</p>
<p>​        1）Terms。直接按term进行分桶，如果是text类型，按分词后的结果分桶：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用terms关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;terms_job&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;terms&quot;</span>:&#123;    <span class="comment">#关键</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;job.keyword&quot;</span>,    <span class="comment">#按job.keyword进行分桶</span></span><br><span class="line">    <span class="string">&quot;size&quot;</span>:5                  <span class="comment">#返回五个文</span></span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        2）Range。按指定数值范围进行分桶：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用range关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;number_ranges&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;range&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>,    <span class="comment">#按age进行分桶</span></span><br><span class="line">    <span class="string">&quot;ranges&quot;</span>:[</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&gt;=19 &amp;&amp; &lt; 25&quot;</span>,  <span class="comment">#第一个桶：  19&lt;=年龄&lt;25</span></span><br><span class="line">      <span class="string">&quot;from&quot;</span>:19,</span><br><span class="line">      <span class="string">&quot;to&quot;</span>:25</span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&lt; 19&quot;</span>,    <span class="comment">#第二个桶：  年龄&lt;19</span></span><br><span class="line">      <span class="string">&quot;to&quot;</span>:19</span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&gt;= 25&quot;</span>,    <span class="comment">#第三个桶：  年龄&gt;=25</span></span><br><span class="line">      <span class="string">&quot;from&quot;</span>:25</span><br><span class="line">     &#125;</span><br><span class="line">    ]</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        3）Date Range。按指定日期范围进行分桶：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用date_range关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;date_ranges&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;date_range&quot;</span>:&#123;    <span class="comment">#关键字</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;birth&quot;</span>,    <span class="comment">#按age进行分桶</span></span><br><span class="line">    <span class="string">&quot;format&quot;</span>:<span class="string">&quot;yyyy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ranges&quot;</span>:[</span><br><span class="line">     &#123;</span><br><span class="line">      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&gt;=1980 &amp;&amp; &lt; 1990&quot;</span>,  <span class="comment">#第一个桶：  1980&lt;=出生日期&lt;1990</span></span><br><span class="line">      <span class="string">&quot;from&quot;</span>:<span class="string">&quot;1980&quot;</span>,</span><br><span class="line">      <span class="string">&quot;to&quot;</span>:<span class="string">&quot;1990&quot;</span></span><br><span class="line">     &#125;,</span><br><span class="line"></span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line">      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&lt; 1980&quot;</span>,    <span class="comment">#第二个桶：  出生日期&lt;1980</span></span><br><span class="line">      <span class="string">&quot;to&quot;</span>:1980</span><br><span class="line">     &#125;,</span><br><span class="line">     &#123;</span><br><span class="line"></span><br><span class="line">      <span class="string">&quot;key&quot;</span>:<span class="string">&quot;&gt;= 1990&quot;</span>,    <span class="comment">#第三个桶：  出生日期&gt;=199</span></span><br><span class="line">      <span class="string">&quot;from&quot;</span>:1990</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    ]</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        4）Histogram。直方图，按固定数值间隔策略进行数据分割：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用histogram关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;age_hist&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;histogram&quot;</span>:&#123;     <span class="comment">#关键词</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;age&quot;</span>,</span><br><span class="line">    <span class="string">&quot;interval&quot;</span>:3,    <span class="comment">#设定间隔大小为3</span></span><br><span class="line">    <span class="string">&quot;extended_bounds&quot;</span>:&#123;    <span class="comment">#设定数据范围</span></span><br><span class="line">     <span class="string">&quot;min&quot;</span>:0,</span><br><span class="line">     <span class="string">&quot;max&quot;</span>:30</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        5）Date Histogram。日期直方图，按固定时间间隔进行数据分割：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用date_histogram关键词</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line"> <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line"> <span class="string">&quot;aggs&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;birth_hist&quot;</span>:&#123;</span><br><span class="line">   <span class="string">&quot;date_histogram&quot;</span>:&#123;     <span class="comment">#关键词</span></span><br><span class="line">    <span class="string">&quot;field&quot;</span>:<span class="string">&quot;birth&quot;</span>,</span><br><span class="line">    <span class="string">&quot;interval&quot;</span>:<span class="string">&quot;year&quot;</span>,    <span class="comment">#设定间隔大小为年year</span></span><br><span class="line">    <span class="string">&quot;format&quot;</span>:<span class="string">&quot;yyyy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;extended_bounds&quot;</span>:&#123;    <span class="comment">#设定数据范围</span></span><br><span class="line">     <span class="string">&quot;min&quot;</span>:<span class="string">&quot;1980&quot;</span>,</span><br><span class="line">     <span class="string">&quot;max&quot;</span>:<span class="string">&quot;199</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">   &#125;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h5 id="4-Bucket-Metric聚合分析"><a href="#4-Bucket-Metric聚合分析" class="headerlink" title="4.Bucket+Metric聚合分析"></a>4.Bucket+Metric聚合分析</h5><p>​         Bucket聚合分析允许通过添加子分析来进一步进行分析，该子分析可以是<strong>Bucket</strong>，也可以是<strong>Metric</strong>。</p>
<p>​         1）分桶之后再分桶（Bucket+Bucket），在数据可视化中一般使用<strong>千层饼图</strong>进行显示。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#分桶之后再分桶——Bucket+Bucket</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">             </span><br><span class="line">                    <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;age_range&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;ranges&quot;</span>: [</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;to&quot;</span>: <span class="number">20</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;from&quot;</span>: <span class="number">20</span>,</span><br><span class="line">                                    <span class="attr">&quot;to&quot;</span>: <span class="number">30</span></span><br><span class="line">                                &#125;,</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="attr">&quot;from&quot;</span>: <span class="number">30</span></span><br><span class="line">                                &#125;</span><br><span class="line">                            ]</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​         2）分桶之后再数据分析（Bucket+Metric）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分桶之后再数据分析——Bucket+Metric</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;size&quot;</span>: 10</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;stats_age&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;stats&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    5.Pipeline聚合分析</p>
<p>​        针对聚合分析的结果进行再分析，且支持链式调用：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#使用pipeline聚合分析,计算订单月平均销售额。</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;sales_per_month&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;date&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;interval&quot;</span>: <span class="string">&quot;month&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;sales&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;sum&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;price&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;avg_monthly_sales&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;avg_bucket&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;buckets_path&quot;</span>: <span class="string">&quot;sales_per_month&gt;sales&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        pipeline的分析结果会输出到原结果中，由输出位置不同，分为两类：Parent和Sibling。</p>
<p>​        1）Parent。结果内嵌到现有聚合分析结果中，如：Derivate、Moving Average、Cumulative Sum。</p>
<p>​        2）Sibling。结果与现有聚合分析结果同级，如：Max/Min/Sum/Avg Bucket、Stats/Extended Stats Bucket、Percentiles Bucket。</p>
<p>​        A、Sibling——————min_bucket，其他同理:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#Sibling聚合分析</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;size&quot;</span>: <span class="number">10</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;avg_salary&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;min_salary_by_job&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;min_bucket&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;buckets_path&quot;</span>: <span class="string">&quot;jobs&gt;avg_salary&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        B、Parent——————Derivate，其他同理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Parent聚合分析</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;bitrh&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;date_histogram&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;birth&quot;</span>,</span><br><span class="line">                <span class="string">&quot;interval&quot;</span>: <span class="string">&quot;year&quot;</span>,</span><br><span class="line">                <span class="string">&quot;min_doc_count&quot;</span>: 0</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;avg_salary&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">&quot;derivative_avg_salary&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;derivative&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;buckets_path&quot;</span>: <span class="string">&quot;avg_salary&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="6-聚合分析的作用范围"><a href="#6-聚合分析的作用范围" class="headerlink" title="6.聚合分析的作用范围"></a>6.聚合分析的作用范围</h5><p>​        ES聚合分析默认作用范围是query的结果集：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ES中聚合分析的默认作用范围是query的结果集</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;alfred&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;size&quot;</span>: 10</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        可通过以下方式修改：</p>
<p>​            ①filter。</p>
<p>​            ②post_filter。</p>
<p>​            ③global。</p>
<p>​        1）filter，为某个结合分析设定过滤条件，从而在不改变整体query语句的情况下修改范围。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用filter进行过滤</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;jobs_salary_small&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;range&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;salary&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;to&quot;</span>: 10000</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        2）post_filter，作用于文档过滤，但在聚合分析之后才生效。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用post_filter进行过滤</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;post_filter&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;job.keyword&quot;</span>: <span class="string">&quot;java engineer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        3）global，无视query条件，基于所有文档进行分析。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用global进行过滤</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;query&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;match&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;job.keyword&quot;</span>: <span class="string">&quot;java engineer&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;java_avg_salary&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;all&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;global&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;avg_salary&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;avg&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;field&quot;</span>: <span class="string">&quot;salary&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="7-聚合分析中的排序"><a href="#7-聚合分析中的排序" class="headerlink" title="7.聚合分析中的排序"></a>7.聚合分析中的排序</h5><p>​        1）可使用自带的关键数据排序，如：</p>
<p>​            _count 文档数、_key按key值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用自带的数据进行排序</span></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>,</span><br><span class="line">                <span class="string">&quot;size&quot;</span>: 10,</span><br><span class="line">                <span class="string">&quot;order&quot;</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;_count&quot;</span>: <span class="string">&quot;asc&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="string">&quot;_key&quot;</span>: <span class="string">&quot;desc&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        1）也可使用聚合结果进行排序，如：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#使用聚合结果进行排序</span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;size&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;salary_hist&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;histogram&quot;</span>: &#123;&#125;,</span><br><span class="line">            <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;range&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;age&quot;</span>: &#123;</span><br><span class="line">                                <span class="attr">&quot;gte&quot;</span>: <span class="number">10</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">                        <span class="attr">&quot;avg_age&quot;</span>: &#123;</span><br><span class="line">                            <span class="attr">&quot;field&quot;</span>: <span class="string">&quot;age&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="8-计算精准度"><a href="#8-计算精准度" class="headerlink" title="8.计算精准度"></a>8.计算精准度</h5><p>​        每个Shard上分别计算，由coordinating Node做聚合，多个Shard上分散着若干数据，而coordinating Node无法得知，那么在取数据的时候，比如：top hits的时候，结果有偏差，造成精准度不准确。解决办法有两种：</p>
<p>​        1）直接设置shard数量为1；</p>
<p>​        2）设置shard_size大小，即每次从shard上额外多获取数据，从而提升精准度</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用shard_size额外获取数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET my_index/_search</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 0,</span><br><span class="line">    <span class="string">&quot;aggs&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;jobs&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;terms&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;field&quot;</span>: <span class="string">&quot;job.keyword&quot;</span>,</span><br><span class="line">                <span class="string">&quot;size&quot;</span>: 1,</span><br><span class="line">                <span class="string">&quot;shard_size&quot;</span>: 10</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​        terms返回聚合结果中有两个统计值：</p>
<p>​        <img src="https://img-blog.csdnimg.cn/20181204135232346.png" alt="img"></p>
<p>​        doc_count_error_upper_bound：被一楼的term可能的最大值；</p>
<p>​        sum_other_doc_count：返回结果bucket的term外其他term的文档总数。</p>
<p><img src="https://img-blog.csdnimg.cn/20181204135355472.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0hpd2Vz,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>​        三者只能取其二。</p>
<h2 id="13-ElasticSearch的集群优化"><a href="#13-ElasticSearch的集群优化" class="headerlink" title="13.ElasticSearch的集群优化*"></a>13.ElasticSearch的集群优化*</h2><h5 id="1-生产环境部署"><a href="#1-生产环境部署" class="headerlink" title="1.生产环境部署"></a>1.生产环境部署</h5><p>​        1）遵照官方建议设置所有系统参数。</p>
<p>​            在ES的配置文件中elasticsearch.yml中，尽量只写必备的参数，其他可通过api进行动态设置，随着ES版本的不断升级，很多网上流传的参数，现在已经不再适用，所以不要胡乱复制。</p>
<p>​            建议设置的基本参数有：</p>
<p>​                ①cluster.name</p>
<p>​                ②node.name</p>
<p>​                ③node.master/node.data/node.ingest</p>
<p>​                ④network.host。建议显示指定为服务器的内网ip，切勿直接指定0.0.0.0，很容易直接从外部被修改ES数据。</p>
<p>​                ⑤discovery.zen.ping.unicast.hosts 设置集群其他节点地址，一般设置选举节点即可。</p>
<p>​                ⑥discovery.zen.minimum_master_nodes。一般设置为2，有3个即可。</p>
<p>​                ⑦path.data/path.log</p>
<p>​                ⑧除上述参数外，再根据需要增加其他的静态配置参数，如：refresh优化参数，indices.memory.index_buffer_size。</p>
<p>​        动态设定的参数有transient(短暂的)和persistent(持续的)两种，前者在集群重启后会丢失，后者在集群重启后依然生效。二者都覆盖了yml中的配置，举例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用transient和persistent动态设置ES集群参数</span></span><br><span class="line"></span><br><span class="line">PUT /_cluster/Settings</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line"> <span class="string">&quot;persistent&quot;</span>:&#123;    <span class="comment">#永久</span></span><br><span class="line">  <span class="string">&quot;discovery.zen.minimum_master_nodes:2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &#125;,</span></span><br><span class="line"><span class="string"> &quot;</span>transient<span class="string">&quot;:&#123;   #临时</span></span><br><span class="line"><span class="string">  &quot;</span>indices.store.throttle.max_bytes_per_sec<span class="string">&quot;:&quot;</span>50mb<span class="string">&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>​        2）关于JVM内存设定</p>
<p>​            每个节点尽量不要超多31GB。</p>
<p>​            预留一半内存给操作系统，用来做文件缓存。ES的具体内存大小根据node要存储的数据量来估算，为了保证性能：</p>
<p>​            搜索类项目中：内存：数据量   ===&gt;   1：16；</p>
<p>​            日志类项目中：内存：数据量   ===&gt;   1：48/96。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">假设现有数据1TB，3个node，1个副本，那么：</span><br><span class="line"></span><br><span class="line">每个node存储(1+1)*1024 &#x2F; 3 &#x3D; 666GB,即700GB左右，做20%预留空间，每个node约存850GB数据。</span><br><span class="line">此时：</span><br><span class="line">如果是搜索类项目，每个node内存约为850&#x2F;16&#x3D;53GB，已经超过31GB最大限制；</span><br><span class="line">而：31*16 &#x3D; 496，意味着每个node最大只能存496GB的数据，则：2024&#x2F;496&#x3D;4.08...即至少需要5个节点。</span><br><span class="line">如果是日志类项目，每个node最大能存:31*48&#x3D;1488GB,则：2024&#x2F;1488&#x3D;1.36...，则三个节点已经够了。</span><br></pre></td></tr></table></figure>

<h5 id="2-写性能优化"><a href="#2-写性能优化" class="headerlink" title="2.写性能优化"></a>2.写性能优化</h5><p>​        在写上面的优化，主要是增大写的吞吐量——EPS(Event Per Second)</p>
<p>​        优化方案：</p>
<p>​            ①Client：多线程写，批量写bulk；</p>
<p>​            ②ES：在高质量数据建模的前提下，主要在refresh、translog和flush之间做文章。</p>
<p>​        1）降低refresh写入内存的频率：</p>
<p>​            A、增大<strong>refresh_interval</strong>，降低实时性，增大每次refresh处理的文件数，默认1s。可以设为-1s，禁止自动refresh。</p>
<p>​            B、增大index buffer大小，参数为：<strong>indices.memory.index_buffer_size</strong>。</p>
<p>​                  此为静态参数，需设定在elasticsea.yml中，默认10%</p>
<p>​        2）降低translog写入磁盘频率，同时会降低容灾能力：</p>
<p>​            A、<strong>index.translog.durability</strong>：设为async；</p>
<p>​                  <strong>index.translog.sync_interval</strong>。设置需要的大小如：120s  =&gt;  每120s才写一次磁盘。</p>
<p>​            B、<strong>index.translog.flush_threshold_size</strong>。默认512m。</p>
<p>​                  即当translog大小超过此值，会触发一次flush，可以调大避免flush过早触发。</p>
<p>​        3）在flush方面，从6.x开始，ES固定每30min执行一次，所以优化点不多，一般都是ES自动完成。</p>
<p>​        4）其他：</p>
<p>​            A、将副本数设置为0，在文档全部写完之后再加副本；</p>
<p>​            B、合理设计shard数，保证shard均匀地分布在所有node上，充分利用node资源：</p>
<p>​                    index.routing.allocation.total_shards_per_node：限定每个索引在每个node上可分配的主副分片数，</p>
<p>​                  如：有5个node，某索引有10个主分片，1个副本(10个副分片)，则：20/5=45,但是实际要设置为5，预防某个node下线后分片迁移失败。</p>
<p>​        写性能优化，主要还是index级别的设置优化。</p>
<p>​        一般在refresh、translog、flush三个方面进行优化；</p>
<h5 id="3-读性能优化"><a href="#3-读性能优化" class="headerlink" title="3.读性能优化"></a>3.读性能优化</h5><p>​        主要受以下几方面影响：</p>
<p>​        ①数据模型是否符合业务模型？</p>
<p>​        ②数据规模是否过大？</p>
<p>​        ③索引配置是否优化？</p>
<p>​        ④查询运距是否优化？</p>
<p>​        1）高质量的数据建模</p>
<p>​            A、将需通过cripte脚本动态计算的值，提前计算好作为字段存入文档中；</p>
<p>​            B、尽量使数据模型贴近业务模型</p>
<p>​        2）根据不同数据规模设定不同的SLA(服务等级协议)，万级数据和千万级数据和亿万级数据性能上肯定有差异；</p>
<p>​        3）索引配置优化</p>
<p>​            A、根据数据规模设置合理的分片数，可通过测试得到最适合的分片数；</p>
<p>​            B、分片数并不是越多越好</p>
<p>​        4）查询语句优化</p>
<p>​            A、尽量使用Filter上下文，减少算分场景(Filter有缓存机制，能极大地提升查询性能)；</p>
<p>​            B、尽量不用cript进行字段计算或算分排序等；</p>
<p>​            C、结合profile、explain API分析慢查询语句的症结所在，再去优化数据模型。</p>
<h5 id="4-其他优化点"><a href="#4-其他优化点" class="headerlink" title="4.其他优化点"></a>4.其他优化点</h5><p>​        1）如何设定shard数？</p>
<p>​            ES的性能基本是线性扩展的，因此，只需测出一个shard的性能指标，然后根据实际的性能需求就可算出所需的shard数。</p>
<p>​            测试一个shard的流程如下：</p>
<p>​            ①搭建与生产环境相同配置的单节点集群；</p>
<p>​            ②设定一个单分片0副本的索引；</p>
<p>​            ③写入实际生产数据进行测试，获取（写性能指标）；</p>
<p>​            ④针对数据进行查询操作，获取（读性能指标）。</p>
<p>​        2）压力测试工具，可以采用ES自带的esrally，从经验上讲：</p>
<p>​            <strong>如果是搜索引擎场景，单shard大小不超过15GB；</strong></p>
<p>​            <strong>如果是日志分析场景，单shard大小不超过50GB。</strong></p>
<p>​            估算索引的总数据大小，除以上述单shard大小，也可得到经验上的分片数。</p>
<h5 id="5-ES集群监控"><a href="#5-ES集群监控" class="headerlink" title="5.ES集群监控"></a>5.ES集群监控</h5><p>​        使用官方免费插件X-pack。</p>
<p>​        1）安装与启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#X-pack的安装</span></span><br><span class="line"><span class="built_in">cd</span> ~/elasticsearch-6.1.1</span><br><span class="line"></span><br><span class="line">bin/elasticsearch-plugin install x-pack</span><br><span class="line"><span class="built_in">cd</span> ~/kibana-6.1.1</span><br><span class="line">bin/kibana-plugin indtall x-pack</span><br><span class="line"></span><br><span class="line">之后重启ES集群即可。</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/21/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/redis%E9%9B%86%E7%BE%A4%E4%B9%8B%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/21/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/redis%E9%9B%86%E7%BE%A4%E4%B9%8B%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Redis哨兵模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-21 16:08:58 / 修改时间：16:12:20" itemprop="dateCreated datePublished" datetime="2020-09-21T16:08:58+08:00">2020-09-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Redis哨兵模式"><a href="#Redis哨兵模式" class="headerlink" title="Redis哨兵模式"></a>Redis哨兵模式</h2><h3 id="1-Redis-sentinel介绍"><a href="#1-Redis-sentinel介绍" class="headerlink" title="1.Redis sentinel介绍"></a>1.Redis sentinel介绍</h3><p>Redis Sentinel是Redis高可用的实现方案。Sentinel是一个管理多个Redis实例的工具，它可以实现对Redis的监控、通知、自动故障转移。</p>
<h3 id="2-redis-sentinel的主要功能"><a href="#2-redis-sentinel的主要功能" class="headerlink" title="2.redis sentinel的主要功能"></a>2.redis sentinel的主要功能</h3><p>Sentinel的主要功能包括主节点存活检测、主从运行情况检测、自动故障转移（failover）、主从切换。Redis的Sentinel最小配置是一主一从。 Redis的Sentinel系统可以用来管理多个Redis服务器，该系统可以执行以下四个任务：</p>
<ul>
<li><p>监控</p>
<p>Sentinel会不断的检查主服务器和从服务器是否正常运行。</p>
</li>
<li><p>通知</p>
<p>当被监控的某个Redis服务器出现问题，Sentinel通过API脚本向管理员或者其他的应用程序发送通知。</p>
</li>
<li><p>自动故障转移</p>
<p>当主节点不能正常工作时，Sentinel会开始一次自动的故障转移操作，它会将与失效主节点是主从关系的其中一个从节点升级为新的主节点， 并且将其他的从节点指向新的主节点。</p>
</li>
<li><p>配置提供者</p>
<p>在Redis Sentinel模式下，客户端应用在初始化时连接的是Sentinel节点集合，从中获取主节点的信息。</p>
</li>
</ul>
<p>3.redis sentinel的工作流程</p>
<p>Sentinel是Redis的高可用解决方案之一</p>
<p>由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求 。如下图：</p>
<p><img src="assert/image-20200921004315563.png" alt="image-20200921004315563"></p>
<p>Sentinel负责监控集群中的所有主、从Redis，当发现主故障时，Sentinel会在所有的从中选一个成为新的主。并且会把其余的从变为新主的从。同时那台有问题的旧主也会变为新主的从，也就是说当旧的主即使恢复时，并不会恢复原来的主身份，而是作为新主的一个从。</p>
<p>在Redis高可用架构中，Sentinel往往不是只有一个，而是有3个或者以上。目的是为了让其更加可靠，毕竟主和从切换角色这个过程还是蛮复杂的。</p>
<h2 id="4、相关概念"><a href="#4、相关概念" class="headerlink" title="4、相关概念"></a>4、相关概念</h2><ul>
<li><p>主观失效</p>
<p>SDOWN（subjectively down）,直接翻译的为”主观”失效,即当前sentinel实例认为某个redis服务为”不可用”状态.</p>
</li>
<li><p>客观失效</p>
<p>ODOWN（objectively down）,直接翻译为”客观”失效,即多个sentinel实例都认为master处于”SDOWN”状态,那么此时master将处于ODOWN,ODOWN可以简单理解为master已经被集群确定为”不可用”,将会开启failover</p>
</li>
</ul>
<h2 id="5、环境说明"><a href="#5、环境说明" class="headerlink" title="5、环境说明"></a>5、环境说明</h2><table>
<thead>
<tr>
<th>主机名称</th>
<th>IP地址</th>
<th>redis版本和角色说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>redis-master</td>
<td>192.168.56.11:6379</td>
<td>redis 5.0.3（主）</td>
</tr>
<tr>
<td>redis-slave01</td>
<td>192.168.56.12:6379</td>
<td>redis 5.0.3（从）</td>
</tr>
<tr>
<td>redis-slave02</td>
<td>192.168.56.13:6379</td>
<td>redis 5.0.3（从）</td>
</tr>
<tr>
<td>redis-master</td>
<td>192.168.56.11:26379</td>
<td>Sentinel01</td>
</tr>
<tr>
<td>redis-slave01</td>
<td>192.168.56.12:26379</td>
<td>Sentinel02</td>
</tr>
<tr>
<td>redis-slave02</td>
<td>192.168.56.13:26379</td>
<td>Sentinel03</td>
</tr>
</tbody>
</table>

<h2 id="6、部署Sentinel"><a href="#6、部署Sentinel" class="headerlink" title="6、部署Sentinel"></a>6、部署Sentinel</h2><p>Sentinel.conf配置文件主要参数解析：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 端口</span><br><span class="line">port 26379</span><br><span class="line"></span><br><span class="line"># 是否后台启动 以守护进程的方式进行</span><br><span class="line">daemonize yes</span><br><span class="line"></span><br><span class="line"># pid文件路径</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis-sentinel.pid</span><br><span class="line"></span><br><span class="line"># 日志文件路径</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;sentinel.log&quot;</span><br><span class="line"></span><br><span class="line"># 定义工作目录</span><br><span class="line">dir &#x2F;tmp</span><br><span class="line"></span><br><span class="line"># 定义Redis主的别名, IP, 端口，这里的2指的是需要至少2个Sentinel认为主Redis挂了才最终会采取下一步行为</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line"># 如果mymaster 30秒内没有响应，则认为其主观失效</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line"></span><br><span class="line"># 如果master重新选出来后，其它slave节点能同时并行从新master同步数据的台数有多少个，显然该值越大，所有slave节点完成同步切换的整体速度越快，但如果此时正好有人在访问这些slave，可能造成读取失败，影响面会更广。最保守的设置为1，同一时间，只能有一台干这件事，这样其它slave还能继续服务，但是所有slave全部完成缓存更新同步的进程将变慢。</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line"># 该参数指定一个时间段，在该时间段内没有实现故障转移成功，则会再一次发起故障转移的操作，单位毫秒</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"># 不允许使用SENTINEL SET设置notification-script和client-reconfig-script。</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br></pre></td></tr></table></figure>

<p>修改三台Sentinel的配置文件，如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@redis-master ~]# grep -Ev &quot;^$|#&quot; &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf </span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &quot;&#x2F;var&#x2F;run&#x2F;redis-sentinel.pid&quot;</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;sentinel.log&quot;</span><br><span class="line">dir &quot;&#x2F;tmp&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.56.11 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line">[root@redis-slave01 ~]# grep -Ev &quot;^$|#&quot; &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf </span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &quot;&#x2F;var&#x2F;run&#x2F;redis-sentinel.pid&quot;</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;sentinel.log&quot;</span><br><span class="line">dir &quot;&#x2F;tmp&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.56.11 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"></span><br><span class="line">[root@redis-slave02 ~]# grep -Ev &quot;^$|#&quot; &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf </span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &quot;&#x2F;var&#x2F;run&#x2F;redis-sentinel.pid&quot;</span><br><span class="line">logfile &quot;&#x2F;var&#x2F;log&#x2F;sentinel.log&quot;</span><br><span class="line">dir &quot;&#x2F;tmp&quot;</span><br><span class="line">sentinel monitor mymaster 192.168.56.11 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br></pre></td></tr></table></figure>

<h2 id="7、启动Sentinel"><a href="#7、启动Sentinel" class="headerlink" title="7、启动Sentinel"></a>7、启动Sentinel</h2><p>启动的顺序：主Redis –&gt; 从Redis –&gt; Sentinel1/2/3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@redis-master ~]# redis-sentinel &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf </span><br><span class="line">[root@redis-master ~]# ps -ef |grep redis</span><br><span class="line">root      1295     1  0 14:03 ?        00:00:06 &#x2F;usr&#x2F;local&#x2F;redis&#x2F;src&#x2F;redis-server 192.168.56.11:6379</span><br><span class="line">root      1407     1  1 14:40 ?        00:00:00 redis-sentinel *:26379 [sentinel]</span><br><span class="line">root      1412  1200  0 14:40 pts&#x2F;1    00:00:00 grep --color&#x3D;auto redis</span><br><span class="line"></span><br><span class="line">[root@redis-slave01 ~]# redis-sentinel &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf </span><br><span class="line">[root@redis-slave01 ~]# ps -ef |grep redis</span><br><span class="line">root      1625     1  0 14:04 ?        00:00:06 &#x2F;usr&#x2F;local&#x2F;redis&#x2F;src&#x2F;redis-server 192.168.56.12:6379</span><br><span class="line">root      1715     1  1 14:41 ?        00:00:00 redis-sentinel *:26379 [sentinel]</span><br><span class="line">root      1720  1574  0 14:41 pts&#x2F;0    00:00:00 grep --color&#x3D;auto redis</span><br><span class="line"></span><br><span class="line">[root@redis-slave02 ~]# redis-sentinel &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf </span><br><span class="line">[root@redis-slave02 ~]# ps -ef |grep redis</span><br><span class="line">root      1628     1  0 14:07 ?        00:00:06 &#x2F;usr&#x2F;local&#x2F;redis&#x2F;src&#x2F;redis-server 192.168.56.13:6379</span><br><span class="line">root      1709     1  0 14:42 ?        00:00:00 redis-sentinel *:26379 [sentinel]</span><br><span class="line">root      1714  1575  0 14:42 pts&#x2F;0    00:00:00 grep --color&#x3D;auto redis</span><br></pre></td></tr></table></figure>

<h2 id="8-、Sentinel-总结"><a href="#8-、Sentinel-总结" class="headerlink" title="8 、Sentinel 总结"></a>8 、Sentinel 总结</h2><h4 id="1、Sentinel的作用："><a href="#1、Sentinel的作用：" class="headerlink" title="1、Sentinel的作用："></a>1、Sentinel的作用：</h4><p>A、Master 状态监测</p>
<p>B、如果Master 异常，则会进行Master-slave 转换，将其中一个Slave作为Master，将之前的Master作为Slave </p>
<p>C、Master-Slave切换后，master_redis.conf、slave_redis.conf和sentinel.conf的内容都会发生改变，即master_redis.conf中会多一行slaveof的配置，sentinel.conf的监控目标会随之调换</p>
<h4 id="2、Sentinel的工作方式"><a href="#2、Sentinel的工作方式" class="headerlink" title="2、Sentinel的工作方式:"></a>2、Sentinel的工作方式:</h4><p>1)：每个Sentinel以每秒钟一次的频率向它所知的Master，Slave以及其他Sentinel实例发送一个PING命令<br>2)：如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值，则这个实例会被 Sentinel 标记为<strong>主观下线</strong>。<br>3)：如果一个Master被标记为主观下线，则正在监视这个Master的所有 Sentinel 要以每秒一次的频率确认Master的确进入了主观下线状态。<br>4)：当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认Master的确进入了主观下线状态， 则Master会被标记为<strong>客观下线</strong><br>5)：在一般情况下， 每个 Sentinel 会以每10 秒一次的频率向它已知的所有Master，Slave发送 INFO 命令<br>6)：当Master被 Sentinel 标记为客观下线时，Sentinel 向下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次<br>7)：若没有足够数量的 Sentinel 同意Master 已经下线， Master 的客观下线状态就会被移除。<br>若 Master 重新向 Sentinel 的 PING 命令返回有效回复， Master 的主观下线状态就会被移除。</p>
<p>主从同步原理：</p>
<p>在Slave启动并连接到Master之后，它将主动发送一个SYNC命令。此后Master将启动后台存盘进程，同时收集所有接收到的用于修改数据集的命令，在后台进程执行完毕后，Master将传送整个数据库文件到Slave，以完成一次完全同步。而Slave服务器在接收到数据库文件数据之后将其存盘并加载到内存中。此后，Master继续将所有已经收集到的修改命令，和新的修改命令依次传送给Slaves，Slave将在本次执行这些数据修改命令，从而达到最终的数据同步。<br>   如果Master和Slave之间的链接出现断连现象，Slave可以自动重连Master，但是在连接成功之后，一次完全同步将被自动执行。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/16/java/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/16/java/%E6%A1%86%E6%9E%B6/mybatis/mybatis%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">mybatis源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-16 13:52:18" itemprop="dateCreated datePublished" datetime="2020-09-16T13:52:18+08:00">2020-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-17 09:34:00" itemprop="dateModified" datetime="2020-09-17T09:34:00+08:00">2020-09-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/java/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/java/%E6%A1%86%E6%9E%B6/mybatis/" itemprop="url" rel="index"><span itemprop="name">mybatis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="从-XML-中构建-SqlSessionFactory"><a href="#从-XML-中构建-SqlSessionFactory" class="headerlink" title="从 XML 中构建 SqlSessionFactory"></a>从 XML 中构建 SqlSessionFactory</h3><p>每个基于 MyBatis 的应用都是以一个 SqlSessionFactory 的实例为核心的。SqlSessionFactory 的实例可以通过 SqlSessionFactoryBuilder 获得。而 SqlSessionFactoryBuilder 则可以从 XML 配置文件或一个预先配置的 Configuration 实例来构建出 SqlSessionFactory 实例。</p>
<p>从 XML 文件中构建 SqlSessionFactory 的实例非常简单，建议使用类路径下的资源文件进行配置。 但也可以使用任意的输入流（InputStream）实例，比如用文件路径字符串或 file:// URL 构造的输入流。MyBatis 包含一个名叫 Resources 的工具类，它包含一些实用方法，使得从类路径或其它位置加载资源文件更加容易。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String resource = <span class="string">&quot;org/mybatis/example/mybatis-config.xml&quot;</span>;</span><br><span class="line">InputStream inputStream = Resources.getResourceAsStream(resource);</span><br><span class="line">SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);</span><br></pre></td></tr></table></figure>

<p>XML 配置文件中包含了对 MyBatis 系统的核心设置，包括获取数据库连接实例的数据源（DataSource）以及决定事务作用域和控制方式的事务管理器（TransactionManager）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">configuration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;driver&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;url&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;username&#125;&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;password&#125;&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;org/mybatis/example/BlogMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//构建了sqlsessoinfactory之后就可以获取 sqlsession</span></span><br><span class="line"><span class="keyword">try</span> (SqlSession session = sqlSessionFactory.openSession()) &#123;</span><br><span class="line">  Blog blog = (Blog) session.selectOne(<span class="string">&quot;org.mybatis.example.BlogMapper.selectBlog&quot;</span>, <span class="number">101</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//生成SqlSessionFactory工厂</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Reader reader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.build((Reader)reader, (String)<span class="keyword">null</span>, (Properties)<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> SqlSessionFactory <span class="title">build</span><span class="params">(Reader reader, String environment, Properties properties)</span> </span>&#123;</span><br><span class="line">        SqlSessionFactory var5;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//解析xml</span></span><br><span class="line">            XMLConfigBuilder parser = <span class="keyword">new</span> XMLConfigBuilder(reader, environment, properties);</span><br><span class="line">            var5 = <span class="keyword">this</span>.build(parser.parse());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error building SqlSession.&quot;</span>, var14);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ErrorContext.instance().reset();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                reader.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException var13) &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> var5;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>XMLConfigBuilder类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">四个属性:</span><br><span class="line">  private boolean parsed;</span><br><span class="line">  private final XPathParser parser;</span><br><span class="line">  private String environment;</span><br><span class="line">  private final ReflectorFactory localReflectorFactory;</span><br><span class="line">  </span><br><span class="line">七个构造方法：</span><br><span class="line">  public XMLConfigBuilder(Reader reader)</span><br><span class="line">  public XMLConfigBuilder(Reader reader, String environment)</span><br><span class="line">  public XMLConfigBuilder(Reader reader, String environment, Properties props) </span><br><span class="line">  public XMLConfigBuilder(InputStream inputStream) </span><br><span class="line">  public XMLConfigBuilder(InputStream inputStream, String environment)</span><br><span class="line">  public XMLConfigBuilder(InputStream inputStream, String environment, Properties props) </span><br><span class="line">  private XMLConfigBuilder(XPathParser parser, String environment, Properties props)</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//上一步所调用的是这个构造函数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">XMLConfigBuilder</span><span class="params">(Reader reader, String environment, Properties props)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> XPathParser(reader, <span class="keyword">true</span>, props, <span class="keyword">new</span> XMLMapperEntityResolver()), environment, props);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>XPathParser类</p>
<p>My Batis 提供的XPathParser 类封装了前面涉及的XPath 、Doc ument 和EntityResolver </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private Document document ; &#x2F;&#x2F; Document对象</span><br><span class="line">private boolean validation; ／／是否开启验证</span><br><span class="line">private EntityResolver entityResolver ; ／／ 用于加载本地DTD文件</span><br><span class="line">private Properties variables; &#x2F;&#x2F; mybatis-config.xml 中＜properties＞ 标签定义的键位对集合</span><br><span class="line">private XPath xpath; &#x2F;&#x2F; XPath 对象</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9%E3%80%81%E7%A9%BF%E9%80%8F%E3%80%81%E5%87%BB%E7%A9%BF/" class="post-title-link" itemprop="url">reids雪崩、穿透、击穿</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-08 11:28:53 / 修改时间：11:34:33" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Redis雪崩"><a href="#Redis雪崩" class="headerlink" title="Redis雪崩"></a>Redis雪崩</h3><p>大量key同一时间点失效，同时又有大量请求打进来，导致流量直接打在DB上，造成DB不可用。</p>
<p>解决方案：</p>
<p>处理缓存雪崩简单，在批量往<strong>Redis</strong>存数据的时候，把每个Key的失效时间都加个随机值就好了，这样可以保证数据不会在同一时间大面积失效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setRedis（Key，value，time + Math.random() * 10000）；</span><br></pre></td></tr></table></figure>

<p>如果<strong>Redis</strong>是集群部署，将热点数据均匀分布在不同的<strong>Redis</strong>库中也能避免全部失效的问题，不过本渣我在生产环境中操作集群的时候，单个服务都是对应的单个<strong>Redis</strong>分片，是为了方便数据的管理，但是也同样有了可能会失效这样的弊端，失效时间随机是个好策略。</p>
<p>或者设置热点数据永远不过期，有更新操作就更新缓存就好了（比如运维更新了首页商品，那你刷下缓存就完事了，不要设置过期时间），电商首页的数据也可以用这个操作，保险。</p>
<h3 id="Redis缓存击穿和穿透"><a href="#Redis缓存击穿和穿透" class="headerlink" title="Redis缓存击穿和穿透"></a>Redis缓存击穿和穿透</h3><p><strong>缓存穿透</strong>是指缓存和数据库中都没有的数据，而用户不断发起请求，我们数据库的 id 都是1开始自增上去的，如发起为id值为 -1 的数据或 id 为特别大不存在的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大，严重会击垮数据库。</p>
<p><strong>缓存击穿</strong>嘛，这个跟<strong>缓存雪崩</strong>有点像，但是又有一点不一样，缓存雪崩是因为大面积的缓存失效，打崩了DB，而缓存击穿不同的是<strong>缓存击穿</strong>是指一个Key非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个Key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个完好无损的桶上凿开了一个洞。</p>
<p>解决方案：</p>
<p>在接口层增加校验，比如用户鉴权校验，参数做校验，不合法的参数直接代码Return，比如：id 做基础校验，id &lt;=0的直接拦截等。</p>
<p>从缓存取不到的数据，在数据库中也没有取到，这时也可以将对应Key的Value对写为null、位置错误、稍后重试这样的值</p>
<p>这样可以防止攻击用户反复用同一个id暴力攻击，但是我们要知道正常用户是不会在单秒内发起这么多次请求的，那网关层<strong>Nginx</strong>本渣我也记得有配置项，可以让运维大大对单个IP每秒访问次数超出阈值的IP都拉黑。</p>
<p><strong>Redis</strong>还有一个高级用法<strong>布隆过滤器（Bloom Filter）</strong>这个也能很好的防止缓存穿透的发生，他的原理也很简单就是利用高效的数据结构和算法快速判断出你这个Key是否在数据库中存在，不存在你return就好了，存在你就去查了DB刷新KV再return。</p>
<p><strong>缓存击穿</strong>的话，设置热点数据永远不过期。或者加上互斥锁就能搞定了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E5%B8%83%E9%9A%86%E8%BF%87%E6%BB%A4%E5%99%A8/" class="post-title-link" itemprop="url">Redis集群之布隆过滤器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-08 11:28:53 / 修改时间：11:33:14" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h1><p><strong>1、数据结构</strong></p>
<p>布隆过滤器是一个BIT数组，本质上是一个数据，所以可以根据下标快速找数据</p>
<p><img src="img%5C1.png"></p>
<h2 id="2、哈希映射"><a href="#2、哈希映射" class="headerlink" title="2、哈希映射"></a>2、哈希映射</h2><p>1、布隆需要记录见过的数据，这里的记录需要通过hash函数对数据进行hash操作，得到数组下标并存储在BIT 数组里记为1。这样的记录一个数据只占用1BIT空间</p>
<p>2、判断是否存在时：给布隆过滤器一个数据，进行hash得到下标，从BIT数组里取数据如果是1 则说明数据存在，如果是0 说明不存在</p>
<h2 id="3、精确度"><a href="#3、精确度" class="headerlink" title="3、精确度"></a>3、精确度</h2><p>hash算法存在碰撞的可能，所以不同的数据可能hash为一个下标数据，故为了提高精确度就需要 使用多个hash 算法标记一个数据，和增大BIT数组的大小</p>
<p>也是因为如此，布隆过滤器判断为【数据存在】 可能数据并不存在，但是如果判断为【数据不存在】那么数据就一定是不存在的。</p>
<h2 id="4、详细介绍"><a href="#4、详细介绍" class="headerlink" title="4、详细介绍"></a>4、详细介绍</h2><p><strong>1.什么是布隆过滤器</strong></p>
<p>​        本质上布隆过滤器是一种数据结构，比较巧妙的<code>概率型数据结构</code>，特点是<code>高效地插入和查询</code>。根据查询结果可以用来告诉你 <code>某样东西一定不存在或者可能存在</code> 这句话是该算法的核心。</p>
<p>相比于传统的 List、Set、Map 等数据结构，它更高效、占用空间更少，但是缺点是其返回的结果是概率性的，而不是确切的，同时布隆过滤器还有一个缺陷就是</p>
<p><code>数据只能插入不能删除</code>。</p>
<h4 id="2、数据如何存入布隆过滤器"><a href="#2、数据如何存入布隆过滤器" class="headerlink" title="2、数据如何存入布隆过滤器"></a>2、数据如何存入布隆过滤器</h4><p>布隆过滤器是<code>由一个很长的bit数组和一系列哈希函数组成的</code>。</p>
<p><strong>数组的每个元素都只占1bit空间，并且每个元素只能为0或1。</strong></p>
<p>布隆过滤器还拥有k个哈希函数，当一个元素加入布隆过滤器时，会使用k个哈希函数对其进行k次计算,得到k个哈希值，并且根据得到的哈希值，在维数组中把对应下标的值置位1。</p>
<p><strong>判断某个数是否在布隆过滤器中，就对该元素进行k次哈希计算，得到的值在位数组中判断每个元素是否都为1，如果每个元素都为1，就说明这个值在布隆过滤器中。</strong></p>
<h4 id="3、布隆过滤器为什么会有误判"><a href="#3、布隆过滤器为什么会有误判" class="headerlink" title="3、布隆过滤器为什么会有误判"></a>3、布隆过滤器为什么会有误判</h4><p>当插入的元素越来越多时，当一个不在布隆过滤器中的元素，经过同样规则的哈希计算之后，得到的值在位数组中查询，有可能这些位置因为其他的元素先被置1了。（hash冲突）</p>
<p>所以布隆过滤器存在误判的情况，但是<strong>如果布隆过滤器判断某个元素不在布隆过滤器中，那么这个值就一定不在</strong>。</p>
<h4 id="4、使用场景"><a href="#4、使用场景" class="headerlink" title="4、使用场景"></a>4、使用场景</h4><ul>
<li><strong>网页爬虫对URL的去重</strong>，避免爬去相同的URL地址。</li>
<li><strong>垃圾邮件过滤</strong>，从数十亿个垃圾邮件列表中判断某邮箱是否是杀垃圾邮箱。</li>
<li><strong>解决数据库缓存击穿</strong>，黑客攻击服务器时，会构建大量不存在于缓存中的key向服务器发起请求，在数据量足够大的时候，频繁的数据库查询会导致挂机。</li>
<li><strong>秒杀系统</strong>，查看用户是否重复购买。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E5%93%A8%E5%85%B5%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E3%80%81%E4%B8%BB%E4%BB%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E5%93%A8%E5%85%B5%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96%E3%80%81%E4%B8%BB%E4%BB%8E/" class="post-title-link" itemprop="url">reids哨兵，持久化，主从</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-09-08 11:28:53" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-09-17 09:21:30" itemprop="dateModified" datetime="2020-09-17T09:21:30+08:00">2020-09-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Redis为什么快"><a href="#Redis为什么快" class="headerlink" title="Redis为什么快"></a>Redis为什么快</h3><p><strong>Redis</strong>采用的是基于内存的采用的是单进程单线程模型的 KV 数据库，由C语言编写，官方提供的数据是可以达到100000+的<strong>QPS（每秒内查询次数）</strong>。</p>
<ul>
<li>完全基于内存，绝大部分请求是纯粹的内存操作，非常快速。它的，数据存在内存中，类似于<strong>HashMap</strong>，<strong>HashMap</strong>的优势就是查找和操作的时间复杂度都是O(1)；</li>
<li>数据结构简单，对数据操作也简单，<strong>Redis</strong>中的数据结构是专门进行设计的；</li>
<li>采用单线程，避免了不必要的上下文切换和竞争条件，也不存在多进程或者多线程导致的切换而消耗 <strong>CPU</strong>，不用去考虑各种锁的问题，不存在加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗；</li>
<li>使用多路I/O复用模型，非阻塞IO；</li>
<li>使用底层模型不同，它们之间底层实现方式以及与客户端之间通信的应用协议不一样，<strong>Redis</strong>直接自己构建了VM 机制 ，因为一般的系统调用系统函数的话，会浪费一定的时间去移动和请求；</li>
</ul>
<h3 id="Redis的持久化"><a href="#Redis的持久化" class="headerlink" title="Redis的持久化"></a>Redis的持久化</h3><p>持久化的话是<strong>Redis</strong>高可用中比较重要的一个环节，因为<strong>Redis</strong>数据在内存的特性，持久化必须得有。</p>
<ul>
<li>RDB：<strong>RDB</strong> 持久化机制，是对 <strong>Redis</strong> 中的数据执行<strong>周期性</strong>的持久化。</li>
<li>AOF：<strong>AOF</strong> 机制对每条写入命令作为日志，以 <strong>append-only</strong> 的模式写入一个日志文件中，因为这个模式是只追加的方式，所以没有任何磁盘寻址的开销，所以很快，有点像Mysql中的<strong>binlog</strong>。</li>
</ul>
<p>两种方式都可以把<strong>Redis</strong>内存中的数据持久化到磁盘上，然后再将这些数据备份到别的地方去，<strong>RDB</strong>更适合做<strong>冷备</strong>，<strong>AOF</strong>更适合做<strong>热备</strong>，比如我杭州的某电商公司有这两个数据，我备份一份到我杭州的节点，再备份一个到上海的，就算发生无法避免的自然灾害，也不会两个地方都一起挂吧，这<strong>灾备</strong>也就是<strong>异地容灾</strong>，地球毁灭他没办法。</p>
<p><strong>tip：两种机制全部开启的时候，Redis在重启的时候会默认使用AOF去重新构建数据，因为AOF的数据是比RDB更完整的。</strong></p>
<p>两种持久化方式的优缺点：</p>
<p><strong>RDB</strong></p>
<h4 id="优点："><a href="#优点：" class="headerlink" title="优点："></a>优点：</h4><p>他会生成多个数据文件，每个数据文件分别都代表了某一时刻<strong>Redis</strong>里面的数据，这种方式，有没有觉得很适合做<strong>冷备</strong>，完整的数据运维设置定时任务，定时同步到远端的服务器，比如阿里的云服务，这样一旦线上挂了，你想恢复多少分钟之前的数据，就去远端拷贝一份之前的数据就好了。</p>
<p><strong>RDB</strong>对<strong>Redis</strong>的性能影响非常小，是因为在同步数据的时候他只是<strong>fork</strong>了一个子进程去做持久化的，而且他在数据恢复的时候速度比<strong>AOF</strong>来的快。</p>
<h4 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h4><p><strong>RDB</strong>都是快照文件，都是默认五分钟甚至更久的时间才会生成一次，这意味着你这次同步到下次同步这中间五分钟的数据都很可能全部丢失掉。<strong>AOF</strong>则最多丢一秒的数据，<strong>数据完整性</strong>上高下立判。</p>
<p>还有就是<strong>RDB</strong>在生成数据快照的时候，如果文件很大，客户端可能会暂停几毫秒甚至几秒，你公司在做秒杀的时候他刚好在这个时候<strong>fork</strong>了一个子进程去生成一个大快照，哦豁，出大问题。</p>
<p><strong>AOF</strong></p>
<h4 id="优点：-1"><a href="#优点：-1" class="headerlink" title="优点："></a>优点：</h4><p>上面提到了，<strong>RDB</strong>五分钟一次生成快照，但是<strong>AOF</strong>是一秒一次去通过一个后台的线程<code>fsync</code>操作，那最多丢这一秒的数据。</p>
<p><strong>AOF</strong>在对日志文件进行操作的时候是以<code>append-only</code>的方式去写的，他只是追加的方式写数据，自然就少了很多磁盘寻址的开销了，写入性能惊人，文件也不容易破损。</p>
<p><strong>AOF</strong>的日志是通过一个叫<strong>非常可读</strong>的方式记录的，这样的特性就适合做<strong>灾难性数据误删除</strong>的紧急恢复了，比如公司的实习生通过<strong>flushall</strong>清空了所有的数据，只要这个时候后台重写还没发生，你马上拷贝一份<strong>AOF</strong>日志文件，把最后一条<strong>flushall</strong>命令删了就完事了。</p>
<h4 id="缺点：-1"><a href="#缺点：-1" class="headerlink" title="缺点："></a>缺点：</h4><p>一样的数据，<strong>AOF</strong>文件比<strong>RDB</strong>还要大。</p>
<p><strong>AOF</strong>开启后，<strong>Redis</strong>支持写的<strong>QPS</strong>会比<strong>RDB</strong>支持写的要低，他不是每秒都要去异步刷新一次日志嘛<strong>fsync</strong>，当然即使这样性能还是很高，我记得<strong>ElasticSearch</strong>也是这样的，异步刷新缓存区的数据去持久化。</p>
<p>单独用<strong>RDB</strong>会丢失很多数据，单独用<strong>AOF</strong>，数据恢复没<strong>RDB</strong>来的快，真出什么事情第一时间用<strong>RDB</strong>恢复，然后<strong>AOF</strong>做数据补全。</p>
<p><strong>哨兵模式：</strong></p>
<p>哨兵必须用三个实例去保证自己的健壮性的，哨兵+主从并<strong>不能保证数据不丢失</strong>，但是可以保证集群的<strong>高可用</strong>。</p>
<p>为啥必须要三个实例呢？我们先看看两个哨兵会咋样。</p>
<p>master宕机了 s1和s2两个哨兵只要有一个认为你宕机了就切换了，并且会选举出一个哨兵去执行故障，但是这个时候也需要大多数哨兵都是运行的。</p>
<p>那这样有啥问题呢？M1宕机了，S1没挂那其实是OK的，但是整个机器都挂了呢？哨兵就只剩下S2个裸了，没有哨兵去允许故障转移了，虽然另外一个机器上还有R1，但是故障转移就是不执行。</p>
<p>经典的哨兵集群是这样的：</p>
<p>M1所在的机器挂了，哨兵还有两个，两个人一看他不是挂了嘛，那我们就选举一个出来执行故障转移不就好了。</p>
<p>哨兵组件的主要功能：</p>
<ul>
<li>集群监控：负责监控 Redis master 和 slave 进程是否正常工作。</li>
<li>消息通知：如果某个 <strong>Redis</strong> 实例有故障，那么哨兵负责发送消息作为报警通知给管理员。</li>
<li>故障转移：如果 master node 挂掉了，会自动转移到 slave node 上。</li>
<li>配置中心：如果故障转移发生了，通知 client 客户端新的 master 地址。</li>
</ul>
<h3 id="主从之间的数据同步"><a href="#主从之间的数据同步" class="headerlink" title="主从之间的数据同步"></a>主从之间的数据同步</h3><p>前面提到了单机<strong>QPS</strong>是有上限的，而且<strong>Redis</strong>的特性就是必须支撑读高并发的，那你一台机器又读又写，一般是顶不住的，但是你让这个master机器去写，数据同步给别的slave机器，他们都拿去读，分发掉大量的请求那是不是好很多，而且扩容的时候还可以轻松实现水平扩容。</p>
<p>你启动一台slave 的时候，他会发送一个<strong>psync</strong>命令给master ，如果是这个slave第一次连接到master，他会触发一个全量复制。master就会启动一个线程，生成<strong>RDB</strong>快照，还会把新的写请求都缓存在内存中，<strong>RDB</strong>文件生成后，master会将这个<strong>RDB</strong>发送给slave的，slave拿到之后做的第一件事情就是写进本地的磁盘，然后加载进内存，然后master会把内存里面缓存的那些新命名都发给slave。</p>
<h3 id="内存淘汰机制"><a href="#内存淘汰机制" class="headerlink" title="内存淘汰机制"></a>内存淘汰机制</h3><p>redis的过期策略： 定期删除 +　惰性删除</p>
<p><strong>定期删除</strong>：默认100ms就随机抽一些设置了过期时间的key，去检查是否过期，过期了就删了</p>
<p><strong>惰性删除</strong>：等用户主动查询后，确认过期了就删除。</p>
<p>存在定期没删除，也没查询：</p>
<p><strong>内存淘汰机制</strong>！</p>
<p>官网上给到的内存淘汰机制是以下几个：</p>
<ul>
<li><p><strong>noeviction</strong>:返回错误当内存限制达到并且客户端尝试执行会让更多内存被使用的命令（大部分的写入指令，但DEL和几个例外）</p>
</li>
<li><p><strong>allkeys-lru</strong>: 尝试回收最少使用的键（LRU），使得新添加的数据有空间存放。</p>
</li>
<li><p><strong>volatile-lru</strong>: 尝试回收最少使用的键（LRU），但仅限于在过期集合的键,使得新添加的数据有空间存放。</p>
</li>
<li><p><strong>allkeys-random</strong>: 回收随机的键使得新添加的数据有空间存放。</p>
</li>
<li><p><strong>volatile-random</strong>: 回收随机的键使得新添加的数据有空间存放，但仅限于在过期集合的键。</p>
</li>
<li><p><strong>volatile-ttl</strong>: 回收在过期集合的键，并且优先回收存活时间（TTL）较短的键,使得新添加的数据有空间存放。</p>
<p>如果没有键满足回收的前提条件的话，策略<strong>volatile-lru</strong>, <strong>volatile-random</strong>以及<strong>volatile-ttl</strong>就和noeviction 差不多了。</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E3%80%81%E5%B9%B6%E5%8F%91%E7%AB%9E%E4%BA%89%E3%80%81%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E3%80%81%E5%B9%B6%E5%8F%91%E7%AB%9E%E4%BA%89%E3%80%81%E5%8F%8C%E5%86%99%E4%B8%80%E8%87%B4%E6%80%A7/" class="post-title-link" itemprop="url">Redis分布式锁、并发、双写一致性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-08 11:28:53 / 修改时间：11:35:15" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="redis几种数据类型使用场景"><a href="#redis几种数据类型使用场景" class="headerlink" title="redis几种数据类型使用场景"></a>redis几种数据类型使用场景</h3><p><strong>String：</strong></p>
<p>这是最简单的类型，就是普通的 set 和 get，做简单的 KV 缓存。</p>
<p>但是真实的开发环境中，很多人可能会把很多比较复杂的结构也统一转成<strong>String</strong>去存储使用，比如有的仔他就喜欢把对象或者<strong>List</strong>转换为<strong>JSONString</strong>进行存储，拿出来再反序列话啥的。</p>
<p><strong>String</strong>的实际应用场景比较广泛的有：</p>
<ul>
<li><strong>缓存功能：String</strong>字符串是最常用的数据类型，不仅仅是<strong>Redis</strong>，各个语言都是最基本类型，因此，利用<strong>Redis</strong>作为缓存，配合其它数据库作为存储层，利用<strong>Redis</strong>支持高并发的特点，可以大大加快系统的读写速度、以及降低后端数据库的压力。</li>
<li><strong>计数器：</strong>许多系统都会使用<strong>Redis</strong>作为系统的实时计数器，可以快速实现计数和查询的功能。而且最终的数据结果可以按照特定的时间落地到数据库或者其它存储介质当中进行永久保存。</li>
<li><strong>共享用户Session：</strong>用户重新刷新一次界面，可能需要访问一下数据进行重新登录，或者访问页面缓存<strong>Cookie</strong>，但是可以利用<strong>Redis</strong>将用户的<strong>Session</strong>集中管理，在这种模式只需要保证<strong>Redis</strong>的高可用，每次用户<strong>Session</strong>的更新和获取都可以快速完成。大大提高效率。</li>
</ul>
<p><strong>Hash：</strong></p>
<p>这个是类似 <strong>Map</strong> 的一种结构，这个一般就是可以将结构化的数据，比如一个对象（前提是<strong>这个对象没嵌套其他的对象</strong>）给缓存在 <strong>Redis</strong> 里，然后每次读写缓存的时候，可以就操作 <strong>Hash</strong> 里的<strong>某个字段</strong>。</p>
<p>但是这个的场景其实还是多少单一了一些，因为现在很多对象都是比较复杂的，比如你的商品对象可能里面就包含了很多属性，其中也有对象。我自己使用的场景用得不是那么多。</p>
<p><strong>List：</strong></p>
<p><strong>List</strong> 是有序列表，这个还是可以玩儿出很多花样的。</p>
<p>比如可以通过 <strong>List</strong> 存储一些列表型的数据结构，类似粉丝列表、文章的评论列表之类的东西。</p>
<p>比如可以通过 <strong>lrange</strong> 命令，读取某个闭区间内的元素，可以基于 <strong>List</strong> 实现分页查询，这个是很棒的一个功能，基于 <strong>Redis</strong> 实现简单的高性能分页，可以做类似微博那种下拉不断分页的东西，性能高，就一页一页走。</p>
<p>比如可以搞个简单的消息队列，从 <strong>List</strong> 头怼进去，从 <strong>List</strong> 屁股那里弄出来。</p>
<p><strong>List</strong>本身就是我们在开发过程中比较常用的数据结构了，热点数据更不用说了。</p>
<ul>
<li><p><strong>消息队列：Redis</strong>的链表结构，可以轻松实现阻塞队列，可以使用左进右出的命令组成来完成队列的设计。比如：数据的生产者可以通过<strong>Lpush</strong>命令从左边插入数据，多个数据消费者，可以使用<strong>BRpop</strong>命令阻塞的“抢”列表尾部的数据。</p>
</li>
<li><p>文章列表或者数据分页展示的应用。</p>
<p>比如，我们常用的博客网站的文章列表，当用户量越来越多时，而且每一个用户都有自己的文章列表，而且当文章多时，都需要分页展示，这时可以考虑使用<strong>Redis</strong>的列表，列表不但有序同时还支持按照范围内获取元素，可以完美解决分页查询功能。大大提高查询效率。</p>
</li>
</ul>
<p><strong>Set：</strong></p>
<p><strong>Set</strong> 是无序集合，会自动去重的那种。</p>
<p>直接基于 <strong>Set</strong> 将系统里需要去重的数据扔进去，自动就给去重了，如果你需要对一些数据进行快速的全局去重，你当然也可以基于 <strong>JVM</strong> 内存里的 <strong>HashSet</strong> 进行去重，但是如果你的某个系统部署在多台机器上呢？得基于<strong>Redis</strong>进行全局的 <strong>Set</strong> 去重。</p>
<p>可以基于 <strong>Set</strong> 玩儿交集、并集、差集的操作，比如交集吧，我们可以把两个人的好友列表整一个交集，看看俩人的共同好友是谁？对吧。</p>
<p>反正这些场景比较多，因为对比很快，操作也简单，两个查询一个<strong>Set</strong>搞定。</p>
<p><strong>Sorted Set：</strong></p>
<p><strong>Sorted set</strong> 是排序的 <strong>Set</strong>，去重但可以排序，写进去的时候给一个分数，自动根据分数排序。</p>
<p>有序集合的使用场景与集合类似，但是set集合不是自动有序的，而<strong>Sorted set</strong>可以利用分数进行成员间的排序，而且是插入时就排序好。所以当你需要一个有序且不重复的集合列表时，就可以选择<strong>Sorted set</strong>数据结构作为选择方案。</p>
<ul>
<li><p>排行榜：有序集合经典使用场景。例如视频网站需要对用户上传的视频做排行榜，榜单维护可能是多方面：按照时间、按照播放量、按照获得的赞数等。</p>
</li>
<li><p>用<strong>Sorted Sets</strong>来做带权重的队列，比如普通消息的score为1，重要消息的score为2，然后工作线程可以选择按score的倒序来获取工作任务。让重要的任务优先执行。</p>
<p>微博热搜榜，就是有个后面的热度值，前面就是名称</p>
</li>
</ul>
<h3 id="并发给redis带来的问题"><a href="#并发给redis带来的问题" class="headerlink" title="并发给redis带来的问题"></a>并发给redis带来的问题</h3><p>系统A、B、C三个系统，分别去操作<strong>Redis</strong>的同一个Key，本来顺序是1，2，3是正常的，但是因为系统A网络突然抖动了一下，B，C在他前面操作了<strong>Redis</strong>，这样数据不就错了么。</p>
<p>就好比下单，支付，退款三个顺序你变了，你先退款，再下单，再支付，那流程就会失败，那数据不就乱了？你订单还没生成你却支付，退款了？明显走不通了，这在线上是很恐怖的事情。</p>
<p><strong>解决方案</strong></p>
<p>某个时刻，多个系统实例都去更新某个 key。可以基于 <strong>Zookeeper</strong> 实现分布式锁。每个系统通过 <strong>Zookeeper</strong> 获取分布式锁，确保同一时间，只能有一个系统实例在操作某个 Key，别人都不允许读和写。</p>
<p>你要写入缓存的数据，都是从 <strong>MySQL</strong> 里查出来的，都得写入 <strong>MySQL</strong> 中，写入<strong>MySQL</strong> 中的时候必须保存一个时间戳，从 <strong>MySQL</strong> 查出来的时候，时间戳也查出来。</p>
<p>每次要<strong>写之前，先判断</strong>一下当前这个 Value 的时间戳是否比缓存里的 Value 的时间戳要新。如果是的话，那么可以写，否则，就不能用旧的数据覆盖新的数据。</p>
<h3 id="redis和数据库数据一致性的问题"><a href="#redis和数据库数据一致性的问题" class="headerlink" title="redis和数据库数据一致性的问题"></a>redis和数据库数据一致性的问题</h3><p>一般来说，如果允许缓存可以稍微的跟数据库偶尔有不一致的情况，也就是说如果你的系统<strong>不是严格要求</strong> “缓存+数据库” 必须保持一致性的话，最好不要做这个方案，即：<strong>读请求和写请求串行化</strong>，串到一个<strong>内存队列</strong>里去。</p>
<p>串行化可以保证一定不会出现不一致的情况，但是它也会导致系统的吞吐量大幅度降低，用比正常情况下多几倍的机器去支撑线上的一个请求。</p>
<p>把一些列的操作都放到队列里面，顺序肯定不会乱，但是并发高了，这队列很容易阻塞，反而会成为整个系统的弱点。</p>
<p>最经典的缓存+数据库读写的模式，就是 <strong>Cache Aside Pattern</strong></p>
<ul>
<li>读的时候，先读缓存，缓存没有的话，就读数据库，然后取出数据后放入缓存，同时返回响应。</li>
<li>更新的时候，<strong>先更新数据库，然后再删除缓存</strong>。</li>
</ul>
<h3 id="为什么是删除缓存，而不是更新缓存"><a href="#为什么是删除缓存，而不是更新缓存" class="headerlink" title="为什么是删除缓存，而不是更新缓存"></a>为什么是删除缓存，而不是更新缓存</h3><p>原因很简单，很多时候，在复杂点的缓存场景，缓存不单单是数据库中直接取出来的值。</p>
<p>比如可能更新了某个表的一个字段，然后其对应的缓存，是需要查询另外两个表的数据并进行运算，才能计算出缓存最新的值的。</p>
<p>另外更新缓存的代价有时候是很高的。是不是说，每次修改数据库的时候，都一定要将其对应的缓存更新一份？也许有的场景是这样，但是对于<strong>比较复杂的缓存数据计算的场景</strong>，就不是这样了。如果你频繁修改一个缓存涉及的多个表，缓存也频繁更新。但是问题在于，<strong>这个缓存到底会不会被频繁访问到？</strong></p>
<p>举个栗子：一个缓存涉及的表的字段，在 1 分钟内就修改了 20 次，或者是 100 次，那么缓存更新 20 次、100 次；但是这个缓存在 1 分钟内只被读取了 1 次，有<strong>大量的冷数据</strong>。</p>
<p>实际上，如果你只是删除缓存的话，那么在 1 分钟内，这个缓存不过就重新计算一次而已，开销大幅度降低。<strong>用到缓存才去算缓存。</strong></p>
<p>其实删除缓存，而不是更新缓存，就是一个 Lazy 计算的思想，不要每次都重新做复杂的计算，不管它会不会用到，而是让它到需要被使用的时候再重新计算。</p>
<p>像 <strong>Mybatis</strong>，<strong>Hibernate</strong>，都有懒加载思想。查询一个部门，部门带了一个员工的<strong>List</strong>，没有必要说每次查询部门，都里面的 1000 个员工的数据也同时查出来啊。80% 的情况，查这个部门，就只是要访问这个部门的信息就可以了。先查部门，同时要访问里面的员工，那么这个时候只有在你要访问里面的员工的时候，才会去数据库里面查询 1000 个员工。</p>
<h3 id="Redis-和-Memcached-有啥区别。"><a href="#Redis-和-Memcached-有啥区别。" class="headerlink" title="Redis 和 Memcached 有啥区别。"></a>Redis 和 Memcached 有啥区别。</h3><p><strong>Redis</strong> 支持复杂的数据结构：</p>
<p><strong>Redis</strong> 相比 <strong>Memcached</strong> 来说，拥有更多的数据结构，能支持更丰富的数据操作。如果需要缓存能够支持更复杂的结构和操作， <strong>Redis</strong> 会是不错的选择。</p>
<p><strong>Redis</strong> 原生支持集群模式：</p>
<p>在 redis3.x 版本中，便能支持 <strong>Cluster</strong> 模式，而 <strong>Memcached</strong> 没有原生的集群模式，需要依靠客户端来实现往集群中分片写入数据。</p>
<p>性能对比：</p>
<p>由于 <strong>Redis</strong> 只使用单核，而 <strong>Memcached</strong> 可以使用多核，所以平均每一个核上 <strong>Redis</strong>在存储小数据时比 <strong>Memcached</strong> 性能更高。而在 100k 以上的数据中，<strong>Memcached</strong> 性能要高于 <strong>Redis</strong>，虽然 <strong>Redis</strong> 最近也在存储大数据的性能上进行优化，但是比起<strong>Remcached</strong>，还是稍有逊色。</p>
<h3 id="Redis-的线程模型"><a href="#Redis-的线程模型" class="headerlink" title="Redis 的线程模型"></a>Redis 的线程模型</h3><p><strong>Redis</strong> 内部使用文件事件处理器 <code>file event handler</code>，这个文件事件处理器是单线程的，所以 <strong>Redis</strong> 才叫做单线程的模型。它采用 IO 多路复用机制同时监听多个<strong>Socket</strong>，根据 <strong>Socket</strong> 上的事件来选择对应的事件处理器进行处理。</p>
<p>文件事件处理器的结构包含 4 个部分：</p>
<ul>
<li>多个 <strong>Socket</strong></li>
<li>IO 多路复用程序</li>
<li>文件事件分派器</li>
<li>事件处理器（连接应答处理器、命令请求处理器、命令回复处理器）</li>
</ul>
<p>多个 <strong>Socket</strong> 可能会并发产生不同的操作，每个操作对应不同的文件事件，但是 IO 多路复用程序会监听多个 <strong>Socket</strong>，会将 <strong>Socket</strong> 产生的事件放入队列中排队，事件分派器每次从队列中取出一个事件，把该事件交给对应的事件处理器进行处理。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/Redis%E9%9B%86%E7%BE%A4%E4%B9%8B%E4%B8%BB%E4%BB%8E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/Redis%E9%9B%86%E7%BE%A4%E4%B9%8B%E4%B8%BB%E4%BB%8E/" class="post-title-link" itemprop="url">Redis集群之主从</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-08 11:28:53 / 修改时间：11:33:02" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="主从概念"><a href="#主从概念" class="headerlink" title="主从概念"></a>主从概念</h3><ul>
<li>一个master可以拥有多个slave，一个slave又可以拥有多个slave，如此下去，形成了强大的多级服务器集群架构</li>
<li>master用来写数据，slave用来读数据，经统计：网站的读写比率是10:1</li>
<li>通过主从配置可以实现读写分离</li>
<li>master和slave都是一个redis实例(redis服务)</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">master节点                  192.168.30.128</span><br><span class="line"></span><br><span class="line">slave节点                   192.168.30.129</span><br><span class="line"></span><br><span class="line">slave节点                   192.168.30.130</span><br></pre></td></tr></table></figure>

<p>修改配置</p>
<p>192.168.30.128</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bind 192.168.30.128               #监听ip，多个ip用空格分隔</span><br><span class="line">daemonize yes               #允许后台启动</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.log&quot;                #日志路径</span><br><span class="line">dir &#x2F;data&#x2F;redis                 #数据库备份文件存放目录</span><br><span class="line">masterauth 123456               #slave连接master密码，master可省略</span><br><span class="line">requirepass 123456              #设置master连接密码，slave可省略</span><br><span class="line"></span><br><span class="line">appendonly yes                  #在&#x2F;data&#x2F;redis&#x2F;目录生成appendonly.aof文件，将每一次写操作请求都追加到appendonly.aof 文件中</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>192.168.30.129</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bind 192.168.30.129</span><br><span class="line">daemonize yes</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line">replicaof 192.168.30.128 6379</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>

<p>192.168.30.130</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bind 192.168.30.130</span><br><span class="line">daemonize yes</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line">replicaof 192.168.30.128 6379</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>

<p>在master节点写入的数据，很快就同步到slave节点上，而且在slave节点上无法写入数据。</p>
<h3 id="Redis主从复制原理总结"><a href="#Redis主从复制原理总结" class="headerlink" title="Redis主从复制原理总结"></a>Redis主从复制原理总结</h3><p>和Mysql主从复制的原因一样，Redis虽然读取写入的速度都特别快，但是也会产生读压力特别大的情况。为了分担读压力，Redis支持主从复制，Redis的主从结构可以采用一主多从或者级联结构，Redis主从复制可以根据是否是全量分为全量同步和增量同步。</p>
<h4 id="全量同步"><a href="#全量同步" class="headerlink" title="全量同步"></a>全量同步</h4><p>Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下： </p>
<ul>
<li><p>从服务器连接主服务器，发送SYNC命令； </p>
</li>
<li><p>主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令； </p>
</li>
<li><p>主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令； </p>
</li>
<li><p>从服务器收到快照文件后丢弃所有旧数据，载入收到的快照； </p>
</li>
<li><p>主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令； </p>
</li>
<li><p>从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；</p>
</li>
</ul>
<p><strong>增量同步</strong><br>Redis增量复制是指Slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。<br>增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。</p>
<p><strong>Redis主从同步策略</strong><br>主从刚刚连接的时候，进行全量同步；全同步结束后，进行增量同步。当然，如果有需要，slave 在任何时候都可以发起全量同步。redis 策略是，无论如何，首先会尝试进行增量同步，如不成功，要求从机进行全量同步。</p>
<p><strong>注意点</strong><br>如果多个Slave断线了，需要重启的时候，因为只要Slave启动，就会发送sync请求和主机全量同步，当多个同时出现的时候，可能会导致Master IO剧增宕机。</p>
<p>Redis主从复制的配置十分简单，它可以使从服务器是主服务器的完全拷贝。需要清楚Redis主从复制的几点重要内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1）Redis使用异步复制。但从Redis 2.8开始，从服务器会周期性的应答从复制流中处理的数据量。</span><br><span class="line">2）一个主服务器可以有多个从服务器。</span><br><span class="line">3）从服务器也可以接受其他从服务器的连接。除了多个从服务器连接到一个主服务器之外，多个从服务器也可以连接到一个从服务器上，形成一个图状结构。</span><br><span class="line">4）Redis主从复制不阻塞主服务器端。也就是说当若干个从服务器在进行初始同步时，主服务器仍然可以处理请求。</span><br><span class="line">5）主从复制也不阻塞从服务器端。当从服务器进行初始同步时，它使用旧版本的数据来应对查询请求，假设你在redis.conf配置文件是这么配置的。否则的话，你可以配置当复制流关闭时让从服务器给客户端返回一个错误。但是，当初始同步完成后，需要删除旧的数据集和加载新的数据集，在这个短暂的时间内，从服务器会阻塞连接进来的请求。</span><br><span class="line">6）主从复制可以用来增强扩展性，使用多个从服务器来处理只读的请求（比如，繁重的排序操作可以放到从服务器去做），也可以简单的用来做数据冗余。</span><br><span class="line">7）使用主从复制可以为主服务器免除把数据写入磁盘的消耗：在主服务器的redis.conf文件中配置“避免保存”（注释掉所有“保存“命令），然后连接一个配置为“进行保存”的从服务器即可。但是这个配置要确保主服务器不会自动重启（要获得更多信息请阅读下一段）</span><br></pre></td></tr></table></figure>

<h4 id="主从复制的一些特点"><a href="#主从复制的一些特点" class="headerlink" title="主从复制的一些特点"></a>主从复制的一些特点</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1）采用异步复制；</span><br><span class="line">2）一个主redis可以含有多个从redis；</span><br><span class="line">3）每个从redis可以接收来自其他从redis服务器的连接；</span><br><span class="line">4）主从复制对于主redis服务器来说是非阻塞的，这意味着当从服务器在进行主从复制同步过程中，主redis仍然可以处理外界的访问请求；</span><br><span class="line">5）主从复制对于从redis服务器来说也是非阻塞的，这意味着，即使从redis在进行主从复制过程中也可以接受外界的查询请求，只不过这时候从redis返回的是以前老的数据，如果你不想这样，那么在启动redis时，可以在配置文件中进行设置，那么从redis在复制同步过程中来自外界的查询请求都会返回错误给客户端；（虽然说主从复制过程中对于从redis是非阻塞的，但是当从redis从主redis同步过来最新的数据后还需要将新数据加载到内存中，在加载到内存的过程中是阻塞的，在这段时间内的请求将会被阻，但是即使对于大数据集，加载到内存的时间也是比较多的）；</span><br><span class="line">6）主从复制提高了redis服务的扩展性，避免单个redis服务器的读写访问压力过大的问题，同时也可以给为数据备份及冗余提供一种解决方案；</span><br><span class="line">7）为了编码主redis服务器写磁盘压力带来的开销，可以配置让主redis不在将数据持久化到磁盘，而是通过连接让一个配置的从redis服务器及时的将相关数据持久化到磁盘，不过这样会存在一个问题，就是主redis服务器一旦重启，因为主redis服务器数据为空，这时候通过主从同步可能导致从redis服务器上的数据也被清空；</span><br></pre></td></tr></table></figure>

<p><strong>Redis大概主从同步是怎么实现的？</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">全量同步：</span><br><span class="line">master服务器会开启一个后台进程用于将redis中的数据生成一个rdb文件，与此同时，服务器会缓存所有接收到的来自客户端的写命令（包含增、删、改），当后台保存进程</span><br><span class="line">处理完毕后，会将该rdb文件传递给slave服务器，而slave服务器会将rdb文件保存在磁盘并通过读取该文件将数据加载到内存，在此之后master服务器会将在此期间缓存的命令通过redis传输协议发送给slave服务器，然后slave服务器将这些命令依次作用于自己本地的数据集上最终达到数据的一致性。</span><br><span class="line"> </span><br><span class="line">部分同步：</span><br><span class="line">从redis 2.8版本以前，并不支持部分同步，当主从服务器之间的连接断掉之后，master服务器和slave服务器之间都是进行全量数据同步，但是从redis 2.8开始，即使主从连接中途断掉，也不需要进行全量同步，因为从这个版本开始融入了部分同步的概念。部分同步的实现依赖于在master服务器内存中给每个slave服务器维护了一份同步日志和同步标识，每个slave服务器在跟master服务器进行同步时都会携带自己的同步标识和上次同步的最后位置。当主从连接断掉之后，slave服务器隔断时间（默认1s）主动尝试和master服务器进行连接，如果从服务器携带的偏移量标识还在master服务器上的同步备份日志中，那么就从slave发送的偏移量开始继续上次的同步操作，如果slave发送的偏移量已经不再master的同步备份日志中（可能由于主从之间断掉的时间比较长或者在断掉的短暂时间内master服务器接收到大量的写操作），则必须进行一次全量更新。在部分同步过程中，master会将本地记录的同步备份日志中记录的指令依次发送给slave服务器从而达到数据一致。</span><br></pre></td></tr></table></figure>

<h4 id="主从同步中需要注意几个问题"><a href="#主从同步中需要注意几个问题" class="headerlink" title="主从同步中需要注意几个问题"></a><strong>主从同步中需要注意几个问题</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1）在上面的全量同步过程中，master会将数据保存在rdb文件中然后发送给slave服务器，但是如果master上的磁盘空间有限怎么办呢？那么此时全部同步对于master来说将是一份十分有压力的操作了。此时可以通过无盘复制来达到目的，由master直接开启一个socket将rdb文件发送给slave服务器。（无盘复制一般应用在磁盘空间有限但是网络状态良好的情况下）</span><br><span class="line"> </span><br><span class="line">2）主从复制结构，一般slave服务器不能进行写操作，但是这不是死的，之所以这样是为了更容易的保证主和各个从之间数据的一致性，如果slave服务器上数据进行了修改，那么要保证所有主从服务器都能一致，可能在结构上和处理逻辑上更为负责。不过你也可以通过配置文件让从服务器支持写操作。（不过所带来的影响还得自己承担哦。。。）</span><br><span class="line"> </span><br><span class="line">3）主从服务器之间会定期进行通话，但是如果master上设置了密码，那么如果不给slave设置密码就会导致slave不能跟master进行任何操作，所以如果你的master服务器上有密码，那么也给slave相应的设置一下密码吧（通过设置配置文件中的masterauth）;</span><br><span class="line"> </span><br><span class="line">4）关于slave服务器上过期键的处理，由master服务器负责键的过期删除处理，然后将相关删除命令已数据同步的方式同步给slave服务器，slave服务器根据删除命令删除本地的key。</span><br></pre></td></tr></table></figure>



<h4 id="当主服务器不进行持久化时复制的安全性"><a href="#当主服务器不进行持久化时复制的安全性" class="headerlink" title="当主服务器不进行持久化时复制的安全性"></a>当主服务器不进行持久化时复制的安全性</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在进行主从复制设置时，强烈建议在主服务器上开启持久化，当不能这么做时，比如考虑到延迟的问题，应该将实例配置为避免自动重启。</span><br><span class="line"> </span><br><span class="line">为什么不持久化的主服务器自动重启非常危险呢？</span><br><span class="line">为了更好的理解这个问题，看下面这个失败的例子，其中主服务器和从服务器中数据库都被删除了。</span><br><span class="line"> </span><br><span class="line">设置节点A为主服务器，关闭持久化，节点B和C从节点A复制数据。</span><br><span class="line">这时出现了一个崩溃，但Redis具有自动重启系统，重启了进程，因为关闭了持久化，节点重启后只有一个空的数据集。</span><br><span class="line">节点B和C从节点A进行复制，现在节点A是空的，所以节点B和C上的复制数据也会被删除。</span><br><span class="line">当在高可用系统中使用Redis Sentinel，关闭了主服务器的持久化，并且允许自动重启，这种情况是很危险的。</span><br><span class="line">比如主服务器可能在很短的时间就完成了重启，以至于Sentinel都无法检测到这次失败，那么上面说的这种失败的情况就发生了。</span><br><span class="line"> </span><br><span class="line">如果数据比较重要，并且在使用主从复制时关闭了主服务器持久化功能的场景中，都应该禁止实例自动重启。</span><br></pre></td></tr></table></figure>



<h3 id="Redis主从复制是如何工作的"><a href="#Redis主从复制是如何工作的" class="headerlink" title="Redis主从复制是如何工作的"></a><strong>Redis主从复制是如何工作的</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">如果设置了一个从服务器，在连接时它发送了一个SYNC命令，不管它是第一次连接还是再次连接都没有关系。</span><br><span class="line"> </span><br><span class="line">然后主服务器开始后台存储，并且开始缓存新连接进来的修改数据的命令。当后台存储完成后，主服务器把数据文件发送到从服务器，从服务器将其保存在磁盘上，然后加载到内存中。然后主服务器把刚才缓存的命令发送到从服务器。这是作为命令流来完成的，并且和Redis协议本身格式相同。</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">当主从服务器之间的连接由于某些原因断开时，从服务器可以自动进行重连接。当有多个从服务器同时请求同步时，主服务器只进行一个后台存储。</span><br><span class="line"> </span><br><span class="line">当连接断开又重新连上之后，一般都会进行一个完整的重新同步，但是从Redis2.8开始，只重新同步一部分也可以。</span><br></pre></td></tr></table></figure>



<h3 id="部分重新同步"><a href="#部分重新同步" class="headerlink" title="部分重新同步"></a>部分重新同步</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">从Redis 2.8开始，如果遭遇连接断开，重新连接之后可以从中断处继续进行复制，而不必重新同步。</span><br><span class="line"> </span><br><span class="line">它的工作原理是这样：</span><br><span class="line">主服务器端为复制流维护一个内存缓冲区（in-memory backlog）。主从服务器都维护一个复制偏移量（replication offset）和master run id ，当连接断开时，从服务器会重新连接上主服务器，然后请求继续复制，假如主从服务器的两个master run id相同，并且指定的偏移量在内存缓冲区中还有效，复制就会从上次中断的点开始继续。如果其中一个条件不满足，就会进行完全重新同步（在2.8版本之前就是直接进行完全重新同步）。因为主运行id不保存在磁盘中，如果从服务器重启了的话就只能进行完全同步了。</span><br><span class="line"> </span><br><span class="line">部分重新同步这个新特性内部使用PSYNC命令，旧的实现中使用SYNC命令。Redis2.8版本可以检测出它所连接的服务器是否支持PSYNC命令，不支持的话使用SYNC命令。</span><br></pre></td></tr></table></figure>



<h4 id="无磁盘复制"><a href="#无磁盘复制" class="headerlink" title="无磁盘复制"></a>无磁盘复制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">通常来讲，一个完全重新同步需要在磁盘上创建一个RDB文件，然后加载这个文件以便为从服务器发送数据。</span><br><span class="line"> </span><br><span class="line">如果使用比较低速的磁盘，这种操作会给主服务器带来较大的压力。Redis从2.8.18版本开始尝试支持无磁盘的复制。</span><br><span class="line">使用这种设置时，子进程直接将RDB通过网络发送给从服务器，不使用磁盘作为中间存储。</span><br></pre></td></tr></table></figure>



<h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">主从复制的配置十分简单：把下面这行加入到从服务器的配置文件中即可。</span><br><span class="line">slaveof 192.168.1.1 6379</span><br><span class="line"> </span><br><span class="line">当然你需要把其中的192.168.1.1 6379替换为你自己的主服务器IP（或者主机名hostname）和端口。另外你可以调用SLAVEOF命令，主服务器就会开始与从服务器同步。</span><br><span class="line"> </span><br><span class="line">关于部分重新同步，还有一些针对复制内存缓冲区的优化参数。查看Redis介质中的Redis.conf示例获得更多信息。</span><br><span class="line"> </span><br><span class="line">使用repl-diskless-sync配置参数来启动无磁盘复制。使用repl-diskless-sync-delay 参数来配置传输开始的延迟时间，以便等待</span><br><span class="line">更多的从服务器连接上来。查看Redis介质中的Redis.conf示例获得更多信息。</span><br></pre></td></tr></table></figure>



<h4 id="只读从服务器"><a href="#只读从服务器" class="headerlink" title="只读从服务器"></a>只读从服务器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">从Redis 2.6开始，从服务器支持只读模式，并且是默认模式。这个行为是由Redis.conf文件中的slave-read-only 参数控制的，可以在运行中通过CONFIG SET来启用或者禁用。</span><br><span class="line"> </span><br><span class="line">只读的从服务器会拒绝所有写命令，所以对从服务器不会有误写操作。但这不表示可以把从服务器实例暴露在危险的网络环境下，因为像DEBUG或者CONFIG这样的管理命令还是可以运行的。不过你可以通过使用rename-command命令来为这些命令改名来增加安全性。</span><br><span class="line"> </span><br><span class="line">你可能想知道为什么只读限制还可以被还原，使得从服务器还可以进行写操作。虽然当主从服务器进行重新同步或者从服务器重启后，这些写操作都会失效，还是有一些使用场景会想从服务器中写入临时数据的，但将来这个特性可能会被去掉。</span><br></pre></td></tr></table></figure>



<h4 id="限制有N个以上从服务器才允许写入"><a href="#限制有N个以上从服务器才允许写入" class="headerlink" title="限制有N个以上从服务器才允许写入"></a>限制有N个以上从服务器才允许写入</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">从Redis 2.8版本开始，可以配置主服务器连接N个以上从服务器才允许对主服务器进行写操作。但是，因为Redis使用的是异步主从复制，</span><br><span class="line">没办法确保从服务器确实收到了要写入的数据，所以还是有一定的数据丢失的可能性。</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这一特性的工作原理如下：</span><br><span class="line">1）从服务器每秒钟&#96;&#96;ping&#96;&#96;一次主服务器，确认处理的复制流数量。</span><br><span class="line">2）主服务器记住每个从服务器最近一次&#96;&#96;ping&#96;&#96;的时间。</span><br><span class="line">3）用户可以配置最少要有N个服务器有小于M秒的确认延迟。</span><br><span class="line">4）如果有N个以上从服务器，并且确认延迟小于M秒，主服务器接受写操作。</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">还可以把这看做是CAP原则（一致性，可用性，分区容错性）不严格的一致性实现，虽然不能百分百确保一致性，但至少保证了丢失的数据不会超过M秒内的数据量。</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果条件不满足，主服务器会拒绝写操作并返回一个错误。</span><br><span class="line">1）min-slaves-to-write（最小从服务器数）</span><br><span class="line">2）min-slaves-max-lag（从服务器最大确认延迟）</span><br></pre></td></tr></table></figure>



<p>**通过redis实现服务器崩溃等数据恢复  **</p>
<p>由于redis存储在内存中且提供一般编程语言常用的数据结构存储类型，所以经常被用于做服务器崩溃宕机的数据恢复处理。服务器可以在某些指定过程中将需要保存的数据以json对象等方式存储到redis中，也就是我们常说的快照，当服务器运行时读取redis来判断是否有待需要恢复数据继续处理的业务。当一次业务处理结束后再删除redis的数据即可。<strong>redis提供两种将内存数据导出到硬盘实现数据备份的方法</strong>：</p>
<p><strong>1）RDB方式(默认)</strong><br>RDB方式的持久化是通过快照（snapshotting）完成的，当符合一定条件时Redis会自动将内存中的所有数据进行快照并存储在硬盘上。进行快照的条件可以由用户在配置文件中自定义，由两个参数构成：时间和改动的键的个数。当在指定的时间内被更改的键的个数大于指定的数值时就会进行快照。RDB是redis默认采用的持久化方式，在配置文件中已经预置了3个条件：<br>save 900 1      #900秒内有至少1个键被更改则进行快照<br>save 300 10     #300秒内有至少10个键被更改则进行快照<br>save 60 10000   #60秒内有至少10000个键被更改则进行快照</p>
<p>可以存在多个条件，条件之间是”或”的关系，只要满足其中一个条件，就会进行快照。 如果想要禁用自动快照，只需要将所有的save参数删除即可。<br>Redis默认会将快照文件存储在当前目录(可CONFIG GET dir来查看)的dump.rdb文件中，可以通过配置dir和dbfilename两个参数分别指定快照文件的存储路径和文件名。</p>
<p>Redis实现快照的过程<br>-  Redis使用fork函数复制一份当前进程（父进程）的副本（子进程）；<br>-  父进程继续接收并处理客户端发来的命令，而子进程开始将内存中的数据写入硬盘中的临时文件；<br>-  当子进程写入完所有数据后会用该临时文件替换旧的RDB文件，至此一次快照操作完成。<br>-  在执行fork的时候操作系统（类Unix操作系统）会使用写时复制（copy-on-write）策略，即fork函数发生的一刻父子进程共享同一内存数据，当父进程要更改其中某片数据时（如执行一个写命令 ），操作系统会将该片数据复制一份以保证子进程的数据不受影响，所以新的RDB文件存储的是执行fork一刻的内存数据。</p>
<p>Redis在进行快照的过程中不会修改RDB文件，只有快照结束后才会将旧的文件替换成新的，也就是说任何时候RDB文件都是完整的。这使得我们可以通过定时备份RDB文件来实 现Redis数据库备份。RDB文件是经过压缩（可以配置rdbcompression参数以禁用压缩节省CPU占用）的二进制格式，所以占用的空间会小于内存中的数据大小，更加利于传输。</p>
<p>除了自动快照，还可以手动发送SAVE或BGSAVE命令让Redis执行快照，两个命令的区别在于，<strong>前者是由主进程进行快照操作，会阻塞住其他请求，后者会通过fork子进程进行快照操作。</strong> Redis启动后会读取RDB快照文件，将数据从硬盘载入到内存。根据数据量大小与结构和服务器性能不同，这个时间也不同。通常将一个记录一千万个字符串类型键、大小为1GB的快照文件载入到内 存中需要花费20～30秒钟。 通过RDB方式实现持久化，一旦Redis异常退出，就会丢失最后一次快照以后更改的所有数据。这就需要开发者根据具体的应用场合，通过组合设置自动快照条件的方式来将可能发生的数据损失控制在能够接受的范围。如果数据很重要以至于无法承受任何损失，则可以考虑使用AOF方式进行持久化。</p>
<p><strong>2）AOF方式</strong><br>默认情况下Redis没有开启AOF(append only file)方式的持久化，可以在redis.conf中通过appendonly参数开启：</p>
<p>appendonly yes<br>在启动时Redis会逐个执行AOF文件中的命令来将硬盘中的数据载入到内存中，载入的速度相较RDB会慢一些</p>
<p>开启AOF持久化后每执行一条会更改Redis中的数据的命令，Redis就会将该命令写入硬盘中的AOF文件。AOF文件的保存位置和RDB文件的位置相同，都是通过dir参数设置的，默认的文件名是appendonly.aof，可以通过appendfilename参数修改：</p>
<p>appendfilename appendonly.aof<br>配置redis自动重写AOF文件的条件</p>
<p>auto-aof-rewrite-percentage 100  # 当目前的AOF文件大小超过上一次重写时的AOF文件大小的百分之多少时会再次进行重写，如果之前没有重写过，则以启动时的AOF文件大小为依据</p>
<p>auto-aof-rewrite-min-size 64mb   # 允许重写的最小AOF文件大小<br>配置写入AOF文件后，要求系统刷新硬盘缓存的机制</p>
<p># appendfsync always   # 每次执行写入都会执行同步，最安全也最慢<br>appendfsync everysec   # 每秒执行一次同步操作</p>
<p># appendfsync no       # 不主动进行同步操作，而是完全交由操作系统来做（即每30秒一次），最快也最不安全</p>
<p>Redis允许同时开启AOF和RDB，既保证了数据安全又使得进行备份等操作十分容易。此时重新启动Redis后Redis会使用AOF文件来恢复数据，因为AOF方式的持久化可能丢失的数据更少</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/Redis%E9%9B%86%E7%BE%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/Redis%E9%9B%86%E7%BE%A4/" class="post-title-link" itemprop="url">Redis集群</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-08 11:28:53 / 修改时间：11:32:38" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h1><p>redis集群有三种集群模式，分别是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">* 主从模式</span><br><span class="line"></span><br><span class="line">* Sentinel模式</span><br><span class="line"></span><br><span class="line">* Cluster模式</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="主从模式"><a href="#主从模式" class="headerlink" title="主从模式"></a>主从模式</h3><h4 id="主从模式介绍"><a href="#主从模式介绍" class="headerlink" title="主从模式介绍"></a>主从模式介绍</h4><p>主从模式是三种模式中最简单的，在主从复制中，数据库分为两类：主数据库(master)和从数据库(slave)。</p>
<p>其中主从复制有如下特点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">* 主数据库可以进行读写操作，当读写操作导致数据变化时会自动将数据同步给从数据库</span><br><span class="line"></span><br><span class="line">* 从数据库一般都是只读的，并且接收主数据库同步过来的数据</span><br><span class="line"></span><br><span class="line">* 一个master可以拥有多个slave，但是一个slave只能对应一个master</span><br><span class="line"></span><br><span class="line">* slave挂了不影响其他slave的读和master的读和写，重新启动后会将数据从master同步过来</span><br><span class="line"></span><br><span class="line">* master挂了以后，不影响slave的读，但redis不再提供写服务，master重启后redis将重新对外提供写服务</span><br><span class="line"></span><br><span class="line">* master挂了以后，不会在slave节点中重新选一个master</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>工作机制：</p>
<p>当slave启动后，主动向master发送SYNC命令。master接收到SYNC命令后在后台保存快照（RDB持久化）和缓存保存快照这段时间的命令，然后将保存的快照文件和缓存的命令发送给slave。slave接收到快照文件和命令后加载快照文件和缓存的执行命令。</p>
<p>复制初始化后，master每次接收到的写命令都会同步发送给slave，保证主从数据一致性。</p>
<p>安全设置：</p>
<p>当master节点设置密码后，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">客户端访问master需要密码</span><br><span class="line"></span><br><span class="line">启动slave需要密码，在配置文件中配置即可</span><br><span class="line"></span><br><span class="line">客户端访问slave不需要密码</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>缺点：</p>
<p>从上面可以看出，master节点在主从模式中唯一，若master挂掉，则redis无法对外提供写服务。</p>
<h4 id="主从模式搭建"><a href="#主从模式搭建" class="headerlink" title="主从模式搭建"></a>主从模式搭建</h4><ul>
<li>环境准备：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">master节点                  192.168.30.128</span><br><span class="line"></span><br><span class="line">slave节点                   192.168.30.129</span><br><span class="line"></span><br><span class="line">slave节点                   192.168.30.130</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>修改配置：</p>
<p>192.168.30.128</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;redis</span><br><span class="line"></span><br><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.conf</span><br><span class="line"></span><br><span class="line">bind 192.168.30.128               #监听ip，多个ip用空格分隔</span><br><span class="line">daemonize yes               #允许后台启动</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.log&quot;                #日志路径</span><br><span class="line">dir &#x2F;data&#x2F;redis                 #数据库备份文件存放目录</span><br><span class="line">masterauth 123456               #slave连接master密码，master可省略</span><br><span class="line">requirepass 123456              #设置master连接密码，slave可省略</span><br><span class="line"></span><br><span class="line">appendonly yes                  #在&#x2F;data&#x2F;redis&#x2F;目录生成appendonly.aof文件，将每一次写操作请求都追加到appendonly.aof 文件中</span><br><span class="line"></span><br><span class="line"># echo &#39;vm.overcommit_memory&#x3D;1&#39; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line"># sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>192.168.30.129</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;redis</span><br><span class="line"></span><br><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.conf</span><br><span class="line"></span><br><span class="line">bind 192.168.30.129</span><br><span class="line">daemonize yes</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line">replicaof 192.168.30.128 6379</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line"># echo &#39;vm.overcommit_memory&#x3D;1&#39; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line"># sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>192.168.30.130</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># mkdir -p &#x2F;data&#x2F;redis</span><br><span class="line"></span><br><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.conf</span><br><span class="line"></span><br><span class="line">bind 192.168.30.130</span><br><span class="line">daemonize yes</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis.log&quot;</span><br><span class="line">dir &#x2F;data&#x2F;redis</span><br><span class="line">replicaof 192.168.30.128 6379</span><br><span class="line">masterauth 123456</span><br><span class="line">requirepass 123456</span><br><span class="line">appendonly yes</span><br><span class="line"></span><br><span class="line"># echo &#39;vm.overcommit_memory&#x3D;1&#39; &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br><span class="line"></span><br><span class="line"># sysctl -p</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在master节点写入的数据，很快就同步到slave节点上，而且在slave节点上无法写入数据。</p>
<h3 id="Sentinel模式"><a href="#Sentinel模式" class="headerlink" title="Sentinel模式"></a>Sentinel模式</h3><h4 id="Sentinel模式介绍"><a href="#Sentinel模式介绍" class="headerlink" title="Sentinel模式介绍"></a>Sentinel模式介绍</h4><p>主从模式的弊端就是不具备高可用性，当master挂掉以后，Redis将不能再对外提供写入操作，因此sentinel应运而生。</p>
<p>sentinel中文含义为哨兵，顾名思义，它的作用就是监控redis集群的运行状况，特点如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">* sentinel模式是建立在主从模式的基础上，如果只有一个Redis节点，sentinel就没有任何意义</span><br><span class="line"></span><br><span class="line">* 当master挂了以后，sentinel会在slave中选择一个做为master，并修改它们的配置文件，其他slave的配置文件也会被修改，比如slaveof属性会指向新的master</span><br><span class="line"></span><br><span class="line">* 当master重新启动后，它将不再是master而是做为slave接收新的master的同步数据</span><br><span class="line"></span><br><span class="line">* sentinel因为也是一个进程有挂掉的可能，所以sentinel也会启动多个形成一个sentinel集群</span><br><span class="line"></span><br><span class="line">* 多sentinel配置的时候，sentinel之间也会自动监控</span><br><span class="line"></span><br><span class="line">* 当主从模式配置密码时，sentinel也会同步将配置信息修改到配置文件中，不需要担心</span><br><span class="line"></span><br><span class="line">* 一个sentinel或sentinel集群可以管理多个主从Redis，多个sentinel也可以监控同一个redis</span><br><span class="line"></span><br><span class="line">* sentinel最好不要和Redis部署在同一台机器，不然Redis的服务器挂了以后，sentinel也挂了</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>工作机制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">* 每个sentinel以每秒钟一次的频率向它所知的master，slave以及其他sentinel实例发送一个 PING 命令 </span><br><span class="line"></span><br><span class="line">* 如果一个实例距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 则这个实例会被sentinel标记为主观下线。 </span><br><span class="line"></span><br><span class="line">* 如果一个master被标记为主观下线，则正在监视这个master的所有sentinel要以每秒一次的频率确认master的确进入了主观下线状态</span><br><span class="line"></span><br><span class="line">* 当有足够数量的sentinel（大于等于配置文件指定的值）在指定的时间范围内确认master的确进入了主观下线状态， 则master会被标记为客观下线 </span><br><span class="line"></span><br><span class="line">* 在一般情况下， 每个sentinel会以每 10 秒一次的频率向它已知的所有master，slave发送 INFO 命令 </span><br><span class="line"></span><br><span class="line">* 当master被sentinel标记为客观下线时，sentinel向下线的master的所有slave发送 INFO 命令的频率会从 10 秒一次改为 1 秒一次 </span><br><span class="line"></span><br><span class="line">* 若没有足够数量的sentinel同意master已经下线，master的客观下线状态就会被移除；</span><br><span class="line">  若master重新向sentinel的 PING 命令返回有效回复，master的主观下线状态就会被移除</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当使用sentinel模式的时候，客户端就不要直接连接Redis，而是连接sentinel的ip和port，由sentinel来提供具体的可提供服务的Redis实现，这样当master节点挂掉以后，sentinel就会感知并将新的master节点提供给使用者。</p>
<h4 id="Sentinel模式搭建"><a href="#Sentinel模式搭建" class="headerlink" title="Sentinel模式搭建"></a>Sentinel模式搭建</h4><ul>
<li>环境准备：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">master节点              192.168.30.128          sentinel端口：26379</span><br><span class="line"></span><br><span class="line">slave节点               192.168.30.129          sentinel端口：26379</span><br><span class="line"></span><br><span class="line">slave节点               192.168.30.130          sentinel端口：26379</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li>修改配置：</li>
</ul>
<p>前面已经下载安装了redis，这里省略，直接修改sentinel配置文件。</p>
<p>192.168.30.128</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># vim &#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.conf</span><br><span class="line"></span><br><span class="line">daemonize yes</span><br><span class="line">logfile &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel.log&quot;</span><br><span class="line">dir &quot;&#x2F;usr&#x2F;local&#x2F;redis&#x2F;sentinel&quot;                 #sentinel工作目录</span><br><span class="line">sentinel monitor mymaster 192.168.30.128 6379 2                 #判断master失效至少需要2个sentinel同意，建议设置为n&#x2F;2+1，n为sentinel个数</span><br><span class="line">sentinel auth-pass mymaster 123456</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000                 #判断master主观下线时间，默认30s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里需要注意，<code>sentinel auth-pass mymaster 123456</code>需要配置在<code>sentinel monitor mymaster 192.168.30.128 6379 2</code>下面，否则启动报错：</p>
<p>Sentinel模式下的几个事件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">·       +reset-master ：主服务器已被重置。</span><br><span class="line"></span><br><span class="line">·       +slave ：一个新的从服务器已经被 Sentinel 识别并关联。</span><br><span class="line"></span><br><span class="line">·       +failover-state-reconf-slaves ：故障转移状态切换到了 reconf-slaves 状态。</span><br><span class="line"></span><br><span class="line">·       +failover-detected ：另一个 Sentinel 开始了一次故障转移操作，或者一个从服务器转换成了主服务器。</span><br><span class="line"></span><br><span class="line">·       +slave-reconf-sent ：领头（leader）的 Sentinel 向实例发送了 [SLAVEOF](&#x2F;commands&#x2F;slaveof.html) 命令，为实例设置新的主服务器。</span><br><span class="line"></span><br><span class="line">·       +slave-reconf-inprog ：实例正在将自己设置为指定主服务器的从服务器，但相应的同步过程仍未完成。</span><br><span class="line"></span><br><span class="line">·       +slave-reconf-done ：从服务器已经成功完成对新主服务器的同步。</span><br><span class="line"></span><br><span class="line">·       -dup-sentinel ：对给定主服务器进行监视的一个或多个 Sentinel 已经因为重复出现而被移除 —— 当 Sentinel 实例重启的时候，就会出现这种情况。</span><br><span class="line"></span><br><span class="line">·       +sentinel ：一个监视给定主服务器的新 Sentinel 已经被识别并添加。</span><br><span class="line"></span><br><span class="line">·       +sdown ：给定的实例现在处于主观下线状态。</span><br><span class="line"></span><br><span class="line">·       -sdown ：给定的实例已经不再处于主观下线状态。</span><br><span class="line"></span><br><span class="line">·       +odown ：给定的实例现在处于客观下线状态。</span><br><span class="line"></span><br><span class="line">·       -odown ：给定的实例已经不再处于客观下线状态。</span><br><span class="line"></span><br><span class="line">·       +new-epoch ：当前的纪元（epoch）已经被更新。</span><br><span class="line"></span><br><span class="line">·       +try-failover ：一个新的故障迁移操作正在执行中，等待被大多数 Sentinel 选中（waiting to be elected by the majority）。</span><br><span class="line"></span><br><span class="line">·       +elected-leader ：赢得指定纪元的选举，可以进行故障迁移操作了。</span><br><span class="line"></span><br><span class="line">·       +failover-state-select-slave ：故障转移操作现在处于 select-slave 状态 —— Sentinel 正在寻找可以升级为主服务器的从服务器。</span><br><span class="line"></span><br><span class="line">·       no-good-slave ：Sentinel 操作未能找到适合进行升级的从服务器。Sentinel 会在一段时间之后再次尝试寻找合适的从服务器来进行升级，又或者直接放弃执行故障转移操作。</span><br><span class="line"></span><br><span class="line">·       selected-slave ：Sentinel 顺利找到适合进行升级的从服务器。</span><br><span class="line"></span><br><span class="line">·       failover-state-send-slaveof-noone ：Sentinel 正在将指定的从服务器升级为主服务器，等待升级功能完成。</span><br><span class="line"></span><br><span class="line">·       failover-end-for-timeout ：故障转移因为超时而中止，不过最终所有从服务器都会开始复制新的主服务器（slaves will eventually be configured to replicate with the new master anyway）。</span><br><span class="line"></span><br><span class="line">·       failover-end ：故障转移操作顺利完成。所有从服务器都开始复制新的主服务器了。</span><br><span class="line"></span><br><span class="line">·       +switch-master ：配置变更，主服务器的 IP 和地址已经改变。 这是绝大多数外部用户都关心的信息。</span><br><span class="line"></span><br><span class="line">·       +tilt ：进入 tilt 模式。</span><br><span class="line"></span><br><span class="line">·       -tilt ：退出 tilt 模式。</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Cluster模式"><a href="#Cluster模式" class="headerlink" title="Cluster模式"></a>Cluster模式</h3><h4 id="Cluster模式介绍"><a href="#Cluster模式介绍" class="headerlink" title="Cluster模式介绍"></a>Cluster模式介绍</h4><p>sentinel模式基本可以满足一般生产的需求，具备高可用性。但是当数据量过大到一台服务器存放不下的情况时，主从模式或sentinel模式就不能满足需求了，这个时候需要对存储的数据进行分片，将数据存储到多个Redis实例中。cluster模式的出现就是为了解决单机Redis容量有限的问题，将Redis的数据根据一定的规则分配到多台机器。</p>
<p>cluster可以说是sentinel和主从模式的结合体，通过cluster可以实现主从和master重选功能，所以如果配置两个副本三个分片的话，就需要六个Redis实例。因为Redis的数据是根据一定规则分配到cluster的不同机器的，当数据量过大时，可以新增机器进行扩容。</p>
<p>使用集群，只需要将redis配置文件中的<code>cluster-enable</code>配置打开即可。每个集群中至少需要三个主数据库才能正常运行，新增节点非常方便。</p>
<p>cluster集群特点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">* 多个redis节点网络互联，数据共享</span><br><span class="line"></span><br><span class="line">* 所有的节点都是一主一从（也可以是一主多从），其中从不提供服务，仅作为备用</span><br><span class="line"></span><br><span class="line">* 不支持同时处理多个key（如MSET&#x2F;MGET），因为redis需要把key均匀分布在各个节点上，</span><br><span class="line">  并发量很高的情况下同时创建key-value会降低性能并导致不可预测的行为</span><br><span class="line">  </span><br><span class="line">* 支持在线增加、删除节点</span><br><span class="line"></span><br><span class="line">* 客户端可以连接任何一个主节点进行读写</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Cluster模式搭建"><a href="#Cluster模式搭建" class="headerlink" title="Cluster模式搭建"></a>Cluster模式搭建</h4><ul>
<li><p>环境准备：</p>
</li>
<li><pre><code>三台机器，分别开启两个redis服务（端口）

192.168.30.128              端口：7001,7002

192.168.30.129              端口：7003,7004

192.168.30.130              端口：7005,7006

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  - 修改配置文件：</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">192.168.30.128</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</code></pre>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="vim-usr-local-redis-cluster-redis-7001-conf"><a href="#vim-usr-local-redis-cluster-redis-7001-conf" class="headerlink" title="vim /usr/local/redis/cluster/redis_7001.conf"></a>vim /usr/local/redis/cluster/redis_7001.conf</h1><p>bind 192.168.30.128<br>port 7001<br>daemonize yes<br>pidfile “/var/run/redis_7001.pid”<br>logfile “/usr/local/redis/cluster/redis_7001.log”<br>dir “/data/redis/cluster/redis_7001”<br>#replicaof 192.168.30.129 6379<br>masterauth 123456<br>requirepass 123456<br>appendonly yes<br>cluster-enabled yes<br>cluster-config-file nodes_7001.conf<br>cluster-node-timeout 15000</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="vim-usr-local-redis-cluster-redis-7002-conf"><a href="#vim-usr-local-redis-cluster-redis-7002-conf" class="headerlink" title="vim /usr/local/redis/cluster/redis_7002.conf"></a>vim /usr/local/redis/cluster/redis_7002.conf</h1><p>bind 192.168.30.128<br>port 7002<br>daemonize yes<br>pidfile “/var/run/redis_7002.pid”<br>logfile “/usr/local/redis/cluster/redis_7002.log”<br>dir “/data/redis/cluster/redis_7002”<br>#replicaof 192.168.30.129 6379<br>masterauth “123456”<br>requirepass “123456”<br>appendonly yes<br>cluster-enabled yes<br>cluster-config-file nodes_7002.conf<br>cluster-node-timeout 15000</p>
<pre><code></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/Redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/nanchenkunkun.github.io/images/1.jpg">
      <meta itemprop="name" content="zkk">
      <meta itemprop="description" content="只有变光,才能变强">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kkの博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/nanchenkunkun.github.io/2020/09/08/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/Redis%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">redis的数据结构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-09-08 11:28:53 / 修改时间：11:32:26" itemprop="dateCreated datePublished" datetime="2020-09-08T11:28:53+08:00">2020-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/" itemprop="url" rel="index"><span itemprop="name">中间件</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/nanchenkunkun.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="redis的数据结构"><a href="#redis的数据结构" class="headerlink" title="redis的数据结构"></a>redis的数据结构</h3><p><strong>String</strong>、<strong>Hash</strong>、<strong>List</strong>、<strong>Set</strong>、<strong>SortedSet</strong>。</p>
<p>但是，如果你是Redis中高级用户，而且你要在这次面试中突出你和其他候选人的不同，还需要加上下面几种数据结构<strong>HyperLogLog、Geo、Pub/Sub</strong>。</p>
<p>如果你还想加分，那你说还玩过<strong>Redis Module</strong>，像<strong>BloomFilter，RedisSearch，Redis-ML，</strong></p>
<h3 id="如果有大量的key需要设置同一时间过期，一般需要注意什么？"><a href="#如果有大量的key需要设置同一时间过期，一般需要注意什么？" class="headerlink" title="如果有大量的key需要设置同一时间过期，一般需要注意什么？"></a>如果有大量的key需要设置同一时间过期，一般需要注意什么？</h3><p>如果大量的key过期时间设置的过于集中，到过期的那个时间点，<strong>Redis</strong>可能会出现短暂的卡顿现象。严重的话会出现缓存雪崩，我们一般需要在时间上加一个随机值，使得过期时间分散一些。</p>
<p><strong>电商首页经常会使用定时任务刷新缓存，可能大量的数据失效时间都十分集中，如果失效时间一样，又刚好在失效的时间点大量用户涌入，就有可能造成缓存雪崩</strong></p>
<h3 id="那你使用过Redis分布式锁么，它是什么回事？"><a href="#那你使用过Redis分布式锁么，它是什么回事？" class="headerlink" title="那你使用过Redis分布式锁么，它是什么回事？"></a>那你使用过Redis分布式锁么，它是什么回事？</h3><p>先拿<strong>setnx</strong>来争抢锁，抢到之后，再用<strong>expire</strong>给锁加一个过期时间防止锁忘记了释放。</p>
<h3 id="如果在setnx之后执行expire之前进程意外crash或者要重启维护了，那会怎么样？"><a href="#如果在setnx之后执行expire之前进程意外crash或者要重启维护了，那会怎么样？" class="headerlink" title="如果在setnx之后执行expire之前进程意外crash或者要重启维护了，那会怎么样？"></a>如果在setnx之后执行expire之前进程意外crash或者要重启维护了，那会怎么样？</h3><p>set指令有非常复杂的参数，这个应该是可以同时把<strong>setnx</strong>和<strong>expire</strong>合成一条指令来用的！</p>
<h3 id="假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如何将它们全部找出来？"><a href="#假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如何将它们全部找出来？" class="headerlink" title="假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如何将它们全部找出来？"></a>假如Redis里面有1亿个key，其中有10w个key是以某个固定的已知的前缀开头的，如何将它们全部找出来？</h3><p>使用<strong>keys</strong>指令可以扫出指定模式的key列表。</p>
<h3 id="如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？"><a href="#如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？" class="headerlink" title="如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？"></a>如果这个redis正在给线上的业务提供服务，那使用keys指令会有什么问题？</h3><p>Redis的单线程的。keys指令会导致线程阻塞一段时间，线上服务会停顿，直到指令执行完毕，服务才能恢复。这个时候可以使用<strong>scan</strong>指令，<strong>scan</strong>指令可以无阻塞的提取出指定模式的key列表，但是会有一定的重复概率，在客户端做一次去重就可以了，但是整体所花费的时间会比直接用keys指令长。</p>
<p><strong>不过，增量式迭代命令也不是没有缺点的：举个例子， 使用 SMEMBERS 命令可以返回集合键当前包含的所有元素， 但是对于 SCAN 这类增量式迭代命令来说， 因为在对键进行增量式迭代的过程中， 键可能会被修改， 所以增量式迭代命令只能对被返回的元素提供有限的保证 。</strong></p>
<h3 id="使用过Redis做异步队列么，怎么用的？"><a href="#使用过Redis做异步队列么，怎么用的？" class="headerlink" title="使用过Redis做异步队列么，怎么用的？"></a>使用过Redis做异步队列么，怎么用的？</h3><p>一般使用list结构作为队列，<strong>rpush</strong>生产消息，<strong>lpop</strong>消费消息。当lpop没有消息的时候，要适当sleep一会再重试。</p>
<h3 id="Redis如何实现延时队列"><a href="#Redis如何实现延时队列" class="headerlink" title="Redis如何实现延时队列"></a>Redis如何实现延时队列</h3><p>使用sortedset，拿时间戳作为score，消息内容作为key调用zadd来生产消息，消费者用<strong>zrangebyscore</strong>指令获取N秒之前的数据轮询进行处理。</p>
<h3 id="Redis是怎么持久化的？服务主从数据怎么交互的？"><a href="#Redis是怎么持久化的？服务主从数据怎么交互的？" class="headerlink" title="Redis是怎么持久化的？服务主从数据怎么交互的？"></a>Redis是怎么持久化的？服务主从数据怎么交互的？</h3><p>RDB做镜像全量持久化，AOF做增量持久化。因为RDB会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要AOF来配合使用。在redis实例重启时，会使用RDB持久化文件重新构建内存，再使用AOF重放近期的操作指令来实现完整恢复重启之前的状态。</p>
<p><strong>这里很好理解，把RDB理解为一整个表全量的数据，AOF理解为每次操作的日志就好了，服务器重启的时候先把表的数据全部搞进去，但是他可能不完整，你再回放一下日志，数据不就完整了嘛。不过Redis本身的机制是 AOF持久化开启且存在AOF文件时，优先加载AOF文件；AOF关闭或者AOF文件不存在时，加载RDB文件；加载AOF/RDB文件城后，Redis启动成功；AOF/RDB文件存在错误时，Redis启动失败并打印错误信息</strong></p>
<h3 id="RDB的原理是什么"><a href="#RDB的原理是什么" class="headerlink" title="RDB的原理是什么"></a>RDB的原理是什么</h3><p>你给出两个词汇就可以了，fork和cow。fork是指redis通过创建子进程来进行RDB操作，cow指的是<strong>copy on write</strong>，子进程创建后，父子进程共享数据段，父进程继续提供读写服务，写脏的页面数据会逐渐和子进程分离开来。</p>
<h3 id="Pipeline有什么好处，为什么要用pipeline？"><a href="#Pipeline有什么好处，为什么要用pipeline？" class="headerlink" title="Pipeline有什么好处，为什么要用pipeline？"></a>Pipeline有什么好处，为什么要用pipeline？</h3><p>可以将多次IO往返的时间缩减为一次，前提是<strong>pipeline</strong>执行的指令之间没有因果相关性。使用<strong>redis-benchmark</strong>进行压测的时候可以发现影响redis的QPS峰值的一个重要因素是<strong>pipeline</strong>批次指令的数目。</p>
<h3 id="Redis的同步机制"><a href="#Redis的同步机制" class="headerlink" title="Redis的同步机制"></a>Redis的同步机制</h3><p>Redis可以使用主从同步，从从同步。第一次同步时，主节点做一次<strong>bgsave</strong>，并同时将后续修改操作记录到内存buffer，待完成后将RDB文件全量同步到复制节点，复制节点接受完成后将RDB镜像加载到内存。加载完成后，再通知主节点将期间修改的操作记录同步到复制节点进行重放就完成了同步过程。后续的增量数据通过AOF日志同步即可，有点类似数据库的binlog。</p>
<h3 id="Redis集群，集群的高可用怎么保证，集群的原理是什么？"><a href="#Redis集群，集群的高可用怎么保证，集群的原理是什么？" class="headerlink" title="Redis集群，集群的高可用怎么保证，集群的原理是什么？"></a>Redis集群，集群的高可用怎么保证，集群的原理是什么？</h3><p><strong>Redis Sentinal</strong> 着眼于高可用，在master宕机时会自动将slave提升为master，继续提供服务。</p>
<p><strong>Redis Cluster</strong> 着眼于扩展性，在单个redis内存不足时，使用Cluster进行分片存储。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/nanchenkunkun.github.io/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/nanchenkunkun.github.io/page/4/">4</a><a class="extend next" rel="next" href="/nanchenkunkun.github.io/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zkk"
      src="/nanchenkunkun.github.io/images/1.jpg">
  <p class="site-author-name" itemprop="name">zkk</p>
  <div class="site-description" itemprop="description">只有变光,才能变强</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/nanchenkunkun.github.io/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/nanchenkunkun.github.io/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/nanchenkunkun.github.io/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zkk</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/nanchenkunkun.github.io/lib/anime.min.js"></script>
  <script src="/nanchenkunkun.github.io/lib/velocity/velocity.min.js"></script>
  <script src="/nanchenkunkun.github.io/lib/velocity/velocity.ui.min.js"></script>

<script src="/nanchenkunkun.github.io/js/utils.js"></script>

<script src="/nanchenkunkun.github.io/js/motion.js"></script>


<script src="/nanchenkunkun.github.io/js/schemes/pisces.js"></script>


<script src="/nanchenkunkun.github.io/js/next-boot.js"></script>




  















  

  

</body>
</html>
